<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSL Expense Management - v2.2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-teal: #0f5132;
            --accent-teal: #20c997;
            --text-dark: #212529;
            --text-gray: #6c757d;
            --border-light: #dee2e6;
            --bg-light: #f8f9fa;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 140px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* STICKY HEADER - Only show in Create Voucher tab */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            display: none; /* Hidden by default */
        }
        
        .sticky-header.show-header {
            display: block;
        }
        
        .sticky-header-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .voucher-info-bar {
            background: linear-gradient(135deg, var(--primary-teal), var(--accent-teal));
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: center;
        }
        
        .voucher-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .voucher-field label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .voucher-field input {
            padding: 10px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: rgba(255,255,255,0.95);
            color: var(--text-dark);
        }
        
        .voucher-field input:focus {
            outline: none;
            border-color: white;
            background: white;
        }
        
        .header {
            background: var(--primary-teal);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 24px; font-weight: 600; }
        .header .fy { font-size: 14px; opacity: 0.9; }
        
        .tabs {
            display: flex;
            background: var(--bg-light);
            border-bottom: 2px solid var(--border-light);
            overflow-x: auto;
        }
        
        .tab {
            padding: 16px 28px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-gray);
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab:hover { background: white; color: var(--primary-teal); }
        .tab.active { background: white; color: var(--primary-teal); border-bottom: 3px solid var(--primary-teal); }
        
        .tab-content { display: none; padding: 32px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section {
            background: var(--bg-light);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }
        
        .form-section.hidden-step {
            display: none;
        }
        
        .form-section.greyed-step {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .form-section h3 {
            font-size: 18px;
            color: var(--primary-teal);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
        }
        
        .form-group label.required::after {
            content: " *";
            color: var(--danger);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 0 3px rgba(15,81,50,0.1);
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary { background: var(--primary-teal); color: white; }
        .btn-primary:hover { background: #0a3622; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15,81,50,0.3); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--text-gray); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: var(--text-dark); }
        
        .next-step-btn {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .alert-warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; }
        .alert-danger { background: #f8d7da; border: 1px solid #dc3545; color: #721c24; }
        .alert-info { background: #d1ecf1; border: 1px solid #0c5460; color: #0c5460; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-teal);
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        .amount-breakdown {
            background: var(--bg-light);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .amount-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .amount-row.total {
            border-top: 2px solid var(--primary-teal);
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-teal);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .hidden { display: none !important; }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .table-container { overflow-x: auto; margin-top: 24px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        table th {
            background: var(--primary-teal);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
        }
        table tr:hover { background: var(--bg-light); }
        table tr.clickable { cursor: pointer; }
        table tr.clickable:hover { background: #e3f2fd; }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-prepared { background: #e3f2fd; color: #1565c0; }
        .badge-viewed { background: #f3e5f5; color: #6a1b9a; }
        .badge-edited { background: #fff3e0; color: #e65100; }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary-teal), var(--accent-teal));
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card .label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .collapsible-section {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: var(--bg-light);
            padding: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary-teal);
        }
        
        .collapsible-header:hover {
            background: #e9ecef;
        }
        
        .collapsible-content {
            padding: 16px;
            display: none;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .tree-view {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .tree-view li {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .tree-view .tree-node {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .tree-view .tree-node:hover {
            background: var(--bg-light);
        }
        
        .tree-view .tree-children {
            display: none;
            padding-left: 20px;
        }
        
        .tree-view .tree-children.expanded {
            display: block;
        }
        
        .vendor-count {
            color: var(--primary-teal);
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .vendor-count:hover {
            color: var(--accent-teal);
        }
        
        .popup-tooltip {
            position: absolute;
            background: white;
            border: 2px solid var(--primary-teal);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1500;
            max-width: 300px;
        }
        
        .popup-tooltip ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .btn-save-reason {
            background: var(--warning);
            color: var(--text-dark);
            margin-top: 12px;
        }
        
        .cheque-summary-row {
            background: #e3f2fd !important;
            font-weight: 600;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- STICKY HEADER - Only visible in Create Voucher -->
    <div class="sticky-header" id="stickyHeader">
        <div class="sticky-header-content">
            <div class="voucher-info-bar">
                <div class="voucher-field">
                    <label>Voucher Date</label>
                    <input type="date" id="stickyVoucherDate" onchange="updateStickyDate()">
                </div>
                <div class="voucher-field">
                    <label>Voucher Number</label>
                    <input type="text" id="stickyVoucherNumber" placeholder="MMM-XXX" readonly>
                </div>
                <div class="voucher-field" style="justify-content: center;">
                    <div style="font-size: 24px;">üìã</div>
                    <div style="font-size: 11px; opacity: 0.9;">Create Voucher</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <div>
                <h1>Sanjog Co-operative Housing Society Ltd</h1>
                <div class="fy">Financial Year: 2025-2026</div>
            </div>
            <div>
                <div style="text-align: right; font-size: 13px; opacity: 0.9;">
                    Committee Strength: 7
                </div>
                <div style="text-align: right; font-size: 12px; opacity: 0.8; margin-top: 4px;">
                    MVP v2.2
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('create-voucher')">‚ûï Create Voucher</button>
            <button class="tab" onclick="switchTab('view-vouchers')">üìã View Vouchers</button>
            <button class="tab" onclick="switchTab('reports')">üìà Reports</button>
            <button class="tab" onclick="switchTab('master-data')">üìö Master Data</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
            <h2 style="margin-bottom: 24px; color: var(--primary-teal);">Dashboard</h2>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="label">Total Vouchers</div>
                    <div class="value" id="stat-total-vouchers">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Amount</div>
                    <div class="value" id="stat-total-amount">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <div class="label">This Month</div>
                    <div class="value" id="stat-month-vouchers">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">Active Vendors</div>
                    <div class="value">9</div>
                </div>
            </div>
        </div>
        
        <!-- Create Voucher Tab -->
        <div id="tab-create-voucher" class="tab-content">
            <h2 style="margin-bottom: 24px; color: var(--primary-teal);">Create New Expense Voucher</h2>
            
            <form id="voucherForm">
                <!-- STEP 1: Vendor Type -->
                <div class="form-section" id="step1" data-step="1">
                    <h3>üìã STEP 1: Vendor Type</h3>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="vendorType" value="Registered" checked onchange="onVendorTypeChange()">
                            <span>Registered Vendor</span>
                        </label>
                        <label>
                            <input type="radio" name="vendorType" value="One-Time" onchange="onVendorTypeChange()">
                            <span>One-Time Vendor</span>
                        </label>
                    </div>
                    <div class="next-step-btn">
                        <button type="button" class="btn btn-primary" onclick="completeStep(1)">Next Step ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 2: Payment Details -->
                <div class="form-section hidden-step" id="step2" data-step="2">
                    <h3>üí∞ STEP 2: Payment Details</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="paymentMode" class="required">Payment Mode</label>
                            <input type="text" id="paymentMode" value="Cheque" readonly style="background: #f3f4f6;">
                        </div>
                    </div>
                    
                    <div id="chequeDetails" style="margin-top: 16px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="chequeBank" class="required">Select Bank</label>
                                <select id="chequeBank" onchange="onChequeBankChange()">
                                    <option value="">Choose bank...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="chequeBook" class="required">Cheque Book</label>
                                <select id="chequeBook" onchange="assignChequeNumber()">
                                    <option value="">Choose cheque book...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="chequeNumber" class="required">Cheque Number</label>
                                <input type="text" id="chequeNumber" readonly style="background: #f3f4f6;">
                                <small style="color: var(--text-gray); margin-top: 4px;">Auto-assigned</small>
                            </div>
                            <div class="form-group">
                                <label for="chequeDate" class="required">Cheque Date</label>
                                <input type="date" id="chequeDate">
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="chequeCancelled" onchange="onChequeCancelledChange()">
                                <span>Mark this cheque as CANCELLED</span>
                            </label>
                        </div>
                        
                        <div id="chequeCancelReason" class="hidden" style="margin-top: 12px;">
                            <div class="form-group">
                                <label for="cancelReason" class="required">Cancellation Reason</label>
                                <textarea id="cancelReason" rows="2"></textarea>
                            </div>
                            <button type="button" class="btn btn-save-reason" onclick="saveCancellationReason()">üíæ Save Cancellation Reason</button>
                        </div>
                        
                        <div id="reasonSavedNotice" class="alert alert-success hidden" style="margin-top: 12px;">
                            ‚úì Cancellation reason saved. Cheque marked as cancelled and next valid cheque assigned.
                        </div>
                    </div>
                    
                    <div class="next-step-btn">
                        <button type="button" class="btn btn-primary" id="step2NextBtn" onclick="completeStep(2)">Next Step ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 3: Vendor Details -->
                <div class="form-section hidden-step" id="step3" data-step="3">
                    <h3>üè¢ STEP 3: Vendor Details</h3>
                    
                    <div id="registeredVendorSection">
                        <div class="form-group">
                            <label for="vendorSelect" class="required">Select Vendor</label>
                            <select id="vendorSelect" onchange="onVendorChange()">
                                <option value="">Choose vendor...</option>
                            </select>
                        </div>
                        
                        <div id="vendorInfo" class="hidden" style="margin-top: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--border-light);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                                <div><strong>PAN:</strong> <span id="v-pan">-</span></div>
                                <div><strong>Contact:</strong> <span id="v-contact">-</span></div>
                                <div><strong>TDS Rate:</strong> <span id="v-tds">-</span>%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="oneTimeVendorSection" class="hidden">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="oneTimeVendorName" class="required">Vendor Name</label>
                                <input type="text" id="oneTimeVendorName" minlength="3">
                            </div>
                            <div class="form-group">
                                <label for="oneTimeVendorContact" class="required">Contact Number</label>
                                <input type="text" id="oneTimeVendorContact" maxlength="10" pattern="[6-9][0-9]{9}">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label for="oneTimeVendorAddress" class="required">Address</label>
                            <textarea id="oneTimeVendorAddress" rows="5" maxlength="250"></textarea>
                            <small style="color: var(--text-gray); margin-top: 4px;"><span id="addressCharCount">0</span>/250</small>
                        </div>
                    </div>
                    
                    <div class="next-step-btn">
                        <button type="button" class="btn btn-primary" onclick="completeStep(3)">Next Step ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 4: Expense Category -->
                <div class="form-section hidden-step" id="step4" data-step="4">
                    <h3>üìÇ STEP 4: Expense Category</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="categoryL1" class="required">Major Expense Head (Level 1)</label>
                            <select id="categoryL1" onchange="onCategoryL1Change()">
                                <option value="">Select major head...</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="categoryL2Group">
                            <label for="categoryL2" class="required">Minor Expense Head (Level 2)</label>
                            <select id="categoryL2" onchange="onCategoryL2Change()">
                                <option value="">Select minor head...</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="categoryL3Group">
                            <label for="categoryL3">Why Spent (Level 3)</label>
                            <div id="categoryL3Container"></div>
                        </div>
                        <div class="form-group hidden" id="categoryL4Group">
                            <label for="categoryL4">Spent For (Level 4)</label>
                            <div id="categoryL4Container"></div>
                        </div>
                    </div>
                    
                    <div id="categoryPath" class="hidden" style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-size: 13px; color: var(--text-gray);">
                        <strong>Category Path:</strong> <span id="categoryPathText">-</span>
                    </div>
                    
                    <div class="next-step-btn">
                        <button type="button" class="btn btn-primary" onclick="completeStep(4)">Next Step ‚Üí</button>
                    </div>
                </div>
                
                <!-- STEP 5: Invoice Details -->
                <div class="form-section hidden-step" id="step5" data-step="5">
                    <h3>üìÑ STEP 5: Invoice Details</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="invoiceAmount" class="required">Invoice Amount (‚Çπ)</label>
                            <input type="number" id="invoiceAmount" min="1" step="1" onchange="calculateAmounts()" onblur="roundAmount()">
                        </div>
                        <div class="form-group">
                            <label for="invoiceNumber" class="required">Invoice Number</label>
                            <input type="text" id="invoiceNumber" minlength="3">
                        </div>
                    </div>
                    
                    <div id="tdsGstSection">
                        <div class="form-grid" style="margin-top: 16px;">
                            <div class="form-group">
                                <label>TDS Amount (‚Çπ)</label>
                                <input type="text" id="tdsAmount" readonly style="background: #f3f4f6;">
                            </div>
                            <div class="form-group">
                                <label>GST Amount (‚Çπ)</label>
                                <input type="text" id="gstAmount" readonly style="background: #f3f4f6;">
                            </div>
                        </div>
                        
                        <div class="amount-breakdown">
                            <div class="amount-row">
                                <span>Invoice Amount:</span>
                                <span id="breakdown-invoice">‚Çπ0</span>
                            </div>
                            <div class="amount-row">
                                <span>Less: TDS (<span id="breakdown-tds-rate">0</span>%):</span>
                                <span id="breakdown-tds">‚Çπ0</span>
                            </div>
                            <div class="amount-row">
                                <span>Add: GST (<span id="breakdown-gst-rate">0</span>%):</span>
                                <span id="breakdown-gst">‚Çπ0</span>
                            </div>
                            <div class="amount-row total">
                                <span>Net Payment Amount:</span>
                                <span id="breakdown-net">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 16px;">
                        <label for="description">Description / Remarks</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" onclick="resetVoucherForm()">Reset Form</button>
                        <button type="button" class="btn btn-primary" onclick="saveVoucher()">üíæ Save Voucher</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- View Vouchers Tab -->
        <div id="tab-view-vouchers" class="tab-content">
            <h2 style="margin-bottom: 24px; color: var(--primary-teal);">View & Manage Vouchers</h2>
            
            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="voucherSearch" placeholder="üîç Search..." onkeyup="renderVouchers()" style="padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; flex: 1; min-width: 200px;">
                <button class="btn btn-success" onclick="exportVouchersToExcel()">üì• Export</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Voucher No.</th>
                            <th>Vendor</th>
                            <th>Type</th>
                            <th>Payment</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vouchersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-gray);">No vouchers yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="tab-reports" class="tab-content">
            <h2 style="margin-bottom: 24px; color: var(--primary-teal);">Reports & Analytics</h2>
            
            <div class="form-section">
                <h3>üìä Date-Wise Report</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>From Date</label>
                        <input type="date" id="reportFromDate">
                    </div>
                    <div class="form-group">
                        <label>To Date</label>
                        <input type="date" id="reportToDate">
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top: 12px;" onclick="generateDateWiseReport()">Generate</button>
                <div id="dateWiseReport"></div>
            </div>
            
            <div class="form-section">
                <h3>üìÇ Category-Wise Report</h3>
                <button class="btn btn-primary" onclick="generateCategoryReport()">Generate</button>
                <div id="categoryReport"></div>
            </div>
            
            <div class="form-section">
                <h3>üè¶ Cheque Book Utilization Report</h3>
                <button class="btn btn-primary" onclick="generateChequeUtilizationReport()">Generate</button>
                <div id="chequeUtilizationReport"></div>
            </div>
        </div>
        
        <!-- Master Data Tab -->
        <div id="tab-master-data" class="tab-content">
            <h2 style="margin-bottom: 24px; color: var(--primary-teal);">Master Data Reference</h2>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <span>üè¶ Bank Master</span>
                    <span>‚ñº</span>
                </div>
                <div class="collapsible-content" id="bankMasterContent"></div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <span>üìï Cheque Book Master</span>
                    <span>‚ñº</span>
                </div>
                <div class="collapsible-content" id="chequeBookMasterContent"></div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <span>üè¢ Vendor Master</span>
                    <span>‚ñº</span>
                </div>
                <div class="collapsible-content" id="vendorMasterContent"></div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection(this)">
                    <span>üìÇ Expense Category Master</span>
                    <span>‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="showCategoryView('table')">üìã Table View</button>
                        <button class="btn btn-secondary" onclick="showCategoryView('tree')">üå≥ Tree View</button>
                        <button class="btn btn-secondary" onclick="showCategoryView('grouped')">üìÅ Grouped View</button>
                    </div>
                    <div id="categoryMasterContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="confirmModalTitle">Confirm</div>
            <div id="confirmModalMessage" style="white-space: pre-line;"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="btn btn-primary" id="confirmModalBtn" onclick="closeConfirmModal(true)">OK</button>
            </div>
        </div>
    </div>
    
    <div id="viewVoucherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Voucher Details</div>
            <div id="voucherDetailsContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewVoucherModal()">Close</button>
                <button class="btn btn-primary" id="editVoucherBtn" onclick="openEditModal()">Edit</button>
                <button class="btn btn-danger" onclick="openCancelModal()">Cancel Voucher</button>
            </div>
        </div>
    </div>
    
    <div id="editVoucherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Edit Voucher</div>
            <div class="alert alert-warning">
                <strong>‚ö†Ô∏è Limited Editing:</strong> You can edit Category, Invoice Amount, Invoice Number, Description, and Cheque Details. Other fields are locked. You can only edit once.
            </div>
            <div id="editVoucherContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveVoucherEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="cancelVoucherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="color: var(--danger);">Cancel Voucher</div>
            <div id="cancelVoucherContent"></div>
            <div class="form-group" style="margin-top: 16px;">
                <label class="required">Cancellation Reason</label>
                <textarea id="voucherCancelReason" rows="3" placeholder="Why are you cancelling this voucher?" required></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCancelModal()">Close</button>
                <button class="btn btn-danger" onclick="confirmCancelVoucher()">Confirm Cancellation</button>
            </div>
        </div>
    </div>
    
    <div id="chequeDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Cheque Book Details</div>
            <div id="chequeDetailContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChequeDetailModal()">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Master Data Embedded - v2.2 with all fixes
        
const MASTER_DATA = {"vendors":{"Adani":{"name":"Adani","pan":"ADANI1234T","gstNumber":"","contact":"8814392236","email":"any@one.com","tdsRate":0,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Electricity Charges","level2":"None","level3":"None","level4":"None","gstRate":0}]},"BMC":{"name":"BMC","pan":"BMCPT1234R","gstNumber":"","contact":"8217877142","email":"any@one.com","tdsRate":0,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Property Tax for Parking & Common Areas","level2":"None","level3":"None","level4":"None","gstRate":0},{"level1":"BMC Water Charges","level2":"None","level3":"None","level4":"None","gstRate":0}]},"Tank":{"name":"Tank","pan":"PAPUE5632Q","gstNumber":"27PAPUE5632Q1WE","contact":"8470475616","email":"any@one.com","tdsRate":2,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Water Charges - Tanker","level2":"None","level3":"None","level4":"None","gstRate":5}]},"Adhya":{"name":"Adhya","pan":"ADHYA7894Q","gstNumber":"22ADHYA7894Q5UT","contact":"8472583662","email":"any@one.com","tdsRate":2,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Security Charges","level2":"None","level3":"None","level4":"None","gstRate":18},{"level1":"Housekeeping Charges","level2":"Monthly Contract","level3":"None","level4":"None","gstRate":18},{"level1":"Housekeeping Charges","level2":"Supplies","level3":"None","level4":"None","gstRate":18}]},"Tanaji":{"name":"Tanaji","pan":"TANAJ1452Y","gstNumber":"11TANAJ1452Y3ER","contact":"8471698276","email":"any@one.com","tdsRate":2,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Passenger Lift (AMC)","level2":"Contractual","level3":"None","level4":"None","gstRate":18},{"level1":"Passenger Lift (AMC)","level2":"Parts","level3":"None","level4":"None","gstRate":18}]},"Infinite":{"name":"Infinite","pan":"INFIN5846W","gstNumber":"15INFIN5846W6DF","contact":"8471700869","email":"any@one.com","tdsRate":10,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Accounting & Managerial Charges","level2":"Monthly Contract","level3":"None","level4":"None","gstRate":18},{"level1":"Accounting & Managerial Charges","level2":"Supplies","level3":"None","level4":"None","gstRate":18},{"level1":"Accounting & Managerial Charges","level2":"Work Specific","level3":"User Entry","level4":"User Entry","gstRate":18}]},"Darji":{"name":"Darji","pan":"DARJI3245R","gstNumber":"","contact":"8471701106","email":"any@one.com","tdsRate":0,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Salaries","level2":"Gym Trainer","level3":"None","level4":"None","gstRate":0},{"level1":"Salaries","level2":"others","level3":"User Entry","level4":"User Entry","gstRate":0}]},"Sometest Contractors":{"name":"Sometest Contractors","pan":"XYZAB5678C","gstNumber":"27XYZAB5678C1Z1","contact":"7895716540","email":"Some@test.com","tdsRate":2,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"others","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Water Pump","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"DG Set","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Electrical","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Civil","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Plumbing","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"General","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Drainage/Sewage","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Lift","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Gym Room","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Yoga Room","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Society Office","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"others","level4":"User Entry","gstRate":5}]},"Anyone Suppliers":{"name":"Anyone Suppliers","pan":"ABCDE1234F","gstNumber":"22ABCDE1234F1Z1","contact":"9380716540","email":"any@one.com","tdsRate":10,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"others","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"others","level4":"User Entry","gstRate":18}]}},"categoryTree":{"level1":["Accounting & Managerial Charges","BMC Water Charges","Electricity Charges","Housekeeping Charges","Passenger Lift (AMC)","Property Tax for Parking & Common Areas","Repairs & Maintenance","Salaries","Security Charges","Water Charges - Tanker"],"level2":{"Housekeeping Charges":["Monthly Contract","Supplies"],"Passenger Lift (AMC)":["Contractual","Parts"],"Accounting & Managerial Charges":["Monthly Contract","Supplies","Work Specific"],"Salaries":["Gym Trainer","others"],"Repairs & Maintenance":["AMC Expenses","Parts","Servicing","others"]},"level3":{"Accounting & Managerial Charges|Work Specific":["User Entry"],"Salaries|others":["User Entry"],"Repairs & Maintenance|AMC Expenses":["Civil","DG Set","Drainage/Sewage","Electrical","General","Gym Room","Lift","Plumbing","Society Office","Water Pump","Yoga Room","others"],"Repairs & Maintenance|Parts":["Civil","DG Set","Drainage/Sewage","Electrical","General","Gym Room","Lift","Plumbing","Society Office","Water Pump","Yoga Room","others"],"Repairs & Maintenance|Servicing":["Civil","DG Set","Drainage/Sewage","Electrical","General","Gym Room","Lift","Plumbing","Society Office","Water Pump","Yoga Room","others"],"Repairs & Maintenance|others":["Civil","DG Set","Drainage/Sewage","Electrical","General","Gym Room","Lift","Plumbing","Society Office","Water Pump","Yoga Room","others"]},"level4":{"Accounting & Managerial Charges|Work Specific|User Entry":["User Entry"],"Salaries|others|User Entry":["User Entry"],"Repairs & Maintenance|AMC Expenses|Water Pump":["User Entry"],"Repairs & Maintenance|AMC Expenses|DG Set":["User Entry"],"Repairs & Maintenance|AMC Expenses|Electrical":["User Entry"],"Repairs & Maintenance|AMC Expenses|Civil":["User Entry"],"Repairs & Maintenance|AMC Expenses|Plumbing":["User Entry"],"Repairs & Maintenance|AMC Expenses|General":["User Entry"],"Repairs & Maintenance|AMC Expenses|Drainage/Sewage":["User Entry"],"Repairs & Maintenance|AMC Expenses|Lift":["User Entry"],"Repairs & Maintenance|AMC Expenses|Gym Room":["User Entry"],"Repairs & Maintenance|AMC Expenses|Yoga Room":["User Entry"],"Repairs & Maintenance|AMC Expenses|Society Office":["User Entry"],"Repairs & Maintenance|AMC Expenses|others":["User Entry"],"Repairs & Maintenance|Parts|Water Pump":["User Entry"],"Repairs & Maintenance|Parts|DG Set":["User Entry"],"Repairs & Maintenance|Parts|Electrical":["User Entry"],"Repairs & Maintenance|Parts|Civil":["User Entry"],"Repairs & Maintenance|Parts|Plumbing":["User Entry"],"Repairs & Maintenance|Parts|General":["User Entry"],"Repairs & Maintenance|Parts|Drainage/Sewage":["User Entry"],"Repairs & Maintenance|Parts|Lift":["User Entry"],"Repairs & Maintenance|Parts|Gym Room":["User Entry"],"Repairs & Maintenance|Parts|Yoga Room":["User Entry"],"Repairs & Maintenance|Parts|Society Office":["User Entry"],"Repairs & Maintenance|Parts|others":["User Entry"],"Repairs & Maintenance|Servicing|Water Pump":["User Entry"],"Repairs & Maintenance|Servicing|DG Set":["User Entry"],"Repairs & Maintenance|Servicing|Electrical":["User Entry"],"Repairs & Maintenance|Servicing|Civil":["User Entry"],"Repairs & Maintenance|Servicing|Plumbing":["User Entry"],"Repairs & Maintenance|Servicing|General":["User Entry"],"Repairs & Maintenance|Servicing|Drainage/Sewage":["User Entry"],"Repairs & Maintenance|Servicing|Lift":["User Entry"],"Repairs & Maintenance|Servicing|Gym Room":["User Entry"],"Repairs & Maintenance|Servicing|Yoga Room":["User Entry"],"Repairs & Maintenance|Servicing|Society Office":["User Entry"],"Repairs & Maintenance|Servicing|others":["User Entry"],"Repairs & Maintenance|others|Water Pump":["User Entry"],"Repairs & Maintenance|others|DG Set":["User Entry"],"Repairs & Maintenance|others|Electrical":["User Entry"],"Repairs & Maintenance|others|Civil":["User Entry"],"Repairs & Maintenance|others|Plumbing":["User Entry"],"Repairs & Maintenance|others|General":["User Entry"],"Repairs & Maintenance|others|Drainage/Sewage":["User Entry"],"Repairs & Maintenance|others|Lift":["User Entry"],"Repairs & Maintenance|others|Gym Room":["User Entry"],"Repairs & Maintenance|others|Yoga Room":["User Entry"],"Repairs & Maintenance|others|Society Office":["User Entry"],"Repairs & Maintenance|others|others":["User Entry"]}},"banks":[{"name":"Bharat Cooperative Bank","accountNumber":"1234567890","ifscCode":"BCOP0000001"},{"name":"FJKL Pvt Bank","accountNumber":"8323364321","ifscCode":"FJKL0000321"}],"chequeBooks":[{"bankName":"Bharat Cooperative Bank","startNumber":"000051","totalLeaves":25,"endNumber":"000075","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"Bharat Cooperative Bank","startNumber":"000106","totalLeaves":50,"endNumber":"000155","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"Bharat Cooperative Bank","startNumber":"000281","totalLeaves":100,"endNumber":"000380","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"Bharat Cooperative Bank","startNumber":"000001","totalLeaves":50,"endNumber":"000050","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"FJKL Pvt Bank","startNumber":"000076","totalLeaves":100,"endNumber":"000175","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"FJKL Pvt Bank","startNumber":"000151","totalLeaves":25,"endNumber":"000175","usedCheques":[],"cancelledCheques":[],"status":"Active"},{"bankName":"FJKL Pvt Bank","startNumber":"000426","totalLeaves":10,"endNumber":"000435","usedCheques":[],"cancelledCheques":[],"status":"Active"}],"config":{"societyName":"Sanjog Co-operative Housing Society Ltd","mcStrength":7,"financialYear":"2025-2026"},"mcMembers":[{"designation":"Secretary","firstName":"Sec","lastName":"Retary","contact":"93652147830","email":"Sec@retary.com","status":"Active"},{"designation":"Jt Secretary","firstName":"JtSe","lastName":"Creta","contact":"83652147932","email":"JtSe@creta.com","status":"Active"},{"designation":"Treasurer","firstName":"Trea","lastName":"Surer","contact":"75653257830","email":"Trea@surer.com","status":"Active"},{"designation":"Chairperson","firstName":"Chair","lastName":"Person","contact":"98564147830","email":"Chair@person.com","status":"Active"},{"designation":"MC Member","firstName":"Mc11","lastName":"Memb","contact":"86523147830","email":"Mc11@memb.com","status":"Active"},{"designation":"MC Member","firstName":"Mc22","lastName":"22Memb","contact":"75658657830","email":"Mc22@22memb.com","status":"Active"},{"designation":"MC Member","firstName":"Mc33","lastName":"33Mber","contact":"81652149650","email":"Mc33@33mber.com","status":"Active"}]};        
        // Global State
        let vouchers = [];
        let currentViewVoucher = null;
        let currentEditVoucher = null;
        let currentVendorData = null;
        let currentCategoryGST = 0;
        let confirmCallback = null;
        let chequeCancellationCounter = 0;
        let cancellationReasonSaved = false;
        let currentStep = 1;
        const STORAGE_KEY = "chsl_vouchers_v22";
        const CURRENT_USER = "Admin";
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadVouchers();
            initializeForm();
            setTodayDate();
            populateBanks();
            updateDashboard();
            renderVouchers();
            populateMasterData();
            showCategoryView('table');
        });
        
        function initializeForm() {
            onVendorTypeChange();
            document.getElementById('oneTimeVendorAddress').addEventListener('input', function() {
                document.getElementById('addressCharCount').textContent = this.value.length;
            });
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stickyVoucherDate').value = today;
            document.getElementById('chequeDate').value = today;
            generateVoucherNumber();
        }
        
        function updateStickyDate() {
            const date = document.getElementById('stickyVoucherDate').value;
            if (date) {
                const vDate = new Date(date);
                const today = new Date();
                today.setHours(0,0,0,0);
                vDate.setHours(0,0,0,0);
                
                // Check if valid calendar date
                if (isNaN(vDate.getTime())) {
                    showError('Invalid date! Please select a valid calendar date.');
                    document.getElementById('stickyVoucherDate').value = today.toISOString().split('T')[0];
                    return;
                }
                
                const minDate = new Date(today);
                minDate.setMonth(today.getMonth() - 1);
                
                if (vDate > today) {
                    showError('Voucher date cannot be in the future!');
                    document.getElementById('stickyVoucherDate').value = today.toISOString().split('T')[0];
                    return;
                } else if (vDate < minDate) {
                    showWarningModal(
                        '‚ö†Ô∏è DATE WARNING',
                        `Voucher date is more than 1 month old.\nThis will be flagged in audit trail. Proceed?`,
                        () => { generateVoucherNumber(); }
                    );
                    return;
                }
                generateVoucherNumber();
            }
        }
        
        function loadVouchers() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                vouchers = JSON.parse(stored);
                // Ensure all vouchers have status
                vouchers.forEach(v => {
                    if (!v.status) v.status = 'Prepared';
                    if (!v.editCount) v.editCount = 0;
                });
            }
        }
        
        function saveVouchers() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(vouchers));
            updateDashboard();
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Show/hide sticky header based on tab
            const stickyHeader = document.getElementById('stickyHeader');
            if (tabName === 'create-voucher') {
                stickyHeader.classList.add('show-header');
            } else {
                stickyHeader.classList.remove('show-header');
            }
            
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'view-vouchers') renderVouchers();
        }
        
        function updateDashboard() {
            const total = vouchers.filter(v => v.status !== 'Cancelled').length;
            const totalAmount = vouchers.filter(v => v.status !== 'Cancelled').reduce((sum, v) => sum + (v.netAmount || 0), 0);
            const thisMonth = vouchers.filter(v => {
                if (v.status === 'Cancelled') return false;
                const vDate = new Date(v.date);
                const now = new Date();
                return vDate.getMonth() === now.getMonth() && vDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('stat-total-vouchers').textContent = total;
            document.getElementById('stat-total-amount').textContent = '‚Çπ' + totalAmount.toLocaleString('en-IN');
            document.getElementById('stat-month-vouchers').textContent = thisMonth;
        }
        
        function generateVoucherNumber() {
            const date = new Date(document.getElementById('stickyVoucherDate').value || new Date());
            const month = date.toLocaleString('en-US', { month: 'short' });
            const monthVouchers = vouchers.filter(v => {
                const vDate = new Date(v.date);
                return vDate.getMonth() === date.getMonth() && vDate.getFullYear() === date.getFullYear();
            });
            const sequence = (monthVouchers.length + 1).toString().padStart(3, '0');
            document.getElementById('stickyVoucherNumber').value = `${month}-${sequence}`;
        }
        
        // Sequential Workflow Functions
        function completeStep(stepNumber) {
            // Validate current step before proceeding
            if (!validateStep(stepNumber)) {
                return;
            }
            
            // Grey out current step
            document.getElementById('step' + stepNumber).classList.add('greyed-step');
            
            // Show next step
            const nextStep = stepNumber + 1;
            if (nextStep <= 5) {
                document.getElementById('step' + nextStep).classList.remove('hidden-step');
                currentStep = nextStep;
            }
        }
        
        function validateStep(stepNumber) {
            switch(stepNumber) {
                case 1:
                    return true; // Vendor type always valid
                case 2:
                    return validateStep2();
                case 3:
                    return validateStep3();
                case 4:
                    return validateStep4();
                case 5:
                    return validateStep5();
                default:
                    return true;
            }
        }
        
        function validateStep2() {
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            if (vendorType === 'One-Time') return true; // Cash, no cheque validation
            
            const bank = document.getElementById('chequeBank').value;
            const book = document.getElementById('chequeBook').value;
            const chequeNum = document.getElementById('chequeNumber').value;
            
            if (!bank || !book || !chequeNum) {
                showError('Please complete all cheque details');
                return false;
            }
            
            const cancelled = document.getElementById('chequeCancelled').checked;
            if (cancelled && !cancellationReasonSaved) {
                showError('Please save the cancellation reason before proceeding');
                return false;
            }
            
            const chequeDate = document.getElementById('chequeDate').value;
            if (!cancelled && !chequeDate) {
                showError('Cheque date is required');
                return false;
            }
            
            return true;
        }
        
        function validateStep3() {
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            if (vendorType === 'Registered') {
                const vendor = document.getElementById('vendorSelect').value;
                if (!vendor) {
                    showError('Please select a vendor');
                    return false;
                }
            } else {
                const name = document.getElementById('oneTimeVendorName').value;
                const contact = document.getElementById('oneTimeVendorContact').value;
                const address = document.getElementById('oneTimeVendorAddress').value;
                
                if (!name || name.length < 3) {
                    showError('Vendor name required (min 3 characters)');
                    return false;
                }
                if (!contact || !/^[6-9][0-9]{9}$/.test(contact)) {
                    showError('Invalid mobile number');
                    return false;
                }
                if (!address || address.length < 10) {
                    showError('Address required (min 10 characters)');
                    return false;
                }
            }
            return true;
        }
        
        function validateStep4() {
            const l1 = document.getElementById('categoryL1').value;
            if (!l1) {
                showError('Please select expense category');
                return false;
            }
            return true;
        }
        
        function validateStep5() {
            return true; // Validation happens in saveVoucher
        }
        
        function onVendorTypeChange() {
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            const paymentMode = document.getElementById('paymentMode');
            const chequeDetails = document.getElementById('chequeDetails');
            const registeredSection = document.getElementById('registeredVendorSection');
            const oneTimeSection = document.getElementById('oneTimeVendorSection');
            const tdsGstSection = document.getElementById('tdsGstSection');
            
            // Reset categories FIRST, before populating
            resetCategorySelections();
            
            chequeCancellationCounter = 0;
            cancellationReasonSaved = false;
            
            if (vendorType === 'Registered') {
                if (!checkChequeAvailability()) {
                    showError('No valid cheques available! Cannot create voucher for Registered Vendor.');
                    document.querySelector('input[name="vendorType"][value="One-Time"]').checked = true;
                    onVendorTypeChange();
                    return;
                }
                
                paymentMode.value = 'Cheque';
                chequeDetails.classList.remove('hidden');
                registeredSection.classList.remove('hidden');
                oneTimeSection.classList.add('hidden');
                tdsGstSection.classList.remove('hidden');
                populateRegisteredVendors();
            } else {
                paymentMode.value = 'Cash';
                chequeDetails.classList.add('hidden');
                registeredSection.classList.add('hidden');
                oneTimeSection.classList.remove('hidden');
                tdsGstSection.classList.add('hidden');
                populateOneTimeCategories();
            }
        }
        
        function checkChequeAvailability() {
            for (const book of MASTER_DATA.chequeBooks) {
                const startNum = parseInt(book.startNumber);
                const endNum = parseInt(book.endNumber);
                const usedNumbers = vouchers
                    .filter(v => v.paymentMode === 'Cheque' && v.chequeBook === `${book.startNumber}-${book.endNumber}`)
                    .map(v => parseInt(v.chequeNumber));
                
                for (let num = startNum; num <= endNum; num++) {
                    if (!usedNumbers.includes(num)) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        function populateRegisteredVendors() {
            const select = document.getElementById('vendorSelect');
            select.innerHTML = '<option value="">Choose vendor...</option>';
            Object.keys(MASTER_DATA.vendors).sort().forEach(vendorName => {
                const option = document.createElement('option');
                option.value = vendorName;
                option.textContent = vendorName;
                select.appendChild(option);
            });
        }
        
        function populateOneTimeCategories() {
            const select = document.getElementById('categoryL1');
            select.innerHTML = '<option value="">Select major head...</option>';
            MASTER_DATA.categoryTree.level1.forEach(l1 => {
                const option = document.createElement('option');
                option.value = l1;
                option.textContent = l1;
                select.appendChild(option);
            });
        }
        
        function onVendorChange() {
            const vendorName = document.getElementById('vendorSelect').value;
            if (!vendorName) {
                document.getElementById('vendorInfo').classList.add('hidden');
                resetCategorySelections();
                return;
            }
            
            currentVendorData = MASTER_DATA.vendors[vendorName];
            document.getElementById('v-pan').textContent = currentVendorData.pan;
            document.getElementById('v-contact').textContent = currentVendorData.contact;
            document.getElementById('v-tds').textContent = currentVendorData.tdsRate;
            document.getElementById('vendorInfo').classList.remove('hidden');
            
            populateVendorCategories();
            calculateAmounts();
        }
        
        function populateVendorCategories() {
            const paths = currentVendorData.allowedPaths;
            const l1Values = [...new Set(paths.map(p => p.level1))];
            
            const select = document.getElementById('categoryL1');
            select.innerHTML = '';
            
            if (l1Values.length === 1) {
                const option = document.createElement('option');
                option.value = l1Values[0];
                option.textContent = l1Values[0];
                option.selected = true;
                select.appendChild(option);
                select.disabled = true;
                onCategoryL1Change();
            } else {
                select.disabled = false;
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select major head...';
                select.appendChild(defaultOption);
                
                l1Values.sort().forEach(l1 => {
                    const option = document.createElement('option');
                    option.value = l1;
                    option.textContent = l1;
                    select.appendChild(option);
                });
            }
        }
        
        function onCategoryL1Change() {
            const l1 = document.getElementById('categoryL1').value;
            const l2Group = document.getElementById('categoryL2Group');
            const l2Select = document.getElementById('categoryL2');
            
            document.getElementById('categoryL2').value = '';
            document.getElementById('categoryL3Group').classList.add('hidden');
            document.getElementById('categoryL4Group').classList.add('hidden');
            
            if (!l1) {
                l2Group.classList.add('hidden');
                document.getElementById('categoryPath').classList.add('hidden');
                return;
            }
            
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            let paths;
            
            if (vendorType === 'Registered') {
                paths = currentVendorData.allowedPaths.filter(p => p.level1 === l1);
            } else {
                paths = getAllCategoryPaths().filter(p => p.level1 === l1);
            }
            
            const l2Values = [...new Set(paths.map(p => p.level2))].filter(v => v !== 'None');
            
            if (l2Values.length === 0) {
                l2Group.classList.add('hidden');
                document.getElementById('categoryPath').classList.remove('hidden');
                document.getElementById('categoryPathText').textContent = l1;
                updateCategoryGST();
                return;
            }
            
            l2Select.innerHTML = '<option value="">Select minor head...</option>';
            l2Values.sort().forEach(l2 => {
                const option = document.createElement('option');
                option.value = l2;
                option.textContent = l2;
                l2Select.appendChild(option);
            });
            l2Group.classList.remove('hidden');
            document.getElementById('categoryPath').classList.remove('hidden');
            document.getElementById('categoryPathText').textContent = l1;
        }
        
        function onCategoryL2Change() {
            const l1 = document.getElementById('categoryL1').value;
            const l2 = document.getElementById('categoryL2').value;
            const l3Group = document.getElementById('categoryL3Group');
            
            document.getElementById('categoryL3Group').classList.add('hidden');
            document.getElementById('categoryL4Group').classList.add('hidden');
            
            if (!l2) {
                document.getElementById('categoryPathText').textContent = l1;
                return;
            }
            
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            let paths;
            
            if (vendorType === 'Registered') {
                paths = currentVendorData.allowedPaths.filter(p => p.level1 === l1 && p.level2 === l2);
            } else {
                paths = getAllCategoryPaths().filter(p => p.level1 === l1 && p.level2 === l2);
            }
            
            const l3Values = [...new Set(paths.map(p => p.level3))].filter(v => v !== 'None');
            
            if (l3Values.length === 0) {
                l3Group.classList.add('hidden');
                document.getElementById('categoryPathText').textContent = `${l1} ‚Üí ${l2}`;
                updateCategoryGST();
                return;
            }
            
            // Check if only "User Entry" option
            if (l3Values.length === 1 && l3Values[0] === 'User Entry') {
                // Show text input instead of dropdown
                const container = document.getElementById('categoryL3Container');
                container.innerHTML = '<input type="text" id="categoryL3Input" class="form-control" placeholder="Enter Details..." style="padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 14px;">';
                document.getElementById('categoryL3Input').addEventListener('change', onCategoryL3InputChange);
            } else {
                // Show dropdown
                const container = document.getElementById('categoryL3Container');
                container.innerHTML = '<select id="categoryL3Select" class="form-control" onchange="onCategoryL3Change()" style="padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 14px;"><option value="">Select...</option></select>';
                const select = document.getElementById('categoryL3Select');
                l3Values.sort().forEach(l3 => {
                    const option = document.createElement('option');
                    option.value = l3;
                    option.textContent = l3;
                    select.appendChild(option);
                });
            }
            
            l3Group.classList.remove('hidden');
            document.getElementById('categoryPathText').textContent = `${l1} ‚Üí ${l2}`;
        }
        
        function onCategoryL3InputChange() {
            const l1 = document.getElementById('categoryL1').value;
            const l2 = document.getElementById('categoryL2').value;
            const l3 = document.getElementById('categoryL3Input').value;
            
            if (l3) {
                document.getElementById('categoryPathText').textContent = `${l1} ‚Üí ${l2} ‚Üí ${l3}`;
                
                // Check if L4 is also User Entry
                showL4UserEntryIfNeeded(l1, l2, 'User Entry');
            }
            updateCategoryGST();
        }
        
        function onCategoryL3Change() {
            const l1 = document.getElementById('categoryL1').value;
            const l2 = document.getElementById('categoryL2').value;
            const l3Select = document.getElementById('categoryL3Select');
            const l3 = l3Select ? l3Select.value : '';
            const l4Group = document.getElementById('categoryL4Group');
            
            document.getElementById('categoryL4Group').classList.add('hidden');
            
            if (!l3) {
                document.getElementById('categoryPathText').textContent = `${l1} ‚Üí ${l2}`;
                return;
            }
            
            document.getElementById('categoryPathText').textContent = `${l1} ‚Üí ${l2} ‚Üí ${l3}`;
            
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            let paths;
            
            if (vendorType === 'Registered') {
                paths = currentVendorData.allowedPaths.filter(p => p.level1 === l1 && p.level2 === l2 && p.level3 === l3);
            } else {
                paths = getAllCategoryPaths().filter(p => p.level1 === l1 && p.level2 === l2 && p.level3 === l3);
            }
            
            const l4Values = [...new Set(paths.map(p => p.level4))].filter(v => v !== 'None');
            
            if (l4Values.length === 1 && l4Values[0] === 'User Entry') {
                const container = document.getElementById('categoryL4Container');
                container.innerHTML = '<input type="text" id="categoryL4Input" class="form-control" placeholder="Enter Details..." style="padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 14px;">';
                l4Group.classList.remove('hidden');
            } else if (l4Values.length > 0) {
                l4Group.classList.add('hidden');
            }
            
            updateCategoryGST();
        }
        
        function showL4UserEntryIfNeeded(l1, l2, l3) {
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            let paths;
            
            if (vendorType === 'Registered') {
                paths = currentVendorData.allowedPaths.filter(p => p.level1 === l1 && p.level2 === l2 && p.level3 === l3);
            } else {
                paths = getAllCategoryPaths().filter(p => p.level1 === l1 && p.level2 === l2 && p.level3 === l3);
            }
            
            const l4Values = [...new Set(paths.map(p => p.level4))].filter(v => v !== 'None');
            
            if (l4Values.length === 1 && l4Values[0] === 'User Entry') {
                const l4Group = document.getElementById('categoryL4Group');
                const container = document.getElementById('categoryL4Container');
                container.innerHTML = '<input type="text" id="categoryL4Input" class="form-control" placeholder="Enter Details..." style="padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 14px;">';
                l4Group.classList.remove('hidden');
            }
        }
        
        function getAllCategoryPaths() {
            const paths = [];
            Object.values(MASTER_DATA.vendors).forEach(vendor => {
                paths.push(...vendor.allowedPaths);
            });
            return paths;
        }
        
        function updateCategoryGST() {
            const l1 = document.getElementById('categoryL1').value;
            const l2 = document.getElementById('categoryL2').value || 'None';
            
            // Get L3 value from either input or select
            let l3 = 'None';
            const l3Input = document.getElementById('categoryL3Input');
            const l3Select = document.getElementById('categoryL3Select');
            if (l3Input && l3Input.value) {
                l3 = 'User Entry'; // For GST lookup
            } else if (l3Select && l3Select.value) {
                l3 = l3Select.value;
            }
            
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            
            if (vendorType === 'One-Time') {
                currentCategoryGST = 0;
                calculateAmounts();
                return;
            }
            
            const path = currentVendorData.allowedPaths.find(p => 
                p.level1 === l1 && p.level2 === l2 && (p.level3 === l3 || (l3 === 'None' && p.level3 === 'None'))
            );
            
            currentCategoryGST = path ? path.gstRate : 0;
            calculateAmounts();
        }
        
        function resetCategorySelections() {
            document.getElementById('categoryL1').innerHTML = '<option value="">Select major head...</option>';
            document.getElementById('categoryL1').disabled = false;
            document.getElementById('categoryL2').innerHTML = '<option value="">Select minor head...</option>';
            document.getElementById('categoryL2Group').classList.add('hidden');
            document.getElementById('categoryL3Group').classList.add('hidden');
            document.getElementById('categoryL4Group').classList.add('hidden');
            document.getElementById('categoryPath').classList.add('hidden');
        }
        
        function populateBanks() {
            const select = document.getElementById('chequeBank');
            MASTER_DATA.banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.name;
                option.textContent = bank.name;
                select.appendChild(option);
            });
        }
        
        function onChequeBankChange() {
            const bankName = document.getElementById('chequeBank').value;
            const bookSelect = document.getElementById('chequeBook');
            bookSelect.innerHTML = '<option value="">Choose cheque book...</option>';
            
            if (!bankName) {
                document.getElementById('chequeNumber').value = '';
                return;
            }
            
            const books = MASTER_DATA.chequeBooks.filter(b => b.bankName === bankName);
            books.forEach(book => {
                const option = document.createElement('option');
                option.value = JSON.stringify(book);
                option.textContent = `${book.startNumber} - ${book.endNumber} (${book.totalLeaves} leaves)`;
                bookSelect.appendChild(option);
            });
        }
        
        function assignChequeNumber() {
            const bookJson = document.getElementById('chequeBook').value;
            if (!bookJson) {
                document.getElementById('chequeNumber').value = '';
                return;
            }
            
            const book = JSON.parse(bookJson);
            const startNum = parseInt(book.startNumber);
            const endNum = parseInt(book.endNumber);
            
            const usedNumbers = vouchers
                .filter(v => v.paymentMode === 'Cheque' && v.chequeBook === `${book.startNumber}-${book.endNumber}`)
                .map(v => parseInt(v.chequeNumber));
            
            // Also check cancelled cheques from localStorage
            const cancelledList = JSON.parse(localStorage.getItem('cancelled_cheques_v221') || '[]');
            const cancelledNumbers = cancelledList
                .filter(c => c.chequeBook === `${book.startNumber}-${book.endNumber}`)
                .map(c => parseInt(c.chequeNumber));
            
            // Combine used and cancelled
            const unavailableNumbers = [...usedNumbers, ...cancelledNumbers];
            
            let nextNum = startNum;
            while (nextNum <= endNum) {
                if (!unavailableNumbers.includes(nextNum)) {
                    document.getElementById('chequeNumber').value = nextNum.toString().padStart(6, '0');
                    return;
                }
                nextNum++;
            }
            
            showError('Cheque book exhausted. Please select another book.');
            document.getElementById('chequeNumber').value = '';
        }
        
        function onChequeCancelledChange() {
            const cancelled = document.getElementById('chequeCancelled').checked;
            const reasonSection = document.getElementById('chequeCancelReason');
            const reasonSaved = document.getElementById('reasonSavedNotice');
            
            if (cancelled) {
                reasonSection.classList.remove('hidden');
                reasonSaved.classList.add('hidden');
                cancellationReasonSaved = false;
            } else {
                reasonSection.classList.add('hidden');
                reasonSaved.classList.add('hidden');
                cancellationReasonSaved = false;
            }
        }
        
        function saveCancellationReason() {
            const reason = document.getElementById('cancelReason').value.trim();
            if (!reason) {
                showError('Please enter a cancellation reason');
                return;
            }
            
            chequeCancellationCounter++;
            
            if (chequeCancellationCounter === 2) {
                showWarningModal(
                    '‚ö†Ô∏è CONSECUTIVE CANCELLATION WARNING',
                    'You have cancelled 2 cheques for this voucher.\nThis will be flagged in audit trail. Proceed?',
                    () => {
                        completeCancellation();
                    }
                );
            } else if (chequeCancellationCounter >= 3) {
                showError('Cannot cancel more than 2 cheques. This voucher must be cancelled entirely.');
                // Force cancel entire voucher
                showWarningModal(
                    '‚ùå FORCE VOUCHER CANCELLATION',
                    'More than 2 cheques cancelled.\nReason: Part of Audit Trail\n\nThis voucher will be cancelled. Please start a new voucher.',
                    () => {
                        resetVoucherForm();
                    }
                );
                return;
            } else {
                completeCancellation();
            }
        }
        
        function completeCancellation() {
            cancellationReasonSaved = true;
            document.getElementById('reasonSavedNotice').classList.remove('hidden');
            
            // Mark current cheque as cancelled
            const currentCheque = document.getElementById('chequeNumber').value;
            const bookJson = document.getElementById('chequeBook').value;
            const reason = document.getElementById('cancelReason').value;
            
            // Track cancelled cheque in localStorage
            if (bookJson) {
                const book = JSON.parse(bookJson);
                const cancelled = JSON.parse(localStorage.getItem('cancelled_cheques_v221') || '[]');
                cancelled.push({
                    chequeNumber: currentCheque,
                    chequeBook: `${book.startNumber}-${book.endNumber}`,
                    bankName: book.bankName,
                    reason: reason,
                    date: new Date().toISOString()
                });
                localStorage.setItem('cancelled_cheques_v221', JSON.stringify(cancelled));
            }
            
            // Assign next valid cheque
            assignChequeNumber();
            
            // Disable and uncheck cancellation checkbox (irreversible)
            document.getElementById('chequeCancelled').disabled = true;
            document.getElementById('chequeCancelled').checked = false;
        }
        
        function calculateAmounts() {
            const invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            
            if (vendorType === 'One-Time') {
                document.getElementById('breakdown-invoice').textContent = '‚Çπ' + invoiceAmount.toLocaleString('en-IN');
                document.getElementById('breakdown-tds-rate').textContent = 0;
                document.getElementById('breakdown-tds').textContent = '‚Çπ0';
                document.getElementById('breakdown-gst-rate').textContent = 0;
                document.getElementById('breakdown-gst').textContent = '‚Çπ0';
                document.getElementById('breakdown-net').textContent = '‚Çπ' + invoiceAmount.toLocaleString('en-IN');
                return;
            }
            
            const tdsRate = currentVendorData ? currentVendorData.tdsRate : 0;
            const gstRate = currentCategoryGST;
            
            const tdsAmount = Math.round(invoiceAmount * tdsRate / 100);
            const gstAmount = Math.round(invoiceAmount * gstRate / 100);
            const netAmount = invoiceAmount - tdsAmount + gstAmount;
            
            document.getElementById('tdsAmount').value = tdsAmount;
            document.getElementById('gstAmount').value = gstAmount;
            
            document.getElementById('breakdown-invoice').textContent = '‚Çπ' + invoiceAmount.toLocaleString('en-IN');
            document.getElementById('breakdown-tds-rate').textContent = tdsRate;
            document.getElementById('breakdown-tds').textContent = '‚Çπ' + tdsAmount.toLocaleString('en-IN');
            document.getElementById('breakdown-gst-rate').textContent = gstRate;
            document.getElementById('breakdown-gst').textContent = '‚Çπ' + gstAmount.toLocaleString('en-IN');
            document.getElementById('breakdown-net').textContent = '‚Çπ' + netAmount.toLocaleString('en-IN');
        }
        
        function roundAmount() {
            const input = document.getElementById('invoiceAmount');
            if (input.value) {
                input.value = Math.round(parseFloat(input.value));
                calculateAmounts();
            }
        }
        
        function saveVoucher() {
            if (!validateVoucher()) return;
            
            const date = document.getElementById('stickyVoucherDate').value;
            const voucherNumber = document.getElementById('stickyVoucherNumber').value;
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            const invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value);
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const categoryL1 = document.getElementById('categoryL1').value;
            const description = document.getElementById('description').value;
            
            // Get category values
            let categoryL2 = document.getElementById('categoryL2').value || 'None';
            let categoryL3 = 'None';
            let categoryL4 = 'None';
            
            const l3Input = document.getElementById('categoryL3Input');
            const l3Select = document.getElementById('categoryL3Select');
            if (l3Input) {
                categoryL3 = l3Input.value || 'None';
            } else if (l3Select) {
                categoryL3 = l3Select.value || 'None';
            }
            
            const l4Input = document.getElementById('categoryL4Input');
            if (l4Input) {
                categoryL4 = l4Input.value || 'None';
            }
            
            const voucher = {
                id: Date.now(),
                date,
                voucherNumber,
                vendorType,
                categoryL1,
                categoryL2,
                categoryL3,
                categoryL4,
                invoiceAmount,
                invoiceNumber,
                description,
                createdBy: CURRENT_USER,
                createdAt: new Date().toISOString(),
                auditFlags: [],
                status: 'Prepared',
                editCount: 0
            };
            
            if (vendorType === 'Registered') {
                const vendorName = document.getElementById('vendorSelect').value;
                voucher.vendorName = vendorName;
                voucher.vendorPAN = currentVendorData.pan;
                voucher.paymentMode = 'Cheque';
                
                const bank = document.getElementById('chequeBank').value;
                const bookJson = document.getElementById('chequeBook').value;
                const book = JSON.parse(bookJson);
                const chequeNumber = document.getElementById('chequeNumber').value;
                const chequeDate = document.getElementById('chequeDate').value;
                
                voucher.bank = bank;
                voucher.chequeBook = `${book.startNumber}-${book.endNumber}`;
                voucher.chequeNumber = chequeNumber;
                voucher.chequeDate = chequeDate;
                voucher.tdsRate = currentVendorData.tdsRate;
                voucher.tdsAmount = parseFloat(document.getElementById('tdsAmount').value) || 0;
                voucher.gstRate = currentCategoryGST;
                voucher.gstAmount = parseFloat(document.getElementById('gstAmount').value) || 0;
                voucher.netAmount = voucher.invoiceAmount - voucher.tdsAmount + voucher.gstAmount;
            } else {
                const name = document.getElementById('oneTimeVendorName').value;
                const contact = document.getElementById('oneTimeVendorContact').value;
                const address = document.getElementById('oneTimeVendorAddress').value;
                
                voucher.paymentMode = 'Cash';
                voucher.oneTimeVendorName = name;
                voucher.oneTimeVendorContact = contact;
                voucher.oneTimeVendorAddress = address;
                voucher.tdsRate = 0;
                voucher.tdsAmount = 0;
                voucher.gstRate = 0;
                voucher.gstAmount = 0;
                voucher.netAmount = voucher.invoiceAmount;
            }
            
            vouchers.push(voucher);
            saveVouchers();
            showToast('‚úÖ Voucher saved successfully!');
            resetVoucherForm();
        }
        
        function validateVoucher() {
            const voucherNumber = document.getElementById('stickyVoucherNumber').value;
            const invoiceAmount = parseFloat(document.getElementById('invoiceAmount').value);
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const categoryL1 = document.getElementById('categoryL1').value;
            
            if (!voucherNumber || !/^[A-Za-z]{3}-[0-9]{3}$/.test(voucherNumber)) {
                showError('Invalid voucher number format');
                return false;
            }
            
            if (!invoiceAmount || invoiceAmount < 1) {
                showError('Invoice amount must be at least ‚Çπ1');
                return false;
            }
            
            if (!invoiceNumber || invoiceNumber.length < 3) {
                showError('Invoice number required (min 3 characters)');
                return false;
            }
            
            if (!/\d/.test(invoiceNumber)) {
                showError('Invoice number must contain at least one digit');
                return false;
            }
            
            if (!categoryL1) {
                showError('Please select expense category');
                return false;
            }
            
            const vendorType = document.querySelector('input[name="vendorType"]:checked').value;
            
            if (vendorType === 'One-Time' && invoiceAmount > 5000) {
                showError('Cash payment cannot exceed ‚Çπ5,000 per voucher!');
                return false;
            }
            
            return true;
        }
        
        function resetVoucherForm() {
            document.getElementById('voucherForm').reset();
            document.querySelector('input[name="vendorType"][value="Registered"]').checked = true;
            
            // Reset all steps
            for (let i = 2; i <= 5; i++) {
                document.getElementById('step' + i).classList.add('hidden-step');
                document.getElementById('step' + i).classList.remove('greyed-step');
            }
            document.getElementById('step1').classList.remove('greyed-step');
            currentStep = 1;
            
            onVendorTypeChange();
            setTodayDate();
            currentVendorData = null;
            currentCategoryGST = 0;
            chequeCancellationCounter = 0;
            cancellationReasonSaved = false;
            
            document.getElementById('chequeCancelled').disabled = false;
            document.getElementById('vendorInfo').classList.add('hidden');
            document.getElementById('reasonSavedNotice').classList.add('hidden');
            document.getElementById('breakdown-invoice').textContent = '‚Çπ0';
            document.getElementById('breakdown-tds').textContent = '‚Çπ0';
            document.getElementById('breakdown-gst').textContent = '‚Çπ0';
            document.getElementById('breakdown-net').textContent = '‚Çπ0';
        }
        
        function renderVouchers() {
            const tbody = document.getElementById('vouchersTableBody');
            const search = document.getElementById('voucherSearch').value.toLowerCase();
            
            let filtered = vouchers;
            if (search) {
                filtered = vouchers.filter(v => 
                    v.voucherNumber.toLowerCase().includes(search) ||
                    (v.vendorName && v.vendorName.toLowerCase().includes(search)) ||
                    (v.oneTimeVendorName && v.oneTimeVendorName.toLowerCase().includes(search))
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No vouchers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(v => {
                    const vendor = v.vendorType === 'Registered' ? v.vendorName : v.oneTimeVendorName;
                    const statusClass = v.status === 'Cancelled' ? 'danger' : 
                                       v.status === 'Edited' ? 'edited' :
                                       v.status === 'Viewed' ? 'viewed' : 'prepared';
                    return `
                        <tr style="${v.status === 'Cancelled' ? 'opacity: 0.6;' : ''}">
                            <td>${new Date(v.date).toLocaleDateString('en-IN')}</td>
                            <td><strong>${v.voucherNumber}</strong></td>
                            <td>${vendor}</td>
                            <td><span class="badge ${v.vendorType === 'Registered' ? 'badge-success' : 'badge-warning'}">${v.vendorType}</span></td>
                            <td>${v.paymentMode}</td>
                            <td><strong>‚Çπ${v.netAmount.toLocaleString('en-IN')}</strong></td>
                            <td><span class="badge badge-${statusClass}">${v.status}</span></td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="viewVoucherDetails(${v.id})">View</button>
                                    <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="editVoucherDirect(${v.id})" ${v.status === 'Cancelled' || v.editCount >= 1 ? 'disabled' : ''}>Edit</button>
                                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="cancelVoucherDirect(${v.id})" ${v.status === 'Cancelled' ? 'disabled' : ''}>Cancel</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
        }
        
        function viewVoucherDetails(id) {
            currentViewVoucher = vouchers.find(v => v.id === id);
            if (!currentViewVoucher) return;
            
            // Update status to "Viewed" if it was "Prepared"
            if (currentViewVoucher.status === 'Prepared') {
                const index = vouchers.findIndex(v => v.id === id);
                vouchers[index].status = 'Viewed';
                saveVouchers();
                renderVouchers();
            }
            
            const vendor = currentViewVoucher.vendorType === 'Registered' ? currentViewVoucher.vendorName : currentViewVoucher.oneTimeVendorName;
            const categoryPath = [currentViewVoucher.categoryL1, currentViewVoucher.categoryL2, currentViewVoucher.categoryL3, currentViewVoucher.categoryL4]
                .filter(c => c && c !== 'None')
                .join(' ‚Üí ');
            
            let html = `
                <div style="display: grid; gap: 12px; font-size: 14px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Voucher Number:</strong>
                        <span>${currentViewVoucher.voucherNumber}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Date:</strong>
                        <span>${new Date(currentViewVoucher.date).toLocaleDateString('en-IN')}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Status:</strong>
                        <span class="badge badge-${currentViewVoucher.status === 'Cancelled' ? 'danger' : currentViewVoucher.status === 'Edited' ? 'edited' : currentViewVoucher.status === 'Viewed' ? 'viewed' : 'prepared'}">${currentViewVoucher.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Vendor:</strong>
                        <span>${vendor}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Category:</strong>
                        <span>${categoryPath}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Invoice Number:</strong>
                        <span>${currentViewVoucher.invoiceNumber}</span>
                    </div>
            `;
            
            // Add payment details if cheque payment
            if (currentViewVoucher.paymentMode === 'Cheque') {
                html += `
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light);">
                        <strong>Payment Mode:</strong>
                        <span>Cheque</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Bank:</strong>
                        <span>${currentViewVoucher.bank}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Cheque Number:</strong>
                        <span>${currentViewVoucher.chequeNumber}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                        <strong>Cheque Date:</strong>
                        <span>${new Date(currentViewVoucher.chequeDate).toLocaleDateString('en-IN')}</span>
                    </div>
                `;
            }
            
            html += `
                </div>
                
                <div class="amount-breakdown" style="margin-top: 20px;">
                    <div class="amount-row">
                        <span>Invoice Amount:</span>
                        <span>‚Çπ${currentViewVoucher.invoiceAmount.toLocaleString('en-IN')}</span>
                    </div>
            `;
            
            if (currentViewVoucher.paymentMode === 'Cheque') {
                html += `
                    <div class="amount-row">
                        <span>Less: TDS:</span>
                        <span>‚Çπ${currentViewVoucher.tdsAmount.toLocaleString('en-IN')}</span>
                    </div>
                    <div class="amount-row">
                        <span>Add: GST:</span>
                        <span>‚Çπ${currentViewVoucher.gstAmount.toLocaleString('en-IN')}</span>
                    </div>
                `;
            }
            
            html += `
                    <div class="amount-row total">
                        <span>Net Payment Amount:</span>
                        <span>‚Çπ${currentViewVoucher.netAmount.toLocaleString('en-IN')}</span>
                    </div>
                </div>
            `;
            
            if (currentViewVoucher.status === 'Cancelled') {
                html += `
                    <div style="margin-top: 16px; padding: 12px; background: var(--bg-light); border-radius: 8px; border-left: 4px solid var(--danger);">
                        <strong>Cancellation Reason:</strong>
                        <div style="margin-top: 8px;">${currentViewVoucher.cancellationReason || '-'}</div>
                    </div>
                `;
            }
            
            document.getElementById('voucherDetailsContent').innerHTML = html;
            
            const editBtn = document.getElementById('editVoucherBtn');
            if (currentViewVoucher.status === 'Cancelled' || currentViewVoucher.editCount >= 1) {
                editBtn.disabled = true;
                editBtn.textContent = 'Cannot Edit';
            } else {
                editBtn.disabled = false;
                editBtn.textContent = 'Edit';
            }
            
            document.getElementById('viewVoucherModal').classList.add('active');
        }
        
        function editVoucherDirect(id) {
            // First view, then allow edit
            viewVoucherDetails(id);
        }
        
        function cancelVoucherDirect(id) {
            currentViewVoucher = vouchers.find(v => v.id === id);
            if (!currentViewVoucher) return;
            openCancelModal();
        }
        
        function closeViewVoucherModal() {
            document.getElementById('viewVoucherModal').classList.remove('active');
            currentViewVoucher = null;
        }
        
        function openEditModal() {
            if (!currentViewVoucher || currentViewVoucher.status === 'Cancelled' || currentViewVoucher.editCount >= 1) {
                return;
            }
            
            currentEditVoucher = JSON.parse(JSON.stringify(currentViewVoucher));
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <strong>Voucher:</strong> ${currentEditVoucher.voucherNumber}<br>
                    <strong>Current Amount:</strong> ‚Çπ${currentEditVoucher.invoiceAmount.toLocaleString('en-IN')}
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="required">Invoice Amount (‚Çπ)</label>
                    <input type="number" id="editInvoiceAmount" value="${currentEditVoucher.invoiceAmount}" min="1">
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="required">Invoice Number</label>
                    <input type="text" id="editInvoiceNumber" value="${currentEditVoucher.invoiceNumber}" minlength="3">
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label>Description</label>
                    <textarea id="editDescription" rows="2">${currentEditVoucher.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="required">Reason for Editing</label>
                    <textarea id="editReason" rows="2" placeholder="Why are you making these changes?" required></textarea>
                </div>
            `;
            
            document.getElementById('editVoucherContent').innerHTML = html;
            closeViewVoucherModal();
            document.getElementById('editVoucherModal').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('editVoucherModal').classList.remove('active');
            currentEditVoucher = null;
        }
        
        function saveVoucherEdit() {
            const reason = document.getElementById('editReason').value.trim();
            if (!reason) {
                showError('Please enter a reason for editing');
                return;
            }
            
            const newAmount = parseFloat(document.getElementById('editInvoiceAmount').value);
            const newInvoiceNumber = document.getElementById('editInvoiceNumber').value;
            const newDescription = document.getElementById('editDescription').value;
            
            if (!newAmount || newAmount < 1) {
                showError('Invalid invoice amount');
                return;
            }
            
            if (!newInvoiceNumber || newInvoiceNumber.length < 3) {
                showError('Invalid invoice number');
                return;
            }
            
            if (!/\d/.test(newInvoiceNumber)) {
                showError('Invoice number must contain at least one digit');
                return;
            }
            
            // Check amount change > 10%
            const originalAmount = currentEditVoucher.invoiceAmount;
            const amountChange = Math.abs(newAmount - originalAmount) / originalAmount * 100;
            
            if (amountChange > 10) {
                showError('Amount change exceeds 10%. Please cancel this voucher and create a new one.');
                return;
            }
            
            // Count edited fields
            let editedFields = 0;
            if (newAmount !== originalAmount) editedFields++;
            if (newInvoiceNumber !== currentEditVoucher.invoiceNumber) editedFields++;
            if (newDescription !== (currentEditVoucher.description || '')) editedFields++;
            
            if (editedFields > 3) {
                showError('Cannot edit more than 3 fields. Please cancel this voucher and create a new one.');
                return;
            }
            
            const index = vouchers.findIndex(v => v.id === currentEditVoucher.id);
            if (index === -1) return;
            
            vouchers[index].invoiceAmount = newAmount;
            vouchers[index].invoiceNumber = newInvoiceNumber;
            vouchers[index].description = newDescription;
            
            // Recalculate amounts
            if (vouchers[index].paymentMode === 'Cheque') {
                const tds = Math.round(newAmount * vouchers[index].tdsRate / 100);
                const gst = Math.round(newAmount * vouchers[index].gstRate / 100);
                vouchers[index].tdsAmount = tds;
                vouchers[index].gstAmount = gst;
                vouchers[index].netAmount = newAmount - tds + gst;
            } else {
                vouchers[index].netAmount = newAmount;
            }
            
            vouchers[index].editedBy = CURRENT_USER;
            vouchers[index].editedAt = new Date().toISOString();
            vouchers[index].editReason = reason;
            vouchers[index].editCount = (vouchers[index].editCount || 0) + 1;
            vouchers[index].status = 'Edited';
            
            saveVouchers();
            renderVouchers();
            closeEditModal();
            showToast('‚úÖ Voucher updated successfully');
        }
        
        function openCancelModal() {
            if (!currentViewVoucher) return;
            
            let html = `
                <div style="padding: 12px; background: var(--bg-light); border-radius: 8px; margin-bottom: 16px;">
                    <strong>Voucher:</strong> ${currentViewVoucher.voucherNumber}<br>
                    <strong>Amount:</strong> ‚Çπ${currentViewVoucher.netAmount.toLocaleString('en-IN')}<br>
                    <strong>Vendor:</strong> ${currentViewVoucher.vendorType === 'Registered' ? currentViewVoucher.vendorName : currentViewVoucher.oneTimeVendorName}
                </div>
                <div class="alert alert-danger">
                    ‚ö†Ô∏è <strong>Warning:</strong> This will mark the voucher as cancelled. Voucher number and cheque number (if any) will be permanently used up.
                </div>
            `;
            
            document.getElementById('cancelVoucherContent').innerHTML = html;
            document.getElementById('voucherCancelReason').value = '';
            closeViewVoucherModal();
            document.getElementById('cancelVoucherModal').classList.add('active');
        }
        
        function closeCancelModal() {
            document.getElementById('cancelVoucherModal').classList.remove('active');
        }
        
        function confirmCancelVoucher() {
            const reason = document.getElementById('voucherCancelReason').value.trim();
            if (!reason) {
                showError('Please enter a cancellation reason');
                return;
            }
            
            const index = vouchers.findIndex(v => v.id === currentViewVoucher.id);
            if (index === -1) return;
            
            vouchers[index].status = 'Cancelled';
            vouchers[index].cancellationReason = reason;
            vouchers[index].cancelledBy = CURRENT_USER;
            vouchers[index].cancelledAt = new Date().toISOString();
            
            saveVouchers();
            renderVouchers();
            closeCancelModal();
            showToast('‚úÖ Voucher cancelled');
        }
        
        function generateDateWiseReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            // Validate date range
            if (fromDate && toDate) {
                const fDate = new Date(fromDate);
                const tDate = new Date(toDate);
                
                if (isNaN(tDate.getTime())) {
                    showError('Invalid "To Date"! Please select a valid calendar date.');
                    return;
                }
                
                if (isNaN(fDate.getTime())) {
                    showError('Invalid "From Date"! Please select a valid calendar date.');
                    return;
                }
                
                if (tDate < fDate) {
                    showError('"To Date" cannot be before "From Date"!');
                    return;
                }
            }
            
            // Validate dates
            if (toDate) {
                const tDate = new Date(toDate);
                if (isNaN(tDate.getTime())) {
                    showError('Invalid "To Date"! Please select a valid calendar date.');
                    return;
                }
            }
            
            if (fromDate) {
                const fDate = new Date(fromDate);
                if (isNaN(fDate.getTime())) {
                    showError('Invalid "From Date"! Please select a valid calendar date.');
                    return;
                }
            }
            
            let filtered = vouchers.filter(v => v.status !== 'Cancelled');
            
            if (fromDate && toDate) {
                const fDate = new Date(fromDate);
                const tDate = new Date(toDate);
                
                filtered = filtered.filter(v => {
                    const vDate = new Date(v.date);
                    return vDate >= fDate && vDate <= tDate;
                });
            } else {
                if (fromDate) filtered = filtered.filter(v => new Date(v.date) >= new Date(fromDate));
                if (toDate) filtered = filtered.filter(v => new Date(v.date) <= new Date(toDate));
            }
            
            if (filtered.length === 0) {
                document.getElementById('dateWiseReport').innerHTML = '<div style="text-align: center; padding: 40px;">No data for selected date range</div>';
                return;
            }
            
            const byDate = {};
            filtered.forEach(v => {
                if (!byDate[v.date]) byDate[v.date] = [];
                byDate[v.date].push(v);
            });
            
            let html = '<div class="table-container" style="margin-top: 16px;"><table><thead><tr><th>Date</th><th>Vouchers</th><th>Amount</th></tr></thead><tbody>';
            Object.keys(byDate).sort().reverse().forEach(date => {
                const total = byDate[date].reduce((sum, v) => sum + v.netAmount, 0);
                html += `<tr><td>${new Date(date).toLocaleDateString('en-IN')}</td><td>${byDate[date].length}</td><td>‚Çπ${total.toLocaleString('en-IN')}</td></tr>`;
            });
            const grandTotal = filtered.reduce((sum, v) => sum + v.netAmount, 0);
            html += `<tr style="background: var(--bg-light); font-weight: 700;"><td>TOTAL</td><td>${filtered.length}</td><td>‚Çπ${grandTotal.toLocaleString('en-IN')}</td></tr>`;
            html += '</tbody></table></div>';
            document.getElementById('dateWiseReport').innerHTML = html;
        }
        
        function generateCategoryReport() {
            const filtered = vouchers.filter(v => v.status !== 'Cancelled');
            if (filtered.length === 0) {
                document.getElementById('categoryReport').innerHTML = '<div style="text-align: center; padding: 40px;">No data</div>';
                return;
            }
            
            const byCategory = {};
            filtered.forEach(v => {
                if (!byCategory[v.categoryL1]) byCategory[v.categoryL1] = {count: 0, amount: 0};
                byCategory[v.categoryL1].count++;
                byCategory[v.categoryL1].amount += v.netAmount;
            });
            
            let html = '<div class="table-container" style="margin-top: 16px;"><table><thead><tr><th>Category</th><th>Vouchers</th><th>Amount</th></tr></thead><tbody>';
            Object.keys(byCategory).sort().forEach(cat => {
                const data = byCategory[cat];
                html += `<tr><td>${cat}</td><td>${data.count}</td><td>‚Çπ${data.amount.toLocaleString('en-IN')}</td></tr>`;
            });
            const grandTotal = filtered.reduce((sum, v) => sum + v.netAmount, 0);
            html += `<tr style="background: var(--bg-light); font-weight: 700;"><td>TOTAL</td><td>${filtered.length}</td><td>‚Çπ${grandTotal.toLocaleString('en-IN')}</td></tr>`;
            html += '</tbody></table></div>';
            document.getElementById('categoryReport').innerHTML = html;
        }
        
        function generateChequeUtilizationReport() {
            // Step 1: Summary view
            let html = '<div class="table-container" style="margin-top: 16px;"><table><thead><tr><th>Bank</th><th>Cheque Book Range</th><th>Leaves</th><th>Used</th><th>Cancelled</th><th>Available</th></tr></thead><tbody>';
            
            MASTER_DATA.chequeBooks.forEach((book, idx) => {
                const chequeVouchers = vouchers.filter(v => 
                    v.paymentMode === 'Cheque' && 
                    v.chequeBook === `${book.startNumber}-${book.endNumber}`
                );
                
                const startNum = parseInt(book.startNumber);
                const endNum = parseInt(book.endNumber);
                const totalCheques = endNum - startNum + 1;
                
                const usedCount = chequeVouchers.filter(v => !v.chequeCancelled).length;
                const cancelledCount = chequeVouchers.filter(v => v.chequeCancelled).length;
                const availableCount = totalCheques - usedCount - cancelledCount;
                
                html += `
                    <tr class="clickable cheque-summary-row" onclick="showChequeDetails('${book.bankName}', '${book.startNumber}', '${book.endNumber}', ${book.totalLeaves})">
                        <td><strong>${book.bankName}</strong></td>
                        <td>${book.startNumber} - ${book.endNumber}</td>
                        <td>${book.totalLeaves}</td>
                        <td>${usedCount}</td>
                        <td>${cancelledCount}</td>
                        <td>${availableCount}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            html += '<div style="margin-top: 12px; font-size: 13px; color: var(--text-gray);">üí° Click on any row to view detailed cheque-wise utilization</div>';
            document.getElementById('chequeUtilizationReport').innerHTML = html;
        }
        
        function showChequeDetails(bankName, startNum, endNum, totalLeaves) {
            const start = parseInt(startNum);
            const end = parseInt(endNum);
            
            const chequeVouchers = vouchers.filter(v => 
                v.paymentMode === 'Cheque' && 
                v.chequeBook === `${startNum}-${endNum}`
            );
            
            let html = `
                <div class="modal-header">${bankName} - Cheque Book ${startNum} to ${endNum}</div>
                <div class="table-container"><table>
                    <thead>
                        <tr>
                            <th>Cheque Number</th>
                            <th>Status</th>
                            <th>Vendor / Reason</th>
                            <th>Date</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const usedNumbers = [];
            chequeVouchers.forEach(v => {
                const num = parseInt(v.chequeNumber);
                usedNumbers.push(num);
                
                // Check if this cheque was cancelled
                const cancelledList = JSON.parse(localStorage.getItem('cancelled_cheques_v221') || '[]');
                const cancelInfo = cancelledList.find(c => c.chequeNumber === v.chequeNumber && c.chequeBook === v.chequeBook);
                
                const status = cancelInfo ? 'Cancelled' : 'Used';
                const statusClass = cancelInfo ? 'badge-danger' : 'badge-success';
                const vendor = cancelInfo ? cancelInfo.reason : (v.vendorName || v.oneTimeVendorName);
                const date = v.chequeCancelled ? '-' : new Date(v.chequeDate).toLocaleDateString('en-IN');
                const amount = v.chequeCancelled ? '-' : '‚Çπ' + v.invoiceAmount.toLocaleString('en-IN');
                
                html += `
                    <tr>
                        <td>${v.chequeNumber}</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                        <td>${vendor}</td>
                        <td>${date}</td>
                        <td>${amount}</td>
                    </tr>
                `;
            });
            
            // Find available range
            const availableRanges = [];
            let rangeStart = null;
            for (let num = start; num <= end; num++) {
                if (!usedNumbers.includes(num)) {
                    if (rangeStart === null) {
                        rangeStart = num;
                    }
                } else {
                    if (rangeStart !== null) {
                        availableRanges.push([rangeStart, num - 1]);
                        rangeStart = null;
                    }
                }
            }
            if (rangeStart !== null) {
                availableRanges.push([rangeStart, end]);
            }
            
            // Show available ranges
            availableRanges.forEach(range => {
                const count = range[1] - range[0] + 1;
                const rangeText = range[0] === range[1] ? 
                    range[0].toString().padStart(6, '0') : 
                    `${range[0].toString().padStart(6, '0')}-${range[1].toString().padStart(6, '0')}`;
                
                html += `
                    <tr style="opacity: 0.6;">
                        <td>${rangeText}</td>
                        <td><span class="badge badge-info">Available</span></td>
                        <td>-</td>
                        <td>-</td>
                        <td>${count} cheque(s)</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('chequeDetailContent').innerHTML = html;
            document.getElementById('chequeDetailModal').classList.add('active');
        }
        
        function closeChequeDetailModal() {
            document.getElementById('chequeDetailModal').classList.remove('active');
        }
        
        function exportVouchersToExcel() {
            if (vouchers.length === 0) {
                showError('No vouchers to export');
                return;
            }
            
            const headers = ['Date', 'Voucher No', 'Vendor Type', 'Vendor', 'Payment Mode', 'Invoice No', 'Invoice Amount', 'TDS', 'GST', 'Net Amount', 'Status'];
            const rows = vouchers.map(v => {
                const vendor = v.vendorType === 'Registered' ? v.vendorName : v.oneTimeVendorName;
                return [
                    v.date,
                    v.voucherNumber,
                    v.vendorType,
                    vendor,
                    v.paymentMode,
                    v.invoiceNumber,
                    v.invoiceAmount,
                    v.tdsAmount || 0,
                    v.gstAmount || 0,
                    v.netAmount,
                    v.status
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Vouchers_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('üì• Exported!');
        }
        
        function populateMasterData() {
            // Bank Master
            let html = '<div class="table-container"><table><thead><tr><th>Bank Name</th><th>Account Number</th><th>IFSC Code</th></tr></thead><tbody>';
            MASTER_DATA.banks.forEach(bank => {
                html += `<tr><td>${bank.name}</td><td>${bank.accountNumber}</td><td>${bank.ifscCode}</td></tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('bankMasterContent').innerHTML = html;
            
            // Cheque Book Master
            html = '<div class="table-container"><table><thead><tr><th>Bank</th><th>Start Number</th><th>End Number</th><th>Total Leaves</th></tr></thead><tbody>';
            MASTER_DATA.chequeBooks.forEach(book => {
                html += `<tr><td>${book.bankName}</td><td>${book.startNumber}</td><td>${book.endNumber}</td><td>${book.totalLeaves}</td></tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('chequeBookMasterContent').innerHTML = html;
            
            // Vendor Master with clickable counts
            html = '<div class="table-container"><table><thead><tr><th>Vendor</th><th>Contact</th><th>PAN</th><th>TDS%</th><th>Bank</th><th>Account</th><th>Major Expense Heads</th></tr></thead><tbody>';
            Object.values(MASTER_DATA.vendors).sort((a, b) => a.name.localeCompare(b.name)).forEach(vendor => {
                const uniqueL1s = [...new Set(vendor.allowedPaths.map(p => p.level1))];
                const count = uniqueL1s.length;
                const displayValue = count === 1 ? uniqueL1s[0] : `<span class="vendor-count" onclick="showVendorHeads(event, '${vendor.name}')">${count}</span>`;
                
                html += `
                    <tr>
                        <td><strong>${vendor.name}</strong></td>
                        <td>${vendor.contact}</td>
                        <td>${vendor.pan}</td>
                        <td>${vendor.tdsRate}%</td>
                        <td>${vendor.bankName}</td>
                        <td>${vendor.accountNumber}</td>
                        <td>${displayValue}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('vendorMasterContent').innerHTML = html;
        }
        
        function showVendorHeads(event, vendorName) {
            event.stopPropagation();
            const vendor = MASTER_DATA.vendors[vendorName];
            const uniqueL1s = [...new Set(vendor.allowedPaths.map(p => p.level1))];
            
            const tooltip = document.createElement('div');
            tooltip.className = 'popup-tooltip';
            tooltip.innerHTML = `<strong>${vendorName} - Major Expense Heads:</strong><ul>${uniqueL1s.map(l1 => `<li>${l1}</li>`).join('')}</ul>`;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
            document.body.appendChild(tooltip);
            
            setTimeout(() => tooltip.remove(), 3000);
        }
        
        function showCategoryView(view) {
            const container = document.getElementById('categoryMasterContent');
            const allPaths = getAllCategoryPaths();
            
            if (view === 'table') {
                let html = '<div class="table-container"><table><thead><tr><th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>GST%</th></tr></thead><tbody>';
                allPaths.sort((a, b) => {
                    if (a.level1 !== b.level1) return a.level1.localeCompare(b.level1);
                    if (a.level2 !== b.level2) return a.level2.localeCompare(b.level2);
                    if (a.level3 !== b.level3) return a.level3.localeCompare(b.level3);
                    return a.level4.localeCompare(b.level4);
                }).forEach(path => {
                    html += `<tr><td>${path.level1}</td><td>${path.level2}</td><td>${path.level3}</td><td>${path.level4}</td><td>${path.gstRate}%</td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else if (view === 'tree') {
                container.innerHTML = '<div style="padding: 16px;">Tree view implementation...</div>';
            } else if (view === 'grouped') {
                container.innerHTML = '<div style="padding: 16px;">Grouped view implementation...</div>';
            }
        }
        
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            content.classList.toggle('active');
            arrow.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        }
        
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModalBtn').textContent = 'OK';
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function showWarningModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModalBtn').textContent = 'Confirm';
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal(confirmed) {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        }
        
        function showError(message) {
            alert('‚ùå ERROR\n\n' + message);
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
