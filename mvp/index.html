<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHSL Expense Management - MVP 1.002</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#0D5940;--primary-lt:#1A8A68;--accent:#20C997;
  --bg-page:#F0F7F4;--bg-card:#FFFFFF;--bg-input:#F5FAF8;
  --text-dark:#1A1A1A;--text-mid:#4A4A4A;--text-light:#FFFFFF;
  --border:#C0DDD4;--danger:#C0392B;--warning:#D68910;--success:#196B24
}
body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:var(--bg-page);min-height:100vh;padding:20px;padding-top:140px}
.container{max-width:1400px;margin:0 auto;background:var(--bg-card);border-radius:16px;box-shadow:0 20px 60px rgba(13,89,64,.15);overflow:hidden}
.sticky-header{position:fixed;top:0;left:0;right:0;background:var(--bg-card);z-index:1000;box-shadow:0 4px 12px rgba(13,89,64,.1);padding:20px;display:none}
.sticky-header.show-header{display:block}
.sticky-header-content{max-width:1400px;margin:0 auto}
.voucher-info-bar{background:linear-gradient(135deg,var(--primary),var(--primary-lt));color:#fff;padding:16px 24px;border-radius:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;align-items:center}
.voucher-field{display:flex;flex-direction:column;gap:6px}
.voucher-field label{font-size:11px;opacity:.9;text-transform:uppercase;letter-spacing:.5px}
.voucher-field input{padding:10px 12px;border:2px solid rgba(255,255,255,.3);border-radius:8px;font-size:14px;font-weight:600;background:rgba(255,255,255,.95);color:var(--text-dark)}
.header{background:var(--primary);color:#fff;padding:24px 32px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:24px;font-weight:600}
.tabs{display:flex;background:var(--primary);border-bottom:3px solid var(--accent);overflow-x:auto}
.tab{padding:16px 28px;cursor:pointer;border:none;background:none;font-size:15px;font-weight:500;color:rgba(255,255,255,.75);white-space:nowrap;transition:all .2s}
.tab:hover:not(.active){background:var(--primary-lt);color:#fff}
.tab.active{background:var(--accent);color:var(--primary);font-weight:700}
.tab-content{display:none;padding:32px;animation:fadeIn .3s}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.form-section{background:var(--bg-input);padding:24px;border-radius:12px;margin-bottom:24px;border:1px solid var(--border);transition:all .3s}
.form-section.hidden-step{display:none}
.form-section.greyed-step{opacity:.5;pointer-events:none}
.form-section h3{font-size:18px;color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
.form-group{display:flex;flex-direction:column}
.form-group label{font-size:13px;font-weight:600;color:var(--text-dark);margin-bottom:6px}
.form-group label.required::after{content:" *";color:var(--danger)}
.form-group input,.form-group select,.form-group textarea{padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-card);color:var(--text-dark);transition:all .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(13,89,64,.1)}
.form-group input:disabled,.form-group select:disabled{background:#e8f0ed;cursor:not-allowed}
.btn{padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--primary);color:var(--text-light)}
.btn-primary:hover{background:var(--primary-lt);transform:translateY(-1px)}
.btn-primary:disabled{background:#aaa;cursor:not-allowed;transform:none}
.btn-secondary{background:#E0EDE8;color:var(--primary)}
.btn-secondary:hover{background:#c8ddd6}
.btn-danger{background:var(--danger);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-warning{background:var(--warning);color:var(--text-dark)}
.next-step-btn{margin-top:20px;display:flex;justify-content:flex-end}
.alert{padding:16px;border-radius:8px;margin-bottom:20px;font-size:14px}
.alert-warning{background:#fff8e1;border:1px solid var(--warning);color:#7a5200}
.alert-danger{background:#fdeaea;border:1px solid var(--danger);color:#6d1e1e}
.alert-info{background:#e3f5ed;border:1px solid var(--primary);color:var(--primary)}
.alert-success{background:#e3f5ed;border:1px solid var(--success);color:var(--success)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--bg-card);padding:32px;border-radius:12px;max-width:640px;width:92%;max-height:85vh;overflow-y:auto}
.modal-content.modal-lg{max-width:800px}
.modal-header{font-size:20px;font-weight:600;margin-bottom:20px;color:var(--primary)}
.modal-footer{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
.amount-breakdown{background:var(--bg-input);padding:16px;border-radius:8px;margin-top:16px;border:1px solid var(--border)}
.amount-row{display:flex;justify-content:space-between;padding:8px 0;font-size:14px}
.amount-row.total{border-top:2px solid var(--primary);margin-top:8px;padding-top:12px;font-weight:700;font-size:16px;color:var(--primary)}
.radio-group{display:flex;gap:20px;margin-top:8px;flex-wrap:wrap}
.radio-group label{display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:500}
.hidden{display:none!important}
.toast{position:fixed;bottom:24px;right:24px;background:var(--success);color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:3000;animation:slideIn .3s}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.table-container{overflow-x:auto;margin-top:16px}
table{width:100%;border-collapse:collapse;background:#fff}
table th{background:var(--primary);color:#fff;padding:12px;text-align:left;font-size:13px;font-weight:600}
table td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}
table tr:hover{background:#f0f7f4}
table tr.clickable{cursor:pointer}
.badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
.badge-success{background:#d4edda;color:#155724}
.badge-warning{background:#fff3cd;color:#856404}
.badge-danger{background:#f8d7da;color:#721c24}
.badge-info{background:#d1ecf1;color:#0c5460}
.badge-prepared{background:#e3f2fd;color:#1565c0}
.badge-viewed{background:#f3e5f5;color:#6a1b9a}
.badge-edited{background:#fff3e0;color:#e65100}
.badge-bt{background:#e3f5ed;color:#0D5940}
.stat-card{background:linear-gradient(135deg,var(--primary),var(--primary-lt));color:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 12px rgba(13,89,64,.2)}
.stat-card .label{font-size:13px;opacity:.9;margin-bottom:8px}
.stat-card .value{font-size:32px;font-weight:700}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:32px}
.collapsible-section{border:1px solid var(--border);border-radius:8px;margin-bottom:16px;overflow:hidden}
.collapsible-header{background:var(--bg-input);padding:16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;color:var(--primary)}
.collapsible-header:hover{background:#d0ede4}
.collapsible-content{padding:16px;display:none}
.collapsible-content.active{display:block}
.tree-children{display:none;padding-left:24px;margin-top:4px}
.tree-children.open{display:block}
.tree-node-l1{display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;border-radius:6px;font-weight:600;color:var(--primary);background:var(--bg-input);border:1px solid var(--border);margin-bottom:4px}
.tree-node-l1:hover{background:#d0ede4}
.tree-node-l2{padding:6px 10px;border-radius:4px;cursor:pointer;color:var(--text-mid);background:#f5faf8;border-left:3px solid var(--accent);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.tree-node-l2:hover{background:var(--bg-input)}
.tree-node-l3{padding:5px 10px;border-radius:4px;color:var(--text-mid);border-left:2px solid var(--border);margin:2px 0 2px 16px;font-size:13px}
.tree-node-l4{padding:4px 10px;margin-left:32px;font-size:12px;color:#888;font-style:italic}
.user-entry-note{font-style:italic;color:#888;font-size:12px}
.btn-save-reason{background:var(--warning);color:var(--text-dark);margin-top:12px}
.cheque-summary-row{background:#e3f5ed!important;font-weight:600}
.btn-group{display:flex;gap:8px}
.pm-section{border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.pm-section-title{font-size:13px;font-weight:700;color:var(--primary);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.pm-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.page-footer{text-align:center;padding:20px;font-size:12px;color:var(--text-mid);border-top:1px solid var(--border);margin-top:20px}
</style>
</head>
<body>
<div class="sticky-header" id="stickyHeader">
  <div class="sticky-header-content">
    <div class="voucher-info-bar">
      <div class="voucher-field"><label>Voucher Date</label><input type="date" id="stickyVoucherDate" onchange="updateStickyDate()"></div>
      <div class="voucher-field"><label>Voucher Number</label><input type="text" id="stickyVoucherNumber" placeholder="MMM-XXX" readonly></div>
      <div class="voucher-field" style="justify-content:center"><div style="font-size:24px">&#128203;</div><div style="font-size:11px;opacity:.9">Create Voucher</div></div>
    </div>
  </div>
</div>
<div class="container">
  <div class="header">
    <div><h1>My Co-operative Housing Society Ltd</h1><div class="fy">Financial Year: 2025-2026</div></div>
    <div><div style="text-align:right;font-size:13px;opacity:.9">Committee Strength: 7</div><div style="text-align:right;font-size:12px;opacity:.8;margin-top:4px">MVP 1.002</div></div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('dashboard',this)">&#128202; Dashboard</button>
    <button class="tab" onclick="switchTab('create-voucher',this)">&#10133; Create Voucher</button>
    <button class="tab" onclick="switchTab('view-vouchers',this)">&#128203; View Vouchers</button>
    <button class="tab" onclick="switchTab('reports',this)">&#128200; Reports</button>
    <button class="tab" onclick="switchTab('master-data',this)">&#128218; Master Data</button>
  </div>

  <!-- DASHBOARD -->
  <div id="tab-dashboard" class="tab-content active">
    <h2 style="margin-bottom:24px;color:var(--primary)">Dashboard</h2>
    <div class="dashboard-grid">
      <div class="stat-card"><div class="label">Total Vouchers</div><div class="value" id="stat-total-vouchers">0</div></div>
      <div class="stat-card"><div class="label">Total Amount</div><div class="value" id="stat-total-amount">&#8377;0</div></div>
      <div class="stat-card"><div class="label">This Month</div><div class="value" id="stat-month-vouchers">0</div></div>
      <div class="stat-card"><div class="label">Active Vendors</div><div class="value" id="stat-active-vendors">0</div></div>
    </div>
  </div>

  <!-- CREATE VOUCHER -->
  <div id="tab-create-voucher" class="tab-content">
    <h2 style="margin-bottom:24px;color:var(--primary)">Create New Expense Voucher</h2>
    <form id="voucherForm">

      <!-- STEP 1 -->
      <div class="form-section" id="step1">
        <h3>&#128203; STEP 1: Vendor Type</h3>
        <div class="radio-group">
          <label><input type="radio" name="vendorType" value="Registered" checked onchange="onVendorTypeChange()"><span>Registered Vendor</span></label>
          <label><input type="radio" name="vendorType" value="One-Time" onchange="onVendorTypeChange()"><span>One-Time Vendor</span></label>
          <label><input type="radio" name="vendorType" value="Bank Transaction" onchange="onVendorTypeChange()"><span>Bank Transactions</span></label>
        </div>
        <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeStep(1)">Next Step &#8594;</button></div>
      </div>

      <!-- STEP 2 -->
      <div class="form-section hidden-step" id="step2">
        <h3>&#128176; STEP 2: Payment Details</h3>
        <div class="form-grid"><div class="form-group"><label>Payment Mode</label><input type="text" id="paymentMode" value="Cheque" readonly style="background:#e8f0ed"></div></div>
        <div id="chequeDetails" style="margin-top:16px">
          <div class="form-grid">
            <div class="form-group"><label for="chequeBank" class="required">Select Bank</label><select id="chequeBank" onchange="onChequeBankChange()"><option value="">Choose bank...</option></select></div>
            <div class="form-group"><label for="chequeBook" class="required">Cheque Book</label><select id="chequeBook" onchange="assignChequeNumber()"><option value="">Choose cheque book...</option></select></div>
            <div class="form-group"><label for="chequeNumber" class="required">Cheque Number</label><input type="text" id="chequeNumber" readonly style="background:#e8f0ed"><small style="color:var(--text-mid);margin-top:4px">Auto-assigned</small></div>
            <div class="form-group"><label for="chequeDate" class="required">Cheque Date</label><input type="date" id="chequeDate"></div>
          </div>
          <div style="margin-top:12px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="chequeCancelled" onchange="onChequeCancelledChange()"><span>Mark this cheque as CANCELLED</span></label></div>
          <div id="chequeCancelReason" class="hidden" style="margin-top:12px">
            <div class="form-group"><label for="cancelReason" class="required">Cancellation Reason</label><textarea id="cancelReason" rows="2"></textarea></div>
            <button type="button" class="btn btn-save-reason" onclick="saveCancellationReason()">&#128190; Save Cancellation Reason</button>
          </div>
          <div id="reasonSavedNotice" class="alert alert-success hidden" style="margin-top:12px">&#10003; Cancellation reason saved. Next valid cheque assigned.</div>
        </div>
        <div class="next-step-btn"><button type="button" class="btn btn-primary" id="step2NextBtn" onclick="completeStep(2)">Next Step &#8594;</button></div>
      </div>

      <!-- STEP 3 -->
      <div class="form-section hidden-step" id="step3">
        <h3>&#127962; STEP 3: Vendor Details</h3>
        <div id="registeredVendorSection">
          <div class="form-group"><label for="vendorSelect" class="required">Select Vendor</label><select id="vendorSelect" onchange="onVendorChange()"><option value="">Choose vendor...</option></select></div>
          <div id="vendorInfo" class="hidden" style="margin-top:16px;padding:16px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border)">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;font-size:13px">
              <div><strong>PAN:</strong> <span id="v-pan">-</span></div>
              <div><strong>Contact:</strong> <span id="v-contact">-</span></div>
              <div><strong>TDS Rate:</strong> <span id="v-tds">-</span>%</div>
            </div>
          </div>
        </div>
        <div id="oneTimeVendorSection" class="hidden">
          <div class="form-grid">
            <div class="form-group"><label for="oneTimeVendorName" class="required">Vendor Name</label><input type="text" id="oneTimeVendorName" minlength="3"></div>
            <div class="form-group"><label for="oneTimeVendorContact" class="required">Contact Number</label><input type="text" id="oneTimeVendorContact" maxlength="10"></div>
          </div>
          <div class="form-group" style="margin-top:16px"><label for="oneTimeVendorAddress" class="required">Address</label><textarea id="oneTimeVendorAddress" rows="4" maxlength="250"></textarea><small style="color:var(--text-mid);margin-top:4px"><span id="addressCharCount">0</span>/250</small></div>
        </div>
        <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeStep(3)">Next Step &#8594;</button></div>
      </div>

      <!-- STEP 4 -->
      <div class="form-section hidden-step" id="step4">
        <h3>&#128194; STEP 4: Expense Category</h3>
        <div class="form-grid">
          <div class="form-group"><label for="categoryL1" class="required">Major Expense Head (L1)</label><select id="categoryL1" onchange="onCategoryL1Change()"><option value="">Select major head...</option></select></div>
          <div class="form-group hidden" id="categoryL2Group"><label class="required">Minor Expense Head (L2)</label><div id="categoryL2Container"><select id="categoryL2" onchange="onCategoryL2Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)"><option value="">Select minor head...</option></select></div></div>
          <div class="form-group hidden" id="categoryL3Group"><label>Why Spent (L3)</label><div id="categoryL3Container"></div></div>
          <div class="form-group hidden" id="categoryL4Group"><label>Spent For (L4)</label><div id="categoryL4Container"></div></div>
        </div>
        <div id="categoryPath" class="hidden" style="margin-top:12px;padding:12px;background:var(--bg-card);border-radius:8px;font-size:13px;color:var(--text-mid)"><strong>Category Path:</strong> <span id="categoryPathText">-</span></div>
        <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeStep(4)">Next Step &#8594;</button></div>
      </div>

      <!-- STEP 5 -->
      <div class="form-section hidden-step" id="step5">
        <h3>&#128196; STEP 5: Invoice Details</h3>
        <div class="form-grid">
          <div class="form-group"><label for="invoiceAmount" class="required">Invoice Amount (&#8377;)</label><input type="number" id="invoiceAmount" min="1" step="1" onchange="calculateAmounts()" onblur="roundAmount()"></div>
          <div class="form-group"><label for="invoiceNumber" class="required">Invoice Number</label><input type="text" id="invoiceNumber" minlength="3"></div>
        </div>
        <div id="tdsGstSection">
          <div class="form-grid" style="margin-top:16px">
            <div class="form-group"><label>TDS Amount (&#8377;)</label><input type="text" id="tdsAmount" readonly style="background:#e8f0ed"></div>
            <div class="form-group"><label>GST Amount (&#8377;)</label><input type="text" id="gstAmount" readonly style="background:#e8f0ed"></div>
          </div>
          <div class="amount-breakdown">
            <div class="amount-row"><span>Invoice Amount:</span><span id="breakdown-invoice">&#8377;0</span></div>
            <div class="amount-row"><span>Less: TDS (<span id="breakdown-tds-rate">0</span>%):</span><span id="breakdown-tds">&#8377;0</span></div>
            <div class="amount-row"><span>Add: GST (<span id="breakdown-gst-rate">0</span>%):</span><span id="breakdown-gst">&#8377;0</span></div>
            <div class="amount-row total"><span>Net Payment Amount:</span><span id="breakdown-net">&#8377;0</span></div>
          </div>
        </div>
        <div class="form-group" style="margin-top:16px"><label for="description">Description / Remarks</label><textarea id="description" rows="3"></textarea></div>
        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;flex-wrap:wrap">
          <button type="button" class="btn btn-secondary" onclick="resetVoucherForm()">Reset Form</button>
          <button type="button" class="btn btn-primary" onclick="saveVoucher()">&#128190; Save Voucher</button>
          <button type="button" class="btn btn-secondary" onclick="openPreviewModal('standard')">&#128269; Preview / Modify</button>
        </div>
      </div>

      <!-- BANK TRANSACTION SECTION -->
      <div id="bankTransactionSection" class="hidden">
        <div class="form-section" id="bt-step1">
          <h3>&#127974; BT-STEP 1: Bank Selection &amp; Cheque</h3>
          <div class="form-grid"><div class="form-group"><label for="bt-bankSelect" class="required">Select Bank</label><select id="bt-bankSelect" onchange="onBTBankChange()"><option value="">Choose bank...</option></select></div></div>
          <div id="bt-chequeQuestion" class="hidden" style="margin-top:16px">
            <div style="font-weight:600;margin-bottom:12px;color:var(--primary)">Issue a Cheque for this transaction?</div>
            <div class="radio-group">
              <label><input type="radio" name="btChequeYN" value="yes" onchange="onBTChequeChoice(true)"><span>Yes &#8212; Issue Cheque</span></label>
              <label><input type="radio" name="btChequeYN" value="no" onchange="onBTChequeChoice(false)" checked><span>No &#8212; Direct Bank Debit/Credit</span></label>
            </div>
            <div id="bt-chequeDetails" class="hidden" style="margin-top:16px">
              <div class="form-grid">
                <div class="form-group"><label for="bt-chequeBook" class="required">Cheque Book</label><select id="bt-chequeBook" onchange="assignBTChequeNumber()"><option value="">Choose cheque book...</option></select></div>
                <div class="form-group"><label for="bt-chequeNumber" class="required">Cheque Number</label><input type="text" id="bt-chequeNumber" readonly style="background:#e8f0ed"><small style="color:var(--text-mid)">Auto-assigned</small></div>
                <div class="form-group"><label for="bt-chequeDate" class="required">Cheque Date</label><input type="date" id="bt-chequeDate"></div>
              </div>
              <div style="margin-top:12px"><label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="bt-chequeCancelled" onchange="onBTChequeCancelledChange()"><span>Mark this cheque as CANCELLED</span></label></div>
              <div id="bt-chequeCancelReason" class="hidden" style="margin-top:12px">
                <div class="form-group"><label for="bt-cancelReason" class="required">Cancellation Reason</label><textarea id="bt-cancelReason" rows="2"></textarea></div>
                <button type="button" class="btn btn-save-reason" onclick="saveBTCancellationReason()">&#128190; Save Cancellation Reason</button>
              </div>
              <div id="bt-reasonSavedNotice" class="alert alert-success hidden" style="margin-top:12px">&#10003; Cancellation reason saved. Next valid cheque assigned.</div>
            </div>
          </div>
          <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeBTStep(1)">Next Step &#8594;</button></div>
        </div>

        <div class="form-section hidden-step" id="bt-step2">
          <h3>&#128194; BT-STEP 2: Transaction Category</h3>
          <div class="form-grid">
            <div class="form-group"><label for="bt-categoryL1" class="required">Transaction Category (L1)</label><select id="bt-categoryL1" onchange="onBTCatL1Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-card)"><option value="">Select category...</option></select></div>
            <div class="form-group hidden" id="bt-catL2Group"><label id="bt-catL2Label" class="required">Details (L2)</label><input type="text" id="bt-categoryL2" placeholder="Enter Details..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px"></div>
            <div class="form-group hidden" id="bt-catL3Group"><label id="bt-catL3Label">Purpose (L3)</label><input type="text" id="bt-categoryL3" placeholder="Enter For What Spent..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px"></div>
            <div class="form-group hidden" id="bt-catL4Group"><label id="bt-catL4Label">Detail (L4)</label><input type="text" id="bt-categoryL4" placeholder="Enter For What Spent..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px"></div>
          </div>
          <div id="bt-categoryPath" class="hidden" style="margin-top:12px;padding:12px;background:var(--bg-card);border-radius:8px;font-size:13px;color:var(--text-mid)"><strong>Category Path:</strong> <span id="bt-categoryPathText">-</span></div>
          <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeBTStep(2)">Next Step &#8594;</button></div>
        </div>

        <div class="form-section hidden-step" id="bt-step3">
          <h3>&#128176; BT-STEP 3: Amount Details</h3>
          <div class="form-grid">
            <div class="form-group"><label for="bt-referenceNumber" class="required">Reference Number</label><input type="text" id="bt-referenceNumber" placeholder="Bank ref / debit advice no." minlength="3"></div>
            <div class="form-group"><label for="bt-transactionAmount" class="required">Transaction Amount (&#8377;)</label><input type="number" id="bt-transactionAmount" min="1" step="1" onchange="calculateBTNet()" onblur="calculateBTNet()"></div>
            <div class="form-group"><label for="bt-gstAmount">GST Amount (&#8377;) &#8212; enter 0 if none</label><input type="number" id="bt-gstAmount" min="0" step="1" value="0" onchange="calculateBTNet()"></div>
          </div>
          <div class="amount-breakdown">
            <div class="amount-row"><span>Transaction Amount:</span><span id="bt-breakdown-txn">&#8377;0</span></div>
            <div class="amount-row"><span>GST Amount:</span><span id="bt-breakdown-gst">&#8377;0</span></div>
            <div class="amount-row total"><span>Net Amount:</span><span id="bt-breakdown-net">&#8377;0</span></div>
          </div>
          <div class="form-group" style="margin-top:16px"><label for="bt-description">Description / Remarks</label><textarea id="bt-description" rows="3" placeholder="Optional notes..."></textarea></div>
          <div class="next-step-btn"><button type="button" class="btn btn-primary" onclick="completeBTStep(3)">Next Step &#8594;</button></div>
        </div>

        <div class="form-section hidden-step" id="bt-step4">
          <h3>&#10003; BT-STEP 4: Review &amp; Save</h3>
          <div id="bt-step4Summary" style="padding:16px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border);font-size:14px;line-height:2"></div>
          <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;flex-wrap:wrap">
            <button type="button" class="btn btn-secondary" onclick="resetBTForm()">Reset</button>
            <button type="button" class="btn btn-secondary" onclick="openPreviewModal('bt')">&#128269; Preview / Modify</button>
            <button type="button" class="btn btn-primary" onclick="saveBTVoucher()">&#128190; Save Voucher</button>
          </div>
        </div>
      </div>

    </form>
  </div>

  <!-- VIEW VOUCHERS -->
  <div id="tab-view-vouchers" class="tab-content">
    <h2 style="margin-bottom:24px;color:var(--primary)">View &amp; Manage Vouchers</h2>
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap">
      <input type="text" id="voucherSearch" placeholder="&#128269; Search by Vendor or Expense Category" onkeyup="renderVouchers()" style="padding:12px;border:2px solid var(--border);border-radius:8px;flex:1;min-width:200px;background:var(--bg-card)">
      <button class="btn btn-success" onclick="exportVouchersToExcel()">&#128229; Export</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Date</th><th>Voucher No.</th><th>Vendor / Bank</th><th>Major Expense Head</th><th>Payment</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="vouchersTableBody"><tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-mid)">No vouchers yet</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- REPORTS -->
  <div id="tab-reports" class="tab-content">
    <h2 style="margin-bottom:24px;color:var(--primary)">Reports &amp; Analytics</h2>
    <div class="form-section">
      <h3>&#128202; Date-Wise Report</h3>
      <div class="form-grid">
        <div class="form-group"><label>From Date</label><input type="date" id="reportFromDate"></div>
        <div class="form-group"><label>To Date</label><input type="date" id="reportToDate"></div>
      </div>
      <button class="btn btn-primary" style="margin-top:12px" onclick="generateDateWiseReport()">Generate</button>
      <div id="dateWiseReport"></div>
    </div>
    <div class="form-section">
      <h3>&#128194; Category-Wise Report</h3>
      <button class="btn btn-primary" onclick="generateCategoryReport()">Generate</button>
      <div id="categoryReport"></div>
    </div>
    <div class="form-section">
      <h3>&#127974; Cheque Book Utilization Report</h3>
      <button class="btn btn-primary" onclick="generateChequeUtilizationReport()">Generate</button>
      <div id="chequeUtilizationReport"></div>
    </div>
  </div>

  <!-- MASTER DATA -->
  <div id="tab-master-data" class="tab-content">
    <h2 style="margin-bottom:24px;color:var(--primary)">Master Data Reference</h2>
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)"><span>&#127974; Bank Master</span><span>&#9660;</span></div>
      <div class="collapsible-content" id="bankMasterContent"></div>
    </div>
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)"><span>&#128213; Cheque Book Master</span><span>&#9660;</span></div>
      <div class="collapsible-content" id="chequeBookMasterContent"></div>
    </div>
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)"><span>&#127962; Vendor Master</span><span>&#9660;</span></div>
      <div class="collapsible-content" id="vendorMasterContent"></div>
    </div>
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection(this)"><span>&#128194; Expense Category Master</span><span>&#9660;</span></div>
      <div class="collapsible-content">
        <div style="margin-bottom:16px">
          <button class="btn btn-secondary" onclick="showCategoryView('table')">&#128203; Table View</button>
          <button class="btn btn-secondary" onclick="showCategoryView('tree')">&#127795; Tree View</button>
          <button class="btn btn-secondary" onclick="showCategoryView('grouped')">&#128193; Grouped View</button>
        </div>
        <div id="categoryMasterContent"></div>
      </div>
    </div>
  </div>

  <div class="page-footer">Designed by <strong>Minerva Ventures LLP</strong> &nbsp;|&nbsp; All Copyrights Reserved &copy; 2026</div>
</div>

<!-- MODALS -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="confirmModalTitle">Confirm</div>
    <div id="confirmModalMessage" style="white-space:pre-line"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeConfirmModal(false)">Cancel</button>
      <button class="btn btn-primary" id="confirmModalBtn" onclick="closeConfirmModal(true)">OK</button>
    </div>
  </div>
</div>
<div id="viewVoucherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Voucher Details</div>
    <div id="voucherDetailsContent"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeViewVoucherModal()">Close</button>
      <button class="btn btn-primary" id="editVoucherBtn" onclick="openEditModal()">Edit</button>
      <button class="btn btn-danger" onclick="openCancelModal()">Cancel Voucher</button>
    </div>
  </div>
</div>
<div id="editVoucherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Edit Voucher</div>
    <div class="alert alert-warning"><strong>&#9888; Limited Editing:</strong> Invoice/Transaction Amount (max 10% change), Reference/Invoice Number, Description. One edit only.</div>
    <div id="editVoucherContent"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveVoucherEdit()">Save Changes</button>
    </div>
  </div>
</div>
<div id="cancelVoucherModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="color:var(--danger)">Cancel Voucher</div>
    <div id="cancelVoucherContent"></div>
    <div class="form-group" style="margin-top:16px">
      <label class="required">Cancellation Reason</label>
      <textarea id="voucherCancelReason" rows="3" placeholder="Why are you cancelling this voucher?" required></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCancelModal()">Close</button>
      <button class="btn btn-danger" onclick="confirmCancelVoucher()">Confirm Cancellation</button>
    </div>
  </div>
</div>
<div id="chequeDetailModal" class="modal">
  <div class="modal-content modal-lg">
    <div id="chequeDetailContent"></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeChequeDetailModal()">Close</button></div>
  </div>
</div>
<div id="previewVoucherModal" class="modal" style="z-index:2100">
  <div class="modal-content modal-lg">
    <div class="modal-header">&#128203; Preview &amp; Edit Voucher</div>
    <div id="previewVoucherBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closePreviewModal()">&#10006; Close</button>
      <button class="btn btn-secondary" id="pmModifyBtn" onclick="activatePreviewModify()">&#9998; Modify</button>
      <button class="btn btn-primary" onclick="saveFromPreviewModal()">&#10003; Save Voucher</button>
    </div>
  </div>
</div>

<script>
const MASTER_DATA = {"vendors":{"Adani":{"name":"Adani","pan":"ADANI1234T","gstNumber":"","contact":"8814392236","email":"any@one.com","tdsRate":0,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Electricity Charges","level2":"None","level3":"None","level4":"None","gstRate":0}]},"BMC":{"name":"BMC","pan":"BMCPT1234R","gstNumber":"","contact":"8217877142","email":"any@one.com","tdsRate":0,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Property Tax for Parking & Common Areas","level2":"None","level3":"None","level4":"None","gstRate":0},{"level1":"BMC Water Charges","level2":"None","level3":"None","level4":"None","gstRate":0}]},"Tank":{"name":"Tank","pan":"PAPUE5632Q","gstNumber":"27PAPUE5632Q1WE","contact":"8470475616","email":"any@one.com","tdsRate":2,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Water Charges - Tanker","level2":"None","level3":"None","level4":"None","gstRate":5}]},"Adhya":{"name":"Adhya","pan":"ADHYA7894Q","gstNumber":"22ADHYA7894Q5UT","contact":"8472583662","email":"any@one.com","tdsRate":2,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Security Charges","level2":"None","level3":"None","level4":"None","gstRate":18},{"level1":"Housekeeping Charges","level2":"Monthly Contract","level3":"None","level4":"None","gstRate":18},{"level1":"Housekeeping Charges","level2":"Supplies","level3":"None","level4":"None","gstRate":18}]},"Tanaji":{"name":"Tanaji","pan":"TANAJ1452Y","gstNumber":"11TANAJ1452Y3ER","contact":"8471698276","email":"any@one.com","tdsRate":2,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Passenger Lift (AMC)","level2":"Contractual","level3":"None","level4":"None","gstRate":18},{"level1":"Passenger Lift (AMC)","level2":"Parts","level3":"None","level4":"None","gstRate":18}]},"Infinite":{"name":"Infinite","pan":"INFIN5846W","gstNumber":"15INFIN5846W6DF","contact":"8471700869","email":"any@one.com","tdsRate":10,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Accounting & Managerial Charges","level2":"Monthly Contract","level3":"None","level4":"None","gstRate":18},{"level1":"Accounting & Managerial Charges","level2":"Supplies","level3":"None","level4":"None","gstRate":18},{"level1":"Accounting & Managerial Charges","level2":"Work Specific","level3":"User Entry","level4":"User Entry","gstRate":18}]},"Darji":{"name":"Darji","pan":"DARJI3245R","gstNumber":"","contact":"8471701106","email":"any@one.com","tdsRate":0,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Salaries","level2":"Gym Trainer","level3":"None","level4":"None","gstRate":0},{"level1":"Salaries","level2":"others","level3":"User Entry","level4":"User Entry","gstRate":0}]},"Sometest Contractors":{"name":"Sometest Contractors","pan":"XYZAB5678C","gstNumber":"27XYZAB5678C1Z1","contact":"7895716540","email":"Some@test.com","tdsRate":2,"bankName":"SVC Bank","accountNumber":"1234567890","ifsc":"SVCB0000001","status":"Active","allowedPaths":[{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"AMC Expenses","level3":"others","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Water Pump","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"DG Set","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Electrical","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Civil","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Plumbing","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"General","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Drainage/Sewage","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Lift","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Gym Room","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Yoga Room","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"Society Office","level4":"User Entry","gstRate":5},{"level1":"Repairs & Maintenance","level2":"Parts","level3":"others","level4":"User Entry","gstRate":5}]},"Anyone Suppliers":{"name":"Anyone Suppliers","pan":"ABCDE1234F","gstNumber":"22ABCDE1234F1Z1","contact":"9380716540","email":"any@one.com","tdsRate":10,"bankName":"HDFC Bank","accountNumber":"9876543210","ifsc":"HDFC0001234","status":"Active","allowedPaths":[{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"Servicing","level3":"others","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Water Pump","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"DG Set","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Electrical","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Civil","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Plumbing","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"General","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Drainage/Sewage","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Lift","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Gym Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Yoga Room","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"Society Office","level4":"User Entry","gstRate":18},{"level1":"Repairs & Maintenance","level2":"others","level3":"others","level4":"User Entry","gstRate":18}]},"XYZ Services":{"name":"XYZ Services","pan":"ABXYZ1234F","gstNumber":"22ABXYZ1234F1Z1","contact":"9370816540","email":"xyz@one.com","tdsRate":10,"gstRate":18,"status":"Active","bankName":"","accountNumber":"","allowedPaths":[{"level1":"Society Expenses","level2":"Society Meetings","level3":"others","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"Travelling & Conveyance","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"Printing & Stationary","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"Photocopying","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"Postage","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"Festival Expenses","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Society Expenses","level2":"others","level3":"User Entry","level4":"User Entry","gstRate":0}]},"Bharat Cooperative Bank":{"name":"Bharat Cooperative Bank","pan":"ABBCB1234F","gstNumber":"22ABBCB1234F1Z1","contact":"9370856140","email":"bcb@one.com","tdsRate":0,"gstRate":18,"status":"Active","bankName":"Bharat Cooperative Bank","accountNumber":"1234567890","allowedPaths":[{"level1":"Bank Charges","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18},{"level1":"FD Opening","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Cheque Bounce","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18},{"level1":"Others","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18}]},"FJKL Pvt Bank":{"name":"FJKL Pvt Bank","pan":"AFJKL1234F","gstNumber":"22AFJKL1234F1Z1","contact":"9370857654","email":"fjkl@one.com","tdsRate":0,"gstRate":18,"status":"Active","bankName":"FJKL Pvt Bank","accountNumber":"8323364321","allowedPaths":[{"level1":"Bank Charges","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18},{"level1":"FD Opening","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":0},{"level1":"Cheque Bounce","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18},{"level1":"Others","level2":"User Entry","level3":"User Entry","level4":"User Entry","gstRate":18}]},"Self -BCB Bank":{"name":"Self -BCB Bank","pan":"SelfL1234F","gstNumber":"","contact":"","email":"","tdsRate":0,"gstRate":0,"status":"Active","bankName":"Bharat Cooperative Bank","accountNumber":"1234567890","allowedPaths":[{"level1":"Petty Cash Withdrawal","level2":"User Entry","level3":"None","level4":"None","gstRate":0}]},"Self -FJKL Bank":{"name":"Self -FJKL Bank","pan":"SelfL1234F","gstNumber":"","contact":"","email":"","tdsRate":0,"gstRate":0,"status":"Active","bankName":"FJKL Pvt Bank","accountNumber":"8323364321","allowedPaths":[{"level1":"Petty Cash Withdrawal","level2":"User Entry","level3":"None","level4":"None","gstRate":0}]}},"banks":[{"name":"Bharat Cooperative Bank","accountNumber":"1234567890","ifscCode":"BCOP0000001"},{"name":"FJKL Pvt Bank","accountNumber":"8323364321","ifscCode":"FJKL0000321"}],"chequeBooks":[{"bankName":"Bharat Cooperative Bank","startNumber":"000051","totalLeaves":25,"endNumber":"000075"},{"bankName":"Bharat Cooperative Bank","startNumber":"000106","totalLeaves":50,"endNumber":"000155"},{"bankName":"Bharat Cooperative Bank","startNumber":"000281","totalLeaves":100,"endNumber":"000380"},{"bankName":"Bharat Cooperative Bank","startNumber":"000001","totalLeaves":50,"endNumber":"000050"},{"bankName":"FJKL Pvt Bank","startNumber":"000076","totalLeaves":100,"endNumber":"000175"},{"bankName":"FJKL Pvt Bank","startNumber":"000151","totalLeaves":25,"endNumber":"000175"},{"bankName":"FJKL Pvt Bank","startNumber":"000426","totalLeaves":10,"endNumber":"000435"}]};


// ── GLOBALS ──
const BANK_VENDOR_KEYS=['Bharat Cooperative Bank','FJKL Pvt Bank','Self -BCB Bank','Self -FJKL Bank'];
const STORAGE_KEY='chsl_vouchers_v22';
const CURRENT_USER='Admin';
let vouchers=[],currentViewVoucher=null,currentCancelVoucherId=null,currentEditVoucher=null;
let currentVendorData=null,currentCategoryGST=0,confirmCallback=null;
let chequeCancellationCounter=0,cancellationReasonSaved=false,currentStep=1;
let currentBTStep=1,currentBTBank=null,btIssuesCheque=false;
let btChequeCancellationCounter=0,btCancellationReasonSaved=false;
let previewContext='standard';

// ── INIT ──
document.addEventListener('DOMContentLoaded',function(){
  loadVouchers();initializeForm();setTodayDate();populateBanks();
  updateDashboard();renderVouchers();populateMasterData();showCategoryView('table');
});
function initializeForm(){
  onVendorTypeChange();
  document.getElementById('oneTimeVendorAddress').addEventListener('input',function(){
    document.getElementById('addressCharCount').textContent=this.value.length;
  });
}
function setTodayDate(){
  const t=new Date().toISOString().split('T')[0];
  document.getElementById('stickyVoucherDate').value=t;
  document.getElementById('chequeDate').value=t;
  const bcd=document.getElementById('bt-chequeDate');if(bcd)bcd.value=t;
  generateVoucherNumber();
}
function updateStickyDate(){
  const d=document.getElementById('stickyVoucherDate').value;if(!d)return;
  const vd=new Date(d),td=new Date();td.setHours(0,0,0,0);vd.setHours(0,0,0,0);
  if(isNaN(vd.getTime())){showError('Invalid date!');document.getElementById('stickyVoucherDate').value=td.toISOString().split('T')[0];return;}
  if(vd>td){showError('Voucher date cannot be in the future!');document.getElementById('stickyVoucherDate').value=td.toISOString().split('T')[0];return;}
  const md=new Date(td);md.setMonth(td.getMonth()-1);
  if(vd<md){showWarningModal('\u26a0\ufe0f DATE WARNING','Voucher date is more than 1 month old.\nThis will be flagged in audit trail. Proceed?',()=>generateVoucherNumber());return;}
  generateVoucherNumber();
}
function loadVouchers(){
  const s=localStorage.getItem(STORAGE_KEY);
  if(s){vouchers=JSON.parse(s);vouchers.forEach(v=>{if(!v.status)v.status='Prepared';if(!v.editCount)v.editCount=0;});}
}
function saveVouchers(){localStorage.setItem(STORAGE_KEY,JSON.stringify(vouchers));updateDashboard();}
function switchTab(name,el){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(el)el.classList.add('active');
  document.getElementById('stickyHeader').classList.toggle('show-header',name==='create-voucher');
  if(name==='dashboard')updateDashboard();
  if(name==='view-vouchers')renderVouchers();
}
function updateDashboard(){
  const a=vouchers.filter(v=>v.status!=='Cancelled');
  document.getElementById('stat-total-vouchers').textContent=a.length;
  document.getElementById('stat-total-amount').textContent='\u20b9'+a.reduce((s,v)=>s+(v.netAmount||0),0).toLocaleString('en-IN');
  const now=new Date();
  document.getElementById('stat-month-vouchers').textContent=a.filter(v=>{const d=new Date(v.date);return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();}).length;
  const cnt=Object.keys(MASTER_DATA.vendors).filter(k=>!BANK_VENDOR_KEYS.includes(k)&&MASTER_DATA.vendors[k].status==='Active').length;
  const el=document.getElementById('stat-active-vendors');if(el)el.textContent=cnt;
}
function generateVoucherNumber(){
  const date=new Date(document.getElementById('stickyVoucherDate').value||new Date());
  const month=date.toLocaleString('en-US',{month:'short'});
  const seq=(vouchers.filter(v=>{const d=new Date(v.date);return d.getMonth()===date.getMonth()&&d.getFullYear()===date.getFullYear();}).length+1).toString().padStart(3,'0');
  document.getElementById('stickyVoucherNumber').value=month+'-'+seq;
}

// ── STEP WORKFLOW ──
function completeStep(n){
  if(!validateStep(n))return;
  document.getElementById('step'+n).classList.add('greyed-step');
  if(n+1<=5){document.getElementById('step'+(n+1)).classList.remove('hidden-step');currentStep=n+1;}
}
function validateStep(n){
  if(n===2)return validateStep2();
  if(n===3)return validateStep3();
  if(n===4){if(!document.getElementById('categoryL1').value){showError('Please select expense category');return false;}return true;}
  return true;
}
function validateStep2(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  if(vt==='One-Time')return true;
  const bank=document.getElementById('chequeBank').value,book=document.getElementById('chequeBook').value,num=document.getElementById('chequeNumber').value;
  if(!bank||!book||!num){showError('Please complete all cheque details');return false;}
  if(document.getElementById('chequeCancelled').checked&&!cancellationReasonSaved){showError('Please save the cancellation reason before proceeding');return false;}
  if(!document.getElementById('chequeCancelled').checked&&!document.getElementById('chequeDate').value){showError('Cheque date is required');return false;}
  return true;
}
function validateStep3(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  if(vt==='Registered'){if(!document.getElementById('vendorSelect').value){showError('Please select a vendor');return false;}}
  else{
    const name=document.getElementById('oneTimeVendorName').value,contact=document.getElementById('oneTimeVendorContact').value,addr=document.getElementById('oneTimeVendorAddress').value;
    if(!name||name.length<3){showError('Vendor name required (min 3 chars)');return false;}
    if(!contact||!/^[6-9][0-9]{9}$/.test(contact)){showError('Invalid mobile number');return false;}
    if(!addr||addr.length<10){showError('Address required (min 10 chars)');return false;}
  }
  return true;
}
function onVendorTypeChange(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  resetCategorySelections();chequeCancellationCounter=0;cancellationReasonSaved=false;
  document.getElementById('bankTransactionSection').classList.add('hidden');
  for(let i=2;i<=5;i++){document.getElementById('step'+i).classList.add('hidden-step');document.getElementById('step'+i).classList.remove('greyed-step');}
  document.getElementById('step1').classList.remove('greyed-step');currentStep=1;
  if(vt==='Bank Transaction'){document.getElementById('bankTransactionSection').classList.remove('hidden');initBTForm();return;}
  if(vt==='Registered'){
    if(!checkChequeAvailability()){showError('No valid cheques available!');document.querySelector('input[name="vendorType"][value="One-Time"]').checked=true;onVendorTypeChange();return;}
    document.getElementById('paymentMode').value='Cheque';
    document.getElementById('chequeDetails').classList.remove('hidden');
    document.getElementById('registeredVendorSection').classList.remove('hidden');
    document.getElementById('oneTimeVendorSection').classList.add('hidden');
    document.getElementById('tdsGstSection').classList.remove('hidden');
    populateRegisteredVendors();
  }else{
    document.getElementById('paymentMode').value='Cash';
    document.getElementById('chequeDetails').classList.add('hidden');
    document.getElementById('registeredVendorSection').classList.add('hidden');
    document.getElementById('oneTimeVendorSection').classList.remove('hidden');
    document.getElementById('tdsGstSection').classList.add('hidden');
    populateOneTimeCategories();
  }
}
function checkChequeAvailability(){
  for(const bk of MASTER_DATA.chequeBooks){
    const s=parseInt(bk.startNumber),e=parseInt(bk.endNumber);
    const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bk.startNumber+'-'+bk.endNumber).map(v=>parseInt(v.chequeNumber));
    const canc=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]').filter(c=>c.chequeBook===bk.startNumber+'-'+bk.endNumber).map(c=>parseInt(c.chequeNumber));
    const unavail=[...used,...canc];
    for(let n=s;n<=e;n++){if(!unavail.includes(n))return true;}
  }
  return false;
}
function populateRegisteredVendors(){
  const sel=document.getElementById('vendorSelect');sel.innerHTML='<option value="">Choose vendor...</option>';
  Object.keys(MASTER_DATA.vendors).filter(k=>!BANK_VENDOR_KEYS.includes(k)).sort().forEach(name=>{const o=document.createElement('option');o.value=name;o.textContent=name;sel.appendChild(o);});
}
function populateOneTimeCategories(){
  const sel=document.getElementById('categoryL1');sel.innerHTML='<option value="">Select major head...</option>';
  MASTER_DATA.categoryTree.level1.forEach(l1=>{const o=document.createElement('option');o.value=l1;o.textContent=l1;sel.appendChild(o);});
}
function populateBanks(){
  const sel=document.getElementById('chequeBank');
  MASTER_DATA.banks.forEach(b=>{const o=document.createElement('option');o.value=b.name;o.textContent=b.name;sel.appendChild(o);});
}
function onChequeBankChange(){
  const bank=document.getElementById('chequeBank').value,bsel=document.getElementById('chequeBook');
  bsel.innerHTML='<option value="">Choose cheque book...</option>';
  if(!bank){document.getElementById('chequeNumber').value='';return;}
  MASTER_DATA.chequeBooks.filter(b=>b.bankName===bank).forEach(bk=>{const o=document.createElement('option');o.value=JSON.stringify(bk);o.textContent=bk.startNumber+' - '+bk.endNumber+' ('+bk.totalLeaves+' leaves)';bsel.appendChild(o);});
}
function assignChequeNumber(){
  const bj=document.getElementById('chequeBook').value;if(!bj){document.getElementById('chequeNumber').value='';return;}
  const bk=JSON.parse(bj),s=parseInt(bk.startNumber),e=parseInt(bk.endNumber);
  const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bk.startNumber+'-'+bk.endNumber).map(v=>parseInt(v.chequeNumber));
  const canc=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]').filter(c=>c.chequeBook===bk.startNumber+'-'+bk.endNumber).map(c=>parseInt(c.chequeNumber));
  const un=[...used,...canc];
  for(let n=s;n<=e;n++){if(!un.includes(n)){document.getElementById('chequeNumber').value=n.toString().padStart(6,'0');return;}}
  showError('Cheque book exhausted.');document.getElementById('chequeNumber').value='';
}
function onChequeCancelledChange(){
  const c=document.getElementById('chequeCancelled').checked;
  document.getElementById('chequeCancelReason').classList.toggle('hidden',!c);
  document.getElementById('reasonSavedNotice').classList.add('hidden');cancellationReasonSaved=false;
}
function saveCancellationReason(){
  const r=document.getElementById('cancelReason').value.trim();if(!r){showError('Please enter a cancellation reason');return;}
  chequeCancellationCounter++;
  if(chequeCancellationCounter===2)showWarningModal('\u26a0\ufe0f CONSECUTIVE CANCELLATION','You have cancelled 2 cheques for this voucher.\nThis will be flagged in audit trail. Proceed?',completeCancellation);
  else if(chequeCancellationCounter>=3){showError('Cannot cancel more than 2 cheques.');showWarningModal('\u274c FORCE VOUCHER CANCELLATION','More than 2 cheques cancelled.\nThis voucher will be cancelled.',()=>resetVoucherForm());}
  else completeCancellation();
}
function completeCancellation(){
  cancellationReasonSaved=true;document.getElementById('reasonSavedNotice').classList.remove('hidden');
  const num=document.getElementById('chequeNumber').value,bj=document.getElementById('chequeBook').value,r=document.getElementById('cancelReason').value;
  if(bj){const bk=JSON.parse(bj),list=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]');
    list.push({chequeNumber:num,chequeBook:bk.startNumber+'-'+bk.endNumber,bankName:bk.bankName,reason:r,date:new Date().toISOString()});
    localStorage.setItem('cancelled_cheques_v221',JSON.stringify(list));}
  assignChequeNumber();document.getElementById('chequeCancelled').checked=false;
  document.getElementById('chequeCancelled').disabled=(chequeCancellationCounter>=2);
  document.getElementById('cancelReason').value='';document.getElementById('chequeCancelReason').classList.add('hidden');cancellationReasonSaved=false;
}
function onVendorChange(){
  const name=document.getElementById('vendorSelect').value;
  if(!name){document.getElementById('vendorInfo').classList.add('hidden');resetCategorySelections();return;}
  currentVendorData=MASTER_DATA.vendors[name];
  document.getElementById('v-pan').textContent=currentVendorData.pan;
  document.getElementById('v-contact').textContent=currentVendorData.contact;
  document.getElementById('v-tds').textContent=currentVendorData.tdsRate;
  document.getElementById('vendorInfo').classList.remove('hidden');
  populateVendorCategories();calculateAmounts();
}
function populateVendorCategories(){
  const paths=currentVendorData.allowedPaths,l1s=[...new Set(paths.map(p=>p.level1))];
  const sel=document.getElementById('categoryL1');sel.innerHTML='';
  if(l1s.length===1){sel.innerHTML='<option value="'+l1s[0]+'">'+l1s[0]+'</option>';sel.disabled=true;onCategoryL1Change();}
  else{sel.disabled=false;sel.innerHTML='<option value="">Select major head...</option>';l1s.sort().forEach(l1=>{const o=document.createElement('option');o.value=l1;o.textContent=l1;sel.appendChild(o);});}
}
function onCategoryL1Change(){
  const l1=document.getElementById('categoryL1').value,l2g=document.getElementById('categoryL2Group');
  const l2el=document.getElementById('categoryL2');if(l2el)l2el.value='';
  ['categoryL3Group','categoryL4Group'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(!l1){l2g.classList.add('hidden');document.getElementById('categoryPath').classList.add('hidden');return;}
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const paths=vt==='Registered'?currentVendorData.allowedPaths.filter(p=>p.level1===l1):getAllCategoryPaths().filter(p=>p.level1===l1);
  const l2s=[...new Set(paths.map(p=>p.level2))].filter(v=>v!=='None');
  if(!l2s.length){l2g.classList.add('hidden');document.getElementById('categoryPath').classList.remove('hidden');document.getElementById('categoryPathText').textContent=l1;updateCategoryGST();return;}
  const l2c=document.getElementById('categoryL2Container');
  if(l2s.length===1&&l2s[0]==='User Entry')
    l2c.innerHTML='<input type="text" id="categoryL2" placeholder="Enter Details..." oninput="onCategoryL2Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">';
  else{
    l2c.innerHTML='<select id="categoryL2" onchange="onCategoryL2Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)"><option value="">Select minor head...</option></select>';
    const s=document.getElementById('categoryL2');l2s.sort().forEach(l2=>{const o=document.createElement('option');o.value=l2;o.textContent=l2;s.appendChild(o);});
  }
  l2g.classList.remove('hidden');document.getElementById('categoryPath').classList.remove('hidden');document.getElementById('categoryPathText').textContent=l1;
}
function onCategoryL2Change(){
  const l1=document.getElementById('categoryL1').value,l2=document.getElementById('categoryL2').value;
  ['categoryL3Group','categoryL4Group'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  if(!l2){document.getElementById('categoryPathText').textContent=l1;return;}
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const paths=vt==='Registered'?currentVendorData.allowedPaths.filter(p=>p.level1===l1&&p.level2===l2):getAllCategoryPaths().filter(p=>p.level1===l1&&p.level2===l2);
  const l3s=[...new Set(paths.map(p=>p.level3))].filter(v=>v!=='None');
  if(!l3s.length){document.getElementById('categoryPathText').textContent=l1+' \u2192 '+l2;updateCategoryGST();return;}
  const l3c=document.getElementById('categoryL3Container');
  if(l3s.length===1&&l3s[0]==='User Entry'){
    l3c.innerHTML='<input type="text" id="categoryL3Input" placeholder="Enter For What Spent..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">';
    document.getElementById('categoryL3Input').addEventListener('change',onCategoryL3InputChange);
  }else{
    l3c.innerHTML='<select id="categoryL3Select" onchange="onCategoryL3Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)"><option value="">Select...</option></select>';
    const s=document.getElementById('categoryL3Select');l3s.sort().forEach(l3=>{const o=document.createElement('option');o.value=l3;o.textContent=l3;s.appendChild(o);});
  }
  document.getElementById('categoryL3Group').classList.remove('hidden');document.getElementById('categoryPathText').textContent=l1+' \u2192 '+l2;
}
function onCategoryL3InputChange(){
  const l1=document.getElementById('categoryL1').value,l2=document.getElementById('categoryL2').value,l3=document.getElementById('categoryL3Input').value;
  if(l3){document.getElementById('categoryPathText').textContent=l1+' \u2192 '+l2+' \u2192 '+l3;showL4IfNeeded(l1,l2,'User Entry');}
  updateCategoryGST();
}
function onCategoryL3Change(){
  const l1=document.getElementById('categoryL1').value,l2=document.getElementById('categoryL2').value;
  const l3s=document.getElementById('categoryL3Select'),l3=l3s?l3s.value:'';
  document.getElementById('categoryL4Group').classList.add('hidden');
  if(!l3){document.getElementById('categoryPathText').textContent=l1+' \u2192 '+l2;return;}
  document.getElementById('categoryPathText').textContent=l1+' \u2192 '+l2+' \u2192 '+l3;
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const paths=vt==='Registered'?currentVendorData.allowedPaths.filter(p=>p.level1===l1&&p.level2===l2&&p.level3===l3):getAllCategoryPaths().filter(p=>p.level1===l1&&p.level2===l2&&p.level3===l3);
  const l4s=[...new Set(paths.map(p=>p.level4))].filter(v=>v!=='None');
  if(l4s.length===1&&l4s[0]==='User Entry'){
    document.getElementById('categoryL4Container').innerHTML='<input type="text" id="categoryL4Input" placeholder="Enter Details..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">';
    document.getElementById('categoryL4Group').classList.remove('hidden');
  }
  updateCategoryGST();
}
function showL4IfNeeded(l1,l2,l3){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const paths=vt==='Registered'?currentVendorData.allowedPaths.filter(p=>p.level1===l1&&p.level2===l2&&p.level3===l3):getAllCategoryPaths().filter(p=>p.level1===l1&&p.level2===l2&&p.level3===l3);
  const l4s=[...new Set(paths.map(p=>p.level4))].filter(v=>v!=='None');
  if(l4s.length===1&&l4s[0]==='User Entry'){
    document.getElementById('categoryL4Container').innerHTML='<input type="text" id="categoryL4Input" placeholder="Enter Details..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">';
    document.getElementById('categoryL4Group').classList.remove('hidden');
  }
}
function getAllCategoryPaths(){const p=[];Object.values(MASTER_DATA.vendors).forEach(v=>p.push(...v.allowedPaths));return p;}
function updateCategoryGST(){
  const l1=document.getElementById('categoryL1').value;
  const l2el=document.getElementById('categoryL2');const l2=l2el?l2el.value||'None':'None';
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  if(vt==='One-Time'){currentCategoryGST=0;calculateAmounts();return;}
  let l3='None';const l3in=document.getElementById('categoryL3Input'),l3sel=document.getElementById('categoryL3Select');
  if(l3in&&l3in.value)l3='User Entry';else if(l3sel&&l3sel.value)l3=l3sel.value;
  const p=currentVendorData?currentVendorData.allowedPaths.find(p=>p.level1===l1&&p.level2===l2&&(p.level3===l3||(l3==='None'&&p.level3==='None'))):null;
  currentCategoryGST=p?p.gstRate:0;calculateAmounts();
}
function resetCategorySelections(){
  const c=document.getElementById('categoryL1');if(c){c.innerHTML='<option value="">Select major head...</option>';c.disabled=false;}
  const l2c=document.getElementById('categoryL2Container');
  if(l2c)l2c.innerHTML='<select id="categoryL2" onchange="onCategoryL2Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)"><option value="">Select minor head...</option></select>';
  ['categoryL2Group','categoryL3Group','categoryL4Group','categoryPath'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
}
function calculateAmounts(){
  const inv=parseFloat(document.getElementById('invoiceAmount').value)||0;
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  if(vt==='One-Time'){
    document.getElementById('breakdown-invoice').textContent='\u20b9'+inv.toLocaleString('en-IN');
    document.getElementById('breakdown-tds-rate').textContent=0;document.getElementById('breakdown-tds').textContent='\u20b90';
    document.getElementById('breakdown-gst-rate').textContent=0;document.getElementById('breakdown-gst').textContent='\u20b90';
    document.getElementById('breakdown-net').textContent='\u20b9'+inv.toLocaleString('en-IN');return;
  }
  const tr=currentVendorData?currentVendorData.tdsRate:0,gr=currentCategoryGST;
  const tds=Math.round(inv*tr/100),gst=Math.round(inv*gr/100),net=inv-tds+gst;
  document.getElementById('tdsAmount').value=tds;document.getElementById('gstAmount').value=gst;
  document.getElementById('breakdown-invoice').textContent='\u20b9'+inv.toLocaleString('en-IN');
  document.getElementById('breakdown-tds-rate').textContent=tr;document.getElementById('breakdown-tds').textContent='\u20b9'+tds.toLocaleString('en-IN');
  document.getElementById('breakdown-gst-rate').textContent=gr;document.getElementById('breakdown-gst').textContent='\u20b9'+gst.toLocaleString('en-IN');
  document.getElementById('breakdown-net').textContent='\u20b9'+net.toLocaleString('en-IN');
}
function roundAmount(){const i=document.getElementById('invoiceAmount');if(i.value){i.value=Math.round(parseFloat(i.value));calculateAmounts();}}

// ── SAVE VOUCHER ──
function saveVoucher(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  if(vt==='Bank Transaction'){saveBTVoucher();return;}
  if(!validateSave())return;
  const vnum=document.getElementById('stickyVoucherNumber').value,vdate=document.getElementById('stickyVoucherDate').value;
  const inv=parseFloat(document.getElementById('invoiceAmount').value)||0;
  const tr=vt==='Registered'&&currentVendorData?currentVendorData.tdsRate:0;
  const tds=Math.round(inv*tr/100),gst=Math.round(inv*currentCategoryGST/100),net=inv-tds+gst;
  const l1=document.getElementById('categoryL1').value;
  const l2el=document.getElementById('categoryL2');const l2=l2el?l2el.value||'':' ';
  const l3in=document.getElementById('categoryL3Input'),l3sel=document.getElementById('categoryL3Select');
  const l3=l3in?l3in.value:(l3sel?l3sel.value:'');
  const l4in=document.getElementById('categoryL4Input');const l4=l4in?l4in.value:'';
  const voucher={id:'V'+Date.now(),voucherNumber:vnum,date:vdate,vendorType:vt,
    vendorName:vt==='Registered'?document.getElementById('vendorSelect').value:'',
    oneTimeVendorName:vt==='One-Time'?document.getElementById('oneTimeVendorName').value:'',
    oneTimeContact:vt==='One-Time'?document.getElementById('oneTimeVendorContact').value:'',
    oneTimeAddress:vt==='One-Time'?document.getElementById('oneTimeVendorAddress').value:'',
    paymentMode:document.getElementById('paymentMode').value,
    chequeBank:vt==='Registered'?document.getElementById('chequeBank').value:'',
    chequeBook:vt==='Registered'?getChequeBookStr():'',
    chequeNumber:vt==='Registered'?document.getElementById('chequeNumber').value:'',
    chequeDate:vt==='Registered'?document.getElementById('chequeDate').value:'',
    categoryL1:l1,categoryL2:l2,categoryL3:l3,categoryL4:l4,gstRate:currentCategoryGST,
    invoiceAmount:inv,tdsAmount:tds,gstAmount:gst,netAmount:net,
    invoiceNumber:document.getElementById('invoiceNumber').value,
    description:document.getElementById('description').value,
    status:'Prepared',editCount:0,createdBy:CURRENT_USER,createdAt:new Date().toISOString()};
  vouchers.push(voucher);saveVouchers();showSuccess('\u2714\ufe0f Voucher '+vnum+' saved!');
  resetVoucherForm();generateVoucherNumber();renderVouchers();
}
function getChequeBookStr(){
  const bj=document.getElementById('chequeBook').value;
  if(!bj)return'';const bk=JSON.parse(bj);return bk.startNumber+'-'+bk.endNumber;
}
function validateSave(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const inv=parseFloat(document.getElementById('invoiceAmount').value)||0;
  const invN=document.getElementById('invoiceNumber').value;
  if(inv<1){showError('Invoice amount must be at least \u20b91');return false;}
  if(!invN||invN.length<3||!/[1-9]/.test(invN)){showError('Invoice number must contain at least one digit from 1 to 9 (min 3 chars)');return false;}
  if(!document.getElementById('categoryL1').value){showError('Please select expense category');return false;}
  return true;
}
function resetVoucherForm(){
  document.getElementById('voucherForm').reset();currentVendorData=null;currentCategoryGST=0;
  chequeCancellationCounter=0;cancellationReasonSaved=false;currentStep=1;
  document.getElementById('stickyHeader').classList.add('show-header');
  document.getElementById('bankTransactionSection').classList.add('hidden');
  for(let i=2;i<=5;i++){document.getElementById('step'+i).classList.add('hidden-step');document.getElementById('step'+i).classList.remove('greyed-step');}
  document.getElementById('step1').classList.remove('greyed-step');
  resetCategorySelections();document.getElementById('vendorInfo').classList.add('hidden');
  document.getElementById('chequeCancelReason').classList.add('hidden');document.getElementById('reasonSavedNotice').classList.add('hidden');
  setTodayDate();onVendorTypeChange();
}

// ── BANK TRANSACTION FUNCTIONS ──
function initBTForm(){
  currentBTStep=1;btIssuesCheque=false;btChequeCancellationCounter=0;btCancellationReasonSaved=false;
  for(let i=1;i<=4;i++){const s=document.getElementById('bt-step'+i);if(s){s.classList.remove('greyed-step');if(i>1)s.classList.add('hidden-step');else s.classList.remove('hidden-step');}}
  const sel=document.getElementById('bt-bankSelect');sel.innerHTML='<option value="">Choose bank...</option>';
  MASTER_DATA.banks.forEach(b=>{const o=document.createElement('option');o.value=b.name;o.textContent=b.name;sel.appendChild(o);});
  document.getElementById('bt-chequeQuestion').classList.add('hidden');
  document.getElementById('bt-chequeDetails').classList.add('hidden');
  document.getElementById('bt-chequeCancelReason').classList.add('hidden');
  document.getElementById('bt-reasonSavedNotice').classList.add('hidden');
  currentBTBank=null;
}
function onBTBankChange(){
  currentBTBank=document.getElementById('bt-bankSelect').value;
  document.getElementById('bt-chequeQuestion').classList.toggle('hidden',!currentBTBank);
  document.querySelectorAll('input[name="btChequeYN"][value="no"]').forEach(r=>r.checked=true);
  document.getElementById('bt-chequeDetails').classList.add('hidden');
}
function onBTChequeChoice(isYes){
  btIssuesCheque=isYes;document.getElementById('bt-chequeDetails').classList.toggle('hidden',!isYes);
  if(isYes)populateBTChequeBooks();
}
function populateBTChequeBooks(){
  const sel=document.getElementById('bt-chequeBook');sel.innerHTML='<option value="">Choose cheque book...</option>';
  if(!currentBTBank)return;
  MASTER_DATA.chequeBooks.filter(b=>b.bankName===currentBTBank).forEach(bk=>{
    const o=document.createElement('option');o.value=JSON.stringify(bk);o.textContent=bk.startNumber+' - '+bk.endNumber+' ('+bk.totalLeaves+' leaves)';sel.appendChild(o);});
}
function assignBTChequeNumber(){
  const bj=document.getElementById('bt-chequeBook').value;if(!bj){document.getElementById('bt-chequeNumber').value='';return;}
  const bk=JSON.parse(bj),s=parseInt(bk.startNumber),e=parseInt(bk.endNumber);
  const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bk.startNumber+'-'+bk.endNumber).map(v=>parseInt(v.chequeNumber));
  const canc=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]').filter(c=>c.chequeBook===bk.startNumber+'-'+bk.endNumber).map(c=>parseInt(c.chequeNumber));
  const un=[...used,...canc];
  for(let n=s;n<=e;n++){if(!un.includes(n)){document.getElementById('bt-chequeNumber').value=n.toString().padStart(6,'0');return;}}
  showError('Cheque book exhausted.');document.getElementById('bt-chequeNumber').value='';
}
function onBTChequeCancelledChange(){
  const c=document.getElementById('bt-chequeCancelled').checked;
  document.getElementById('bt-chequeCancelReason').classList.toggle('hidden',!c);
  document.getElementById('bt-reasonSavedNotice').classList.add('hidden');btCancellationReasonSaved=false;
}
function saveBTCancellationReason(){
  const r=document.getElementById('bt-cancelReason').value.trim();if(!r){showError('Enter cancellation reason');return;}
  btChequeCancellationCounter++;
  if(btChequeCancellationCounter>=3){showError('Cannot cancel more than 2 cheques.');showWarningModal('\u274c FORCE CANCEL','Too many cancellations.',()=>resetBTForm());return;}
  const num=document.getElementById('bt-chequeNumber').value,bj=document.getElementById('bt-chequeBook').value;
  if(bj){const bk=JSON.parse(bj),list=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]');
    list.push({chequeNumber:num,chequeBook:bk.startNumber+'-'+bk.endNumber,bankName:bk.bankName,reason:r,date:new Date().toISOString()});
    localStorage.setItem('cancelled_cheques_v221',JSON.stringify(list));}
  btCancellationReasonSaved=true;document.getElementById('bt-reasonSavedNotice').classList.remove('hidden');
  document.getElementById('bt-chequeCancelled').disabled=true;document.getElementById('bt-chequeCancelled').checked=false;
  document.getElementById('bt-chequeCancelReason').classList.add('hidden');
  assignBTChequeNumber();
  if(btChequeCancellationCounter===2)showWarningModal('\u26a0\ufe0f WARNING','2 cheques cancelled for this transaction. Proceed?',()=>{});
}
function getBTCategoriesForBank(bankName){
  const cats=new Set();
  Object.entries(MASTER_DATA.vendors).forEach(([k,v])=>{
    if(v.bankName===bankName||k===bankName||k==='Self -'+bankName.split(' ')[0]+' '+bankName.split(' ')[1]+' Bank'||
       (bankName==='Bharat Cooperative Bank'&&(k==='Bharat Cooperative Bank'||k==='Self -BCB Bank'))||
       (bankName==='FJKL Pvt Bank'&&(k==='FJKL Pvt Bank'||k==='Self -FJKL Bank'))){
      v.allowedPaths.forEach(p=>cats.add(p.level1));}});
  return [...cats];
}
function onBTCatL1Change(){
  const l1=document.getElementById('bt-categoryL1').value;
  ['bt-catL2Group','bt-catL3Group','bt-catL4Group'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('bt-categoryPath').classList.toggle('hidden',!l1);
  if(!l1)return;
  document.getElementById('bt-categoryPathText').textContent=l1;
  const l2g=document.getElementById('bt-catL2Group');
  if(l1==='Petty Cash Withdrawal'){
    document.getElementById('bt-catL2Label').textContent='Details (L2)';
    document.getElementById('bt-categoryL2').placeholder='Enter Details...';l2g.classList.remove('hidden');
    return;
  }
  document.getElementById('bt-catL2Label').textContent='Details (L2)';
  document.getElementById('bt-categoryL2').placeholder='Enter Details...';l2g.classList.remove('hidden');
  document.getElementById('bt-catL3Group').classList.remove('hidden');document.getElementById('bt-catL4Group').classList.remove('hidden');
}
function completeBTStep(n){
  if(!validateBTStep(n))return;
  document.getElementById('bt-step'+n).classList.add('greyed-step');
  const next=document.getElementById('bt-step'+(n+1));if(next){next.classList.remove('hidden-step');currentBTStep=n+1;}
  if(n===3)populateBTStep4Summary();
}
function validateBTStep(n){
  if(n===1){
    if(!currentBTBank){showError('Select a bank');return false;}
    if(btIssuesCheque){
      if(!document.getElementById('bt-chequeBook').value){showError('Select cheque book');return false;}
      if(!document.getElementById('bt-chequeNumber').value){showError('No cheque number assigned');return false;}
      if(!document.getElementById('bt-chequeDate').value){showError('Cheque date required');return false;}
      if(document.getElementById('bt-chequeCancelled').checked&&!btCancellationReasonSaved){showError('Save cancellation reason first');return false;}
    }
    const l1sel=document.getElementById('bt-categoryL1');l1sel.innerHTML='<option value="">Select category...</option>';
    getBTCategoriesForBank(currentBTBank).forEach(cat=>{const o=document.createElement('option');o.value=cat;o.textContent=cat;l1sel.appendChild(o);});
    return true;
  }
  if(n===2){if(!document.getElementById('bt-categoryL1').value){showError('Select transaction category');return false;}return true;}
  if(n===3){
    const ref=document.getElementById('bt-referenceNumber').value;
    if(!ref||ref.length<3||!/[1-9]/.test(ref)){showError('Reference number: min 3 chars, must contain digit 1-9');return false;}
    const amt=parseFloat(document.getElementById('bt-transactionAmount').value)||0;
    if(amt<1){showError('Transaction amount must be at least \u20b91');return false;}
    return true;
  }
  return true;
}
function calculateBTNet(){
  const txn=parseFloat(document.getElementById('bt-transactionAmount').value)||0;
  const gst=parseFloat(document.getElementById('bt-gstAmount').value)||0;
  const net=txn+gst;
  document.getElementById('bt-breakdown-txn').textContent='\u20b9'+txn.toLocaleString('en-IN');
  document.getElementById('bt-breakdown-gst').textContent='\u20b9'+gst.toLocaleString('en-IN');
  document.getElementById('bt-breakdown-net').textContent='\u20b9'+net.toLocaleString('en-IN');
}
function populateBTStep4Summary(){
  const l1=document.getElementById('bt-categoryL1').value;
  const l2=document.getElementById('bt-categoryL2').value;
  const l3=document.getElementById('bt-categoryL3').value;
  const l4=document.getElementById('bt-categoryL4').value;
  const ref=document.getElementById('bt-referenceNumber').value;
  const txn=parseFloat(document.getElementById('bt-transactionAmount').value)||0;
  const gst=parseFloat(document.getElementById('bt-gstAmount').value)||0;
  const net=txn+gst;
  const payMode=btIssuesCheque?'Cheque ('+document.getElementById('bt-chequeNumber').value+')':'Bank Debit/Credit';
  let html='<table style="width:100%;font-size:14px"><tbody>';
  html+='<tr><td style="width:40%;font-weight:600;padding:6px">Bank:</td><td style="padding:6px">'+currentBTBank+'</td></tr>';
  html+='<tr><td style="font-weight:600;padding:6px">Payment Mode:</td><td style="padding:6px">'+payMode+'</td></tr>';
  html+='<tr><td style="font-weight:600;padding:6px">Category L1:</td><td style="padding:6px">'+l1+'</td></tr>';
  if(l2)html+='<tr><td style="font-weight:600;padding:6px">Category L2:</td><td style="padding:6px">'+l2+'</td></tr>';
  if(l3)html+='<tr><td style="font-weight:600;padding:6px">Category L3:</td><td style="padding:6px">'+l3+'</td></tr>';
  if(l4)html+='<tr><td style="font-weight:600;padding:6px">Category L4:</td><td style="padding:6px">'+l4+'</td></tr>';
  html+='<tr><td style="font-weight:600;padding:6px">Reference Number:</td><td style="padding:6px">'+ref+'</td></tr>';
  html+='<tr><td style="font-weight:600;padding:6px">Transaction Amount:</td><td style="padding:6px">\u20b9'+txn.toLocaleString('en-IN')+'</td></tr>';
  html+='<tr><td style="font-weight:600;padding:6px">GST Amount:</td><td style="padding:6px">\u20b9'+gst.toLocaleString('en-IN')+'</td></tr>';
  html+='<tr style="background:var(--bg-input)"><td style="font-weight:700;padding:6px;color:var(--primary)">Net Amount:</td><td style="font-weight:700;padding:6px;color:var(--primary)">\u20b9'+net.toLocaleString('en-IN')+'</td></tr>';
  html+='</tbody></table>';
  document.getElementById('bt-step4Summary').innerHTML=html;
}
function saveBTVoucher(){
  const l1=document.getElementById('bt-categoryL1').value;
  const l2=document.getElementById('bt-categoryL2').value;
  const l3=document.getElementById('bt-categoryL3')?document.getElementById('bt-categoryL3').value:'';
  const l4=document.getElementById('bt-categoryL4')?document.getElementById('bt-categoryL4').value:'';
  const ref=document.getElementById('bt-referenceNumber').value;
  const txn=parseFloat(document.getElementById('bt-transactionAmount').value)||0;
  const gst=parseFloat(document.getElementById('bt-gstAmount').value)||0;
  const vnum=document.getElementById('stickyVoucherNumber').value,vdate=document.getElementById('stickyVoucherDate').value;
  const payMode=btIssuesCheque?'Cheque':'Bank Debit/Credit';
  const voucher={id:'V'+Date.now(),voucherNumber:vnum,date:vdate,vendorType:'Bank Transaction',
    bankName:currentBTBank,paymentMode:payMode,
    chequeBook:btIssuesCheque?getChequeBookStrBT():'',
    chequeNumber:btIssuesCheque?document.getElementById('bt-chequeNumber').value:'',
    chequeDate:btIssuesCheque?document.getElementById('bt-chequeDate').value:'',
    categoryL1:l1,categoryL2:l2,categoryL3:l3,categoryL4:l4,
    invoiceNumber:ref,transactionAmount:txn,gstAmount:gst,netAmount:txn+gst,
    invoiceAmount:txn,tdsAmount:0,gstRate:0,description:document.getElementById('bt-description').value,
    status:'Prepared',editCount:0,createdBy:CURRENT_USER,createdAt:new Date().toISOString()};
  vouchers.push(voucher);saveVouchers();showSuccess('\u2714\ufe0f Bank Transaction '+vnum+' saved!');
  resetBTForm();generateVoucherNumber();renderVouchers();
}
function getChequeBookStrBT(){
  const bj=document.getElementById('bt-chequeBook').value;if(!bj)return'';const bk=JSON.parse(bj);return bk.startNumber+'-'+bk.endNumber;
}
function resetBTForm(){initBTForm();}

// ── PREVIEW/MODIFY MODAL ──
function openPreviewModal(ctx){
  previewContext=ctx;
  const modal=document.getElementById('previewVoucherModal');
  if(ctx==='standard'){if(!validateSave())return;buildPreviewModalContent();}
  else{buildBTPreviewModalContent();}
  modal.classList.add('active');
}
function buildPreviewModalContent(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const inv=parseFloat(document.getElementById('invoiceAmount').value)||0;
  const l1=document.getElementById('categoryL1').value;
  const l2el=document.getElementById('categoryL2');const l2=l2el?l2el.value:'';
  const l3in=document.getElementById('categoryL3Input'),l3sel=document.getElementById('categoryL3Select');
  const l3=l3in?l3in.value:(l3sel?l3sel.value:'');
  const l4in=document.getElementById('categoryL4Input');const l4=l4in?l4in.value:'';
  const curVendorName=vt==='Registered'?document.getElementById('vendorSelect').value:'';
  const curChequeBank=vt==='Registered'?document.getElementById('chequeBank').value:'';
  const curChequeBook=vt==='Registered'?document.getElementById('chequeBook').value:'';
  const curChequeNum=vt==='Registered'?document.getElementById('chequeNumber').value:'';
  const curChequeDate=vt==='Registered'?document.getElementById('chequeDate').value:'';
  const tr=currentVendorData?currentVendorData.tdsRate:0;
  const tds=Math.round(inv*tr/100),gst=Math.round(inv*currentCategoryGST/100),net=inv-tds+gst;

  let html='<div class="alert alert-info" style="margin-bottom:16px">\u2139\ufe0f All fields are editable. Modify as needed, then click Save Voucher.</div>';
  html+='<div class="pm-section"><div class="pm-section-title">Voucher Info</div><div class="pm-row">';
  html+='<div class="form-group"><label>Voucher Date</label><input id="pm-date" type="date" value="'+document.getElementById('stickyVoucherDate').value+'"></div>';
  html+='<div class="form-group"><label>Voucher No.</label><input id="pm-vnum" type="text" value="'+document.getElementById('stickyVoucherNumber').value+'" readonly></div>';
  html+='<div class="form-group"><label>Vendor Type</label><input value="'+vt+'" readonly></div>';
  html+='</div></div>';

  if(vt==='Registered'){
    // Vendor dropdown
    let vOpts='<option value="">Choose vendor...</option>';
    Object.keys(MASTER_DATA.vendors).filter(k=>!BANK_VENDOR_KEYS.includes(k)).sort().forEach(n=>{vOpts+='<option value="'+n+'"'+(n===curVendorName?' selected':'')+'>'+n+'</option>';});
    html+='<div class="pm-section"><div class="pm-section-title">Vendor</div><div class="pm-row">';
    html+='<div class="form-group"><label>Vendor</label><select id="pm-vendor" onchange="pmOnVendorChange()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+vOpts+'</select></div>';
    // Bank dropdown
    let bOpts='<option value="">Choose bank...</option>';
    MASTER_DATA.banks.forEach(b=>{bOpts+='<option value="'+b.name+'"'+(b.name===curChequeBank?' selected':'')+'>'+b.name+'</option>';});
    html+='<div class="form-group"><label>Bank</label><select id="pm-bank" onchange="pmOnBankChange()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+bOpts+'</select></div>';
    // Cheque Book dropdown
    let cbOpts='<option value="">Choose cheque book...</option>';
    MASTER_DATA.chequeBooks.filter(b=>b.bankName===curChequeBank).forEach(bk=>{const sel=JSON.stringify(bk)===curChequeBook;cbOpts+='<option value="'+escHtml(JSON.stringify(bk))+'"'+(sel?' selected':'')+'>'+bk.startNumber+' - '+bk.endNumber+' ('+bk.totalLeaves+' leaves)</option>';});
    html+='<div class="form-group"><label>Cheque Book</label><select id="pm-chequebook" onchange="pmAssignChequeNumber()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+cbOpts+'</select></div>';
    html+='<div class="form-group"><label>Cheque Number</label><input id="pm-chequenum" value="'+curChequeNum+'" readonly style="background:#e8f0ed"></div>';
    html+='<div class="form-group"><label>Cheque Date</label><input id="pm-chequedate" type="date" value="'+curChequeDate+'"></div>';
    html+='</div></div>';
    // Category section with dropdowns
    html+='<div class="pm-section"><div class="pm-section-title">Category</div>';
    html+='<div class="pm-row" id="pm-cat-row">';
    // L1 dropdown
    const vd=MASTER_DATA.vendors[curVendorName];
    const l1s=vd?[...new Set(vd.allowedPaths.map(p=>p.level1))]:[];
    let l1Opts='<option value="">Select major head...</option>';
    l1s.sort().forEach(v=>{l1Opts+='<option value="'+v+'"'+(v===l1?' selected':'')+'>'+v+'</option>';});
    html+='<div class="form-group" id="pm-l1-group"><label>Major Head (L1)</label><select id="pm-l1" onchange="pmOnL1Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+l1Opts+'</select></div>';
    html+='<div id="pm-l2-group" style="display:none" class="form-group"><label>Minor Head (L2)</label><div id="pm-l2-container"></div></div>';
    html+='<div id="pm-l3-group" style="display:none" class="form-group"><label>Why Spent (L3)</label><div id="pm-l3-container"></div></div>';
    html+='<div id="pm-l4-group" style="display:none" class="form-group"><label>Spent For (L4)</label><div id="pm-l4-container"></div></div>';
    html+='</div></div>';
  } else {
    // One-Time: simple fields
    html+='<div class="pm-section"><div class="pm-section-title">Vendor</div><div class="pm-row">';
    html+='<div class="form-group"><label>Vendor Name</label><input id="pm-ot-name" value="'+escHtml(document.getElementById('oneTimeVendorName').value)+'"></div>';
    html+='</div></div>';
    // Category (simple inputs for one-time)
    const showL2=l2&&l2.trim()&&l2!=='None';
    const showL3=l3&&l3.trim()&&l3!=='None';
    const showL4=l4&&l4.trim()&&l4!=='None';
    html+='<div class="pm-section"><div class="pm-section-title">Category</div><div class="pm-row">';
    html+='<div class="form-group"><label>Major Head (L1)</label><input id="pm-l1" value="'+escHtml(l1)+'" readonly></div>';
    if(showL2)html+='<div class="form-group"><label>Minor Head (L2)</label><input id="pm-l2" value="'+escHtml(l2)+'"></div>';
    if(showL3)html+='<div class="form-group"><label>Why Spent (L3)</label><input id="pm-l3" value="'+escHtml(l3)+'"></div>';
    if(showL4)html+='<div class="form-group"><label>Spent For (L4)</label><input id="pm-l4" value="'+escHtml(l4)+'"></div>';
    html+='</div></div>';
  }

  html+='<div class="pm-section"><div class="pm-section-title">Invoice & Amounts</div><div class="pm-row">';
  html+='<div class="form-group"><label>Invoice Amount (\u20b9)</label><input id="pm-invamt" type="number" value="'+inv+'" onchange="recalcPMAmounts()"></div>';
  html+='<div class="form-group"><label>Invoice Number</label><input id="pm-invnum" value="'+escHtml(document.getElementById('invoiceNumber').value)+'"></div>';
  html+='<div class="form-group"><label>TDS Amount</label><input id="pm-tds" value="'+tds+'" readonly></div>';
  html+='<div class="form-group"><label>GST Amount</label><input id="pm-gst" value="'+gst+'" readonly></div>';
  html+='<div class="form-group"><label style="color:var(--primary);font-weight:700">Net Amount (\u20b9)</label><input id="pm-net" value="'+net+'" readonly style="font-weight:700;color:var(--primary)"></div>';
  html+='<div class="form-group"><label>Description</label><input id="pm-desc" value="'+escHtml(document.getElementById('description').value)+'"></div>';
  html+='</div></div>';

  document.getElementById('previewVoucherBody').innerHTML=html;

  // After rendering, populate L2/L3/L4 with current values if Registered
  if(vt==='Registered'){
    window._pmL2Val=l2;window._pmL3Val=l3;window._pmL4Val=l4;
    if(l1)pmOnL1Change();
  }
}

// ── PREVIEW MODAL HELPER FUNCTIONS ──
function pmOnVendorChange(){
  const name=document.getElementById('pm-vendor').value;
  window._pmVendorData=name?MASTER_DATA.vendors[name]:null;
  window._pmCategoryGST=0;
  // Reset L1 dropdown for new vendor
  const vd=window._pmVendorData;const l1s=vd?[...new Set(vd.allowedPaths.map(p=>p.level1))]:[];
  const l1sel=document.getElementById('pm-l1');
  l1sel.innerHTML='<option value="">Select major head...</option>';
  l1s.sort().forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;l1sel.appendChild(o);});
  document.getElementById('pm-l2-group').style.display='none';
  document.getElementById('pm-l3-group').style.display='none';
  document.getElementById('pm-l4-group').style.display='none';
  recalcPMAmounts();
}
function pmOnBankChange(){
  const bank=document.getElementById('pm-bank').value;
  const cbSel=document.getElementById('pm-chequebook');
  cbSel.innerHTML='<option value="">Choose cheque book...</option>';
  if(!bank)return;
  MASTER_DATA.chequeBooks.filter(b=>b.bankName===bank).forEach(bk=>{
    const o=document.createElement('option');o.value=JSON.stringify(bk);o.textContent=bk.startNumber+' - '+bk.endNumber+' ('+bk.totalLeaves+' leaves)';cbSel.appendChild(o);});
  document.getElementById('pm-chequenum').value='';
}
function pmAssignChequeNumber(){
  const bj=document.getElementById('pm-chequebook').value;
  if(!bj){document.getElementById('pm-chequenum').value='';return;}
  const bk=JSON.parse(bj),s=parseInt(bk.startNumber),e=parseInt(bk.endNumber);
  const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bk.startNumber+'-'+bk.endNumber).map(v=>parseInt(v.chequeNumber));
  const canc=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]').filter(c=>c.chequeBook===bk.startNumber+'-'+bk.endNumber).map(c=>parseInt(c.chequeNumber));
  const un=[...used,...canc];
  for(let n=s;n<=e;n++){if(!un.includes(n)){document.getElementById('pm-chequenum').value=n.toString().padStart(6,'0');return;}}
  document.getElementById('pm-chequenum').value='';showError('Cheque book exhausted.');
}
function pmOnL1Change(){
  const l1sel=document.getElementById('pm-l1');if(!l1sel)return;
  const l1=l1sel.value;
  const vd=window._pmVendorData||(currentVendorData);
  document.getElementById('pm-l2-group').style.display='none';
  document.getElementById('pm-l3-group').style.display='none';
  document.getElementById('pm-l4-group').style.display='none';
  window._pmCategoryGST=0;
  if(!l1||!vd){recalcPMAmounts();return;}
  const paths=vd.allowedPaths.filter(p=>p.level1===l1);
  const l2s=[...new Set(paths.map(p=>p.level2))].filter(v=>v!=='None');
  if(!l2s.length){const mp=paths[0];if(mp)window._pmCategoryGST=mp.gstRate;recalcPMAmounts();return;}
  const l2c=document.getElementById('pm-l2-container');
  const prevL2=window._pmL2Val||'';window._pmL2Val='';
  if(l2s.length===1&&l2s[0]==='User Entry'){
    l2c.innerHTML='<input type="text" id="pm-l2" value="'+(prevL2!=='None'?escHtml(prevL2):'')+'" placeholder="Enter Details..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)" oninput="pmOnL2Change()">';
  } else {
    let opts='<option value="">Select minor head...</option>';
    l2s.sort().forEach(v=>{opts+='<option value="'+v+'"'+(v===prevL2?' selected':'')+'>'+v+'</option>';});
    l2c.innerHTML='<select id="pm-l2" onchange="pmOnL2Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+opts+'</select>';
  }
  document.getElementById('pm-l2-group').style.display='';
  // if prev L2 was selected, trigger L2 change
  const l2el=document.getElementById('pm-l2');
  if(l2el&&l2el.value&&l2el.value!=='None')pmOnL2Change();
  else recalcPMAmounts();
}
function pmOnL2Change(){
  const l1el=document.getElementById('pm-l1'),l2el=document.getElementById('pm-l2');
  if(!l1el||!l2el)return;
  const l1=l1el.value,l2=l2el.value;
  const vd=window._pmVendorData||(currentVendorData);
  document.getElementById('pm-l3-group').style.display='none';
  document.getElementById('pm-l4-group').style.display='none';
  if(!l2||!vd){recalcPMAmounts();return;}
  const paths=vd.allowedPaths.filter(p=>p.level1===l1&&p.level2===l2);
  if(paths.length)window._pmCategoryGST=paths[0].gstRate;
  const l3s=[...new Set(paths.map(p=>p.level3))].filter(v=>v!=='None');
  if(!l3s.length){recalcPMAmounts();return;}
  const l3c=document.getElementById('pm-l3-container');
  const prevL3=window._pmL3Val||'';window._pmL3Val='';
  if(l3s.length===1&&l3s[0]==='User Entry'){
    l3c.innerHTML='<input type="text" id="pm-l3" value="'+(prevL3!=='None'?escHtml(prevL3):'')+'" placeholder="Enter For What Spent..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)" oninput="pmOnL3Change()">';
  } else {
    let opts='<option value="">Select...</option>';
    l3s.sort().forEach(v=>{opts+='<option value="'+v+'"'+(v===prevL3?' selected':'')+'>'+v+'</option>';});
    l3c.innerHTML='<select id="pm-l3" onchange="pmOnL3Change()" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+opts+'</select>';
  }
  document.getElementById('pm-l3-group').style.display='';
  const l3el=document.getElementById('pm-l3');
  if(l3el&&l3el.value&&l3el.value!=='None')pmOnL3Change();
  else recalcPMAmounts();
}
function pmOnL3Change(){
  const l1el=document.getElementById('pm-l1'),l2el=document.getElementById('pm-l2'),l3el=document.getElementById('pm-l3');
  if(!l1el||!l2el||!l3el)return;
  const l1=l1el.value,l2=l2el.value,l3=l3el.value;
  const vd=window._pmVendorData||(currentVendorData);
  document.getElementById('pm-l4-group').style.display='none';
  if(!l3||!vd){recalcPMAmounts();return;}
  const paths=vd.allowedPaths.filter(p=>p.level1===l1&&p.level2===l2&&p.level3===l3);
  if(paths.length)window._pmCategoryGST=paths[0].gstRate;
  const l4s=[...new Set(paths.map(p=>p.level4))].filter(v=>v!=='None');
  if(!l4s.length){recalcPMAmounts();return;}
  const l4c=document.getElementById('pm-l4-container');
  const prevL4=window._pmL4Val||'';window._pmL4Val='';
  if(l4s.length===1&&l4s[0]==='User Entry'){
    l4c.innerHTML='<input type="text" id="pm-l4" value="'+(prevL4!=='None'?escHtml(prevL4):'')+'" placeholder="Enter Details..." style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">';
  } else {
    let opts='<option value="">Select...</option>';
    l4s.sort().forEach(v=>{opts+='<option value="'+v+'"'+(v===prevL4?' selected':'')+'>'+v+'</option>';});
    l4c.innerHTML='<select id="pm-l4" style="padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;width:100%;background:var(--bg-card)">'+opts+'</select>';
  }
  document.getElementById('pm-l4-group').style.display='';
  recalcPMAmounts();
}
function buildBTPreviewModalContent(){
  const l1=document.getElementById('bt-categoryL1').value;
  const l2=document.getElementById('bt-categoryL2').value;
  const l3=document.getElementById('bt-categoryL3')?document.getElementById('bt-categoryL3').value:'';
  const l4=document.getElementById('bt-categoryL4')?document.getElementById('bt-categoryL4').value:'';
  const txn=parseFloat(document.getElementById('bt-transactionAmount').value)||0;
  const gst=parseFloat(document.getElementById('bt-gstAmount').value)||0;
  const showL2=l2&&l2.trim()&&l2!=='None';
  const showL3=l3&&l3.trim()&&l3!=='None';
  const showL4=l4&&l4.trim()&&l4!=='None';
  let html='<div class="alert alert-info" style="margin-bottom:16px">\u2139\ufe0f All fields are editable. Modify as needed, then click Save Voucher.</div>';
  html+='<div class="pm-section"><div class="pm-section-title">Bank & Payment</div><div class="pm-row">';
  html+='<div class="form-group"><label>Bank</label><input value="'+escHtml(currentBTBank)+'" readonly></div>';
  html+='<div class="form-group"><label>Payment Mode</label><input value="'+(btIssuesCheque?'Cheque':'Bank Debit/Credit')+'" readonly></div>';
  if(btIssuesCheque)html+='<div class="form-group"><label>Cheque No.</label><input value="'+document.getElementById('bt-chequeNumber').value+'" readonly></div>';
  html+='</div></div>';
  html+='<div class="pm-section"><div class="pm-section-title">Category</div><div class="pm-row">';
  html+='<div class="form-group"><label>Category L1</label><input id="pm-bt-l1" value="'+escHtml(l1)+'" readonly></div>';
  if(showL2)html+='<div class="form-group"><label>Category L2</label><input id="pm-bt-l2" value="'+escHtml(l2)+'"></div>';
  if(showL3)html+='<div class="form-group"><label>Category L3</label><input id="pm-bt-l3" value="'+escHtml(l3)+'"></div>';
  if(showL4)html+='<div class="form-group"><label>Category L4</label><input id="pm-bt-l4" value="'+escHtml(l4)+'"></div>';
  html+='</div></div>';
  html+='<div class="pm-section"><div class="pm-section-title">Amounts</div><div class="pm-row">';
  html+='<div class="form-group"><label>Reference Number</label><input id="pm-bt-ref" value="'+escHtml(document.getElementById('bt-referenceNumber').value)+'"></div>';
  html+='<div class="form-group"><label>Transaction Amount (\u20b9)</label><input id="pm-bt-txn" type="number" value="'+txn+'" onchange="recalcBTPMAmounts()"></div>';
  html+='<div class="form-group"><label>GST Amount (\u20b9)</label><input id="pm-bt-gst" type="number" value="'+gst+'" onchange="recalcBTPMAmounts()"></div>';
  html+='<div class="form-group"><label style="color:var(--primary);font-weight:700">Net Amount (\u20b9)</label><input id="pm-bt-net" value="'+(txn+gst)+'" readonly style="font-weight:700;color:var(--primary)"></div>';
  html+='<div class="form-group"><label>Description</label><input id="pm-bt-desc" value="'+escHtml(document.getElementById('bt-description').value)+'"></div>';
  html+='</div></div>';
  document.getElementById('previewVoucherBody').innerHTML=html;
}
function recalcPMAmounts(){
  const invEl=document.getElementById('pm-invamt');if(!invEl)return;
  const inv=parseFloat(invEl.value)||0;
  const vd=window._pmVendorData||currentVendorData;
  const tr=vd?vd.tdsRate:0,gr=window._pmCategoryGST!==undefined?window._pmCategoryGST:currentCategoryGST;
  const tds=Math.round(inv*tr/100),gst=Math.round(inv*gr/100);
  const tdsel=document.getElementById('pm-tds'),gsel=document.getElementById('pm-gst'),nsel=document.getElementById('pm-net');
  if(tdsel)tdsel.value=tds;if(gsel)gsel.value=gst;if(nsel)nsel.value=inv-tds+gst;
}
function recalcBTPMAmounts(){
  const txn=parseFloat(document.getElementById('pm-bt-txn').value)||0,gst=parseFloat(document.getElementById('pm-bt-gst').value)||0;
  document.getElementById('pm-bt-net').value=txn+gst;
}
function activatePreviewModify(){showSuccess('All fields are already editable. Make your changes and click Save Voucher.');}
function closePreviewModal(){document.getElementById('previewVoucherModal').classList.remove('active');}
function saveFromPreviewModal(){
  if(previewContext==='bt')saveFromBTPreview();else saveFromStandardPreview();
}
function saveFromStandardPreview(){
  const vt=document.querySelector('input[name="vendorType"]:checked').value;
  const invEl=document.getElementById('pm-invamt'),invnEl=document.getElementById('pm-invnum');
  if(!invEl||!invnEl){closePreviewModal();saveVoucher();return;}
  const inv=parseFloat(invEl.value)||0,invn=invnEl.value;
  if(inv<1){showError('Invoice amount must be at least \u20b91');return;}
  if(!invn||invn.length<3||!/[1-9]/.test(invn)){showError('Invoice number must contain at least one digit from 1 to 9');return;}
  // Build voucher directly from preview modal values
  const vnum=document.getElementById('pm-vnum').value;
  const vdate=document.getElementById('pm-date').value;
  const descEl=document.getElementById('pm-desc');const desc=descEl?descEl.value:'';
  let vendorName='',oneTimeName='',oneTimeContact='',oneTimeAddress='';
  let chequeBank='',chequeBook='',chequeNum='',chequeDate='',paymentMode='Cash';
  let l1='',l2='',l3='',l4='',gstRate=0,tdsRate=0;
  if(vt==='Registered'){
    const vendorSel=document.getElementById('pm-vendor');
    vendorName=vendorSel?vendorSel.value:document.getElementById('vendorSelect').value;
    const vd=MASTER_DATA.vendors[vendorName];tdsRate=vd?vd.tdsRate:0;
    chequeBank=(document.getElementById('pm-bank')||{}).value||'';
    const cbEl=document.getElementById('pm-chequebook');
    if(cbEl&&cbEl.value){const bk=JSON.parse(cbEl.value);chequeBook=bk.startNumber+'-'+bk.endNumber;}
    chequeNum=(document.getElementById('pm-chequenum')||{}).value||'';
    chequeDate=(document.getElementById('pm-chequedate')||{}).value||'';
    paymentMode='Cheque';
    const l1el=document.getElementById('pm-l1');l1=l1el?l1el.value:'';
    const l2el=document.getElementById('pm-l2');l2=l2el?l2el.value:'';
    const l3el=document.getElementById('pm-l3');l3=l3el?l3el.value:'';
    const l4el=document.getElementById('pm-l4');l4=l4el?l4el.value:'';
    const vd2=window._pmVendorData||MASTER_DATA.vendors[vendorName];
    gstRate=window._pmCategoryGST!==undefined?window._pmCategoryGST:currentCategoryGST;
  } else {
    const otEl=document.getElementById('pm-ot-name');oneTimeName=otEl?otEl.value:document.getElementById('oneTimeVendorName').value;
    oneTimeContact=document.getElementById('oneTimeVendorContact').value;
    oneTimeAddress=document.getElementById('oneTimeVendorAddress').value;
    paymentMode='Cash';
    const l1el=document.getElementById('pm-l1');l1=l1el?l1el.value:'';
    const l2el=document.getElementById('pm-l2');l2=l2el?l2el.value:'';
    const l3el=document.getElementById('pm-l3');l3=l3el?l3el.value:'';
    const l4el=document.getElementById('pm-l4');l4=l4el?l4el.value:'';
    gstRate=0;
  }
  const tds=Math.round(inv*tdsRate/100),gst=Math.round(inv*gstRate/100),net=inv-tds+gst;
  const voucher={id:'V'+Date.now(),voucherNumber:vnum,date:vdate,vendorType:vt,
    vendorName,oneTimeVendorName:oneTimeName,oneTimeContact,oneTimeAddress,
    paymentMode,chequeBank,chequeBook,chequeNumber:chequeNum,chequeDate,
    categoryL1:l1,categoryL2:l2,categoryL3:l3,categoryL4:l4,gstRate,
    invoiceAmount:inv,tdsAmount:tds,gstAmount:gst,netAmount:net,
    invoiceNumber:invn,description:desc,
    status:'Prepared',editCount:0,createdBy:CURRENT_USER,createdAt:new Date().toISOString()};
  vouchers.push(voucher);saveVouchers();showSuccess('\u2714\ufe0f Voucher '+vnum+' saved!');
  closePreviewModal();resetVoucherForm();generateVoucherNumber();renderVouchers();
}
function saveFromBTPreview(){
  const ref=document.getElementById('pm-bt-ref'),txn=document.getElementById('pm-bt-txn'),gst=document.getElementById('pm-bt-gst');
  if(ref)document.getElementById('bt-referenceNumber').value=ref.value;
  if(txn)document.getElementById('bt-transactionAmount').value=txn.value;
  if(gst)document.getElementById('bt-gstAmount').value=gst.value;
  const desc=document.getElementById('pm-bt-desc');if(desc)document.getElementById('bt-description').value=desc.value;
  const l2=document.getElementById('pm-bt-l2');if(l2)document.getElementById('bt-categoryL2').value=l2.value;
  const l3=document.getElementById('pm-bt-l3');if(l3){const el=document.getElementById('bt-categoryL3');if(el)el.value=l3.value;}
  const l4=document.getElementById('pm-bt-l4');if(l4){const el=document.getElementById('bt-categoryL4');if(el)el.value=l4.value;}
  calculateBTNet();closePreviewModal();saveBTVoucher();
}

// ── RENDER VOUCHERS ──
function renderVouchers(){
  const q=(document.getElementById('voucherSearch').value||'').toLowerCase();
  const tbody=document.getElementById('vouchersTableBody');
  const list=vouchers.filter(v=>{
    const vendor=v.vendorType==='Bank Transaction'?(v.bankName||''):(v.vendorName||v.oneTimeVendorName||'');
    return !q||vendor.toLowerCase().includes(q)||(v.categoryL1||'').toLowerCase().includes(q);
  }).sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(!list.length){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-mid)">No vouchers found</td></tr>';return;}
  tbody.innerHTML=list.map(v=>{
    const vendor=v.vendorType==='Bank Transaction'?(v.bankName||'Bank Txn'):(v.vendorName||v.oneTimeVendorName||'OT Vendor');
    const expHead=v.categoryL1||(v.vendorType==='Bank Transaction'?v.bankName:'-');
    const sb=v.status==='Cancelled'?'badge-danger':v.status==='Edited'?'badge-edited':v.status==='Viewed'?'badge-viewed':v.status==='Prepared'?'badge-prepared':'badge-success';
    const canEdit=v.status!=='Cancelled'&&(v.editCount||0)<1;
    return '<tr><td>'+v.date+'</td><td>'+v.voucherNumber+'</td><td>'+escHtml(vendor)+'</td><td>'+escHtml(expHead)+'</td><td>'+v.paymentMode+'</td><td>\u20b9'+v.netAmount.toLocaleString('en-IN')+'</td><td><span class="badge '+sb+'">'+v.status+'</span></td><td><div class="btn-group"><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="viewVoucher(\''+v.id+'\')">View</button>'+(canEdit?'<button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="editVoucherDirect(\''+v.id+'\')">Edit</button>':'')+(v.status!=='Cancelled'?'<button class="btn btn-danger" style="padding:6px 12px;font-size:12px" onclick="cancelVoucherDirect(\''+v.id+'\')">Cancel</button>':'')+'</div></td></tr>';
  }).join('');
}
function editVoucherDirect(id){
  const v=vouchers.find(x=>x.id===id);if(!v)return;
  currentViewVoucher=v;if(v.status==='Prepared'){v.status='Viewed';saveVouchers();}
  openEditModal();
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function viewVoucher(id){
  const v=vouchers.find(x=>x.id===id);if(!v)return;
  currentViewVoucher=v;if(v.status==='Prepared')v.status='Viewed';saveVouchers();
  const vendor=v.vendorType==='Bank Transaction'?v.bankName:(v.vendorName||v.oneTimeVendorName||'');
  let html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:14px">';
  html+=row('Date',v.date)+row('Voucher No.',v.voucherNumber)+row('Vendor / Bank',escHtml(vendor))+row('Vendor Type',v.vendorType);
  html+=row('Category L1',v.categoryL1)+(v.categoryL2?row('Category L2',v.categoryL2):'')+(v.categoryL3?row('Category L3',v.categoryL3):'')+(v.categoryL4?row('Category L4',v.categoryL4):'');
  html+=row('Payment Mode',v.paymentMode)+(v.chequeNumber?row('Cheque No.',v.chequeNumber):'')+(v.invoiceNumber?row('Invoice / Ref No.',v.invoiceNumber):'');
  if(v.vendorType==='Bank Transaction'){html+=row('Transaction Amount','\u20b9'+(v.transactionAmount||v.invoiceAmount||0).toLocaleString('en-IN'))+row('GST Amount','\u20b9'+(v.gstAmount||0).toLocaleString('en-IN'));}
  else{html+=row('Invoice Amount','\u20b9'+(v.invoiceAmount||0).toLocaleString('en-IN'))+row('TDS','\u20b9'+(v.tdsAmount||0).toLocaleString('en-IN'))+row('GST','\u20b9'+(v.gstAmount||0).toLocaleString('en-IN'));}
  html+=row('Net Amount','\u20b9'+v.netAmount.toLocaleString('en-IN'))+(v.description?row('Description',escHtml(v.description)):'')+row('Status',v.status);
  html+='</div>';
  document.getElementById('voucherDetailsContent').innerHTML=html;
  const editBtn=document.getElementById('editVoucherBtn');
  editBtn.style.display=v.status==='Cancelled'||v.editCount>=1?'none':'inline-block';
  document.getElementById('viewVoucherModal').classList.add('active');renderVouchers();
}
function row(l,v){return'<div><strong>'+l+':</strong></div><div>'+v+'</div>';}
function closeViewVoucherModal(){document.getElementById('viewVoucherModal').classList.remove('active');currentViewVoucher=null;}
function openEditModal(){
  if(!currentViewVoucher)return;const v=currentViewVoucher;
  let html='<div class="form-grid">';
  if(v.vendorType==='Bank Transaction'){
    html+='<div class="form-group"><label>Reference Number</label><input id="edit-invnum" value="'+escHtml(v.invoiceNumber||'')+'"></div>';
    html+='<div class="form-group"><label>Transaction Amount (\u20b9) &mdash; max 10% change</label><input id="edit-amount" type="number" value="'+(v.transactionAmount||v.invoiceAmount)+'"></div>';
    html+='<div class="form-group"><label>GST Amount (\u20b9)</label><input id="edit-gst" type="number" value="'+(v.gstAmount||0)+'"></div>';
  }else{
    html+='<div class="form-group"><label>Invoice Number</label><input id="edit-invnum" value="'+escHtml(v.invoiceNumber||'')+'"></div>';
    html+='<div class="form-group"><label>Invoice Amount (\u20b9) &mdash; max 10% change</label><input id="edit-amount" type="number" value="'+v.invoiceAmount+'"></div>';
  }
  html+='<div class="form-group"><label>Description</label><textarea id="edit-desc" rows="2">'+escHtml(v.description||'')+'</textarea></div>';
  html+='</div>';
  document.getElementById('editVoucherContent').innerHTML=html;
  document.getElementById('viewVoucherModal').classList.remove('active');
  document.getElementById('editVoucherModal').classList.add('active');
}
function closeEditModal(){document.getElementById('editVoucherModal').classList.remove('active');document.getElementById('viewVoucherModal').classList.add('active');}
function saveVoucherEdit(){
  if(!currentViewVoucher)return;const v=currentViewVoucher;
  const newAmt=parseFloat(document.getElementById('edit-amount').value)||0;
  const origAmt=v.invoiceAmount||v.transactionAmount||0;
  if(Math.abs(newAmt-origAmt)/origAmt>0.10){showError('Amount change exceeds 10% limit.');return;}
  v.invoiceNumber=document.getElementById('edit-invnum').value;v.description=document.getElementById('edit-desc').value;
  if(v.vendorType==='Bank Transaction'){v.transactionAmount=newAmt;v.invoiceAmount=newAmt;const g=parseFloat(document.getElementById('edit-gst').value)||0;v.gstAmount=g;v.netAmount=newAmt+g;}
  else{v.invoiceAmount=newAmt;const tr=v.tdsAmount/v.invoiceAmount*100||0;const gr=v.gstAmount/v.invoiceAmount*100||0;v.tdsAmount=Math.round(newAmt*tr/100);v.gstAmount=Math.round(newAmt*gr/100);v.netAmount=newAmt-v.tdsAmount+v.gstAmount;}
  v.status='Edited';v.editCount=(v.editCount||0)+1;v.editedBy=CURRENT_USER;v.editedAt=new Date().toISOString();
  saveVouchers();closeEditModal();document.getElementById('viewVoucherModal').classList.remove('active');
  showSuccess('Voucher updated successfully!');renderVouchers();
}
function openCancelModal(){
  if(!currentViewVoucher)return;
  document.getElementById('cancelVoucherContent').innerHTML='<div class="alert alert-danger">Cancel voucher <strong>'+currentViewVoucher.voucherNumber+'</strong>? This cannot be undone.</div>';
  currentCancelVoucherId=currentViewVoucher.id;
  document.getElementById('viewVoucherModal').classList.remove('active');document.getElementById('cancelVoucherModal').classList.add('active');
}
function closeCancelModal(){document.getElementById('cancelVoucherModal').classList.remove('active');document.getElementById('viewVoucherModal').classList.add('active');currentCancelVoucherId=null;}
function confirmCancelVoucher(){
  const r=document.getElementById('voucherCancelReason').value.trim();if(!r){showError('Enter cancellation reason');return;}
  const v=vouchers.find(x=>x.id===currentCancelVoucherId);if(!v)return;
  v.status='Cancelled';v.cancellationReason=r;v.cancelledBy=CURRENT_USER;v.cancelledAt=new Date().toISOString();
  saveVouchers();document.getElementById('cancelVoucherModal').classList.remove('active');
  document.getElementById('voucherCancelReason').value='';currentViewVoucher=null;currentCancelVoucherId=null;
  showSuccess('Voucher cancelled.');renderVouchers();
}
function cancelVoucherDirect(id){
  const v=vouchers.find(x=>x.id===id);if(!v||v.status==='Cancelled')return;
  currentViewVoucher=v;currentCancelVoucherId=id;
  document.getElementById('cancelVoucherContent').innerHTML='<div class="alert alert-danger">Cancel voucher <strong>'+v.voucherNumber+'</strong>?</div>';
  document.getElementById('cancelVoucherModal').classList.add('active');
}

// ── REPORTS ──
function generateDateWiseReport(){
  const from=document.getElementById('reportFromDate').value,to=document.getElementById('reportToDate').value;
  const list=vouchers.filter(v=>{if(v.status==='Cancelled')return false;const d=v.date;return(!from||d>=from)&&(!to||d<=to);}).sort((a,b)=>a.date.localeCompare(b.date));
  if(!list.length){document.getElementById('dateWiseReport').innerHTML='<p style="margin-top:12px;color:var(--text-mid)">No vouchers in range.</p>';return;}
  let html='<div class="table-container" style="margin-top:16px"><table><thead><tr><th>Date</th><th>Voucher</th><th>Vendor/Bank</th><th>Category</th><th>Amount</th></tr></thead><tbody>';
  list.forEach(v=>{const vn=v.vendorType==='Bank Transaction'?v.bankName:(v.vendorName||v.oneTimeVendorName||'');html+='<tr><td>'+v.date+'</td><td>'+v.voucherNumber+'</td><td>'+escHtml(vn)+'</td><td>'+v.categoryL1+'</td><td>\u20b9'+v.netAmount.toLocaleString('en-IN')+'</td></tr>';});
  const tot=list.reduce((s,v)=>s+v.netAmount,0);html+='<tr style="font-weight:700;background:var(--bg-input)"><td colspan="4">TOTAL</td><td>\u20b9'+tot.toLocaleString('en-IN')+'</td></tr>';
  html+='</tbody></table></div>';document.getElementById('dateWiseReport').innerHTML=html;
}
function generateCategoryReport(){
  const m={};vouchers.filter(v=>v.status!=='Cancelled').forEach(v=>{m[v.categoryL1]=(m[v.categoryL1]||0)+v.netAmount;});
  const keys=Object.keys(m);if(!keys.length){document.getElementById('categoryReport').innerHTML='<p style="margin-top:12px;color:var(--text-mid)">No data.</p>';return;}
  let html='<div class="table-container" style="margin-top:16px"><table><thead><tr><th>Category</th><th>Amount</th></tr></thead><tbody>';
  keys.sort((a,b)=>m[b]-m[a]).forEach(k=>{html+='<tr><td>'+k+'</td><td>\u20b9'+m[k].toLocaleString('en-IN')+'</td></tr>';});
  html+='</tbody></table></div>';document.getElementById('categoryReport').innerHTML=html;
}
function generateChequeUtilizationReport(){
  let html='<div class="table-container" style="margin-top:16px"><table><thead><tr><th>Bank</th><th>Cheque Book</th><th>Used</th><th>Cancelled</th><th>Available</th></tr></thead><tbody>';
  const cancelled=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]');
  MASTER_DATA.chequeBooks.forEach(bk=>{
    const bookKey=bk.startNumber+'-'+bk.endNumber,total=bk.totalLeaves;
    const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bookKey).length;
    const canc=cancelled.filter(c=>c.chequeBook===bookKey).length;
    const avail=total-used-canc;
    html+='<tr><td>'+bk.bankName+'</td><td>'+bk.startNumber+' - '+bk.endNumber+'</td><td>'+used+'/'+total+'</td><td>'+canc+'</td><td>'+avail+'</td></tr>';
  });
  html+='</tbody></table></div>';document.getElementById('chequeUtilizationReport').innerHTML=html;
}
function exportVouchersToExcel(){
  const rows=[['Date','Voucher No','Vendor/Bank','Type','Payment Mode','Invoice/Txn Amt','TDS','GST','Net Amount','Category L1','L2','L3','L4','Ref/Invoice No','Description','Status']];
  vouchers.forEach(v=>{const vn=v.vendorType==='Bank Transaction'?v.bankName:(v.vendorName||v.oneTimeVendorName||'');rows.push([v.date,v.voucherNumber,vn,v.vendorType,v.paymentMode,v.invoiceAmount||0,v.tdsAmount||0,v.gstAmount||0,v.netAmount||0,v.categoryL1,v.categoryL2||'',v.categoryL3||'',v.categoryL4||'',v.invoiceNumber||'',v.description||'',v.status]);});
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,\ufeff'+encodeURIComponent(csv);a.download='chsl_vouchers.csv';a.click();
}

// ── MASTER DATA ──
function populateMasterData(){populateBankMaster();populateChequeBookMaster();populateVendorMaster();}
function populateBankMaster(){
  const el=document.getElementById('bankMasterContent');if(!el)return;
  const rows=[];
  MASTER_DATA.banks.forEach(b=>{
    const vendorKey=b.name;const vd=MASTER_DATA.vendors[vendorKey];
    const cats=vd?vd.allowedPaths.map(p=>p.level1):[];
    const selfKey=b.name==='Bharat Cooperative Bank'?'Self -BCB Bank':'Self -FJKL Bank';
    const selfVd=MASTER_DATA.vendors[selfKey];
    if(selfVd)selfVd.allowedPaths.forEach(p=>{if(!cats.includes(p.level1))cats.push(p.level1);});
    cats.forEach(cat=>rows.push({bank:b.name,acct:b.accountNumber,cat}));
  });
  let html='<table><thead><tr><th>Bank Name</th><th>Account Number</th><th>Transaction Category (L1)</th></tr></thead><tbody>';
  rows.forEach(r=>{html+='<tr><td>'+r.bank+'</td><td>'+r.acct+'</td><td>'+r.cat+'</td></tr>';});
  html+='</tbody></table>';el.innerHTML=html;
}
function populateChequeBookMaster(){
  const el=document.getElementById('chequeBookMasterContent');if(!el)return;
  let html='<table><thead><tr><th>Bank</th><th>Start</th><th>End</th><th>Leaves</th><th>Used</th><th>Available</th></tr></thead><tbody>';
  const cancelled=JSON.parse(localStorage.getItem('cancelled_cheques_v221')||'[]');
  MASTER_DATA.chequeBooks.forEach(bk=>{
    const bookKey=bk.startNumber+'-'+bk.endNumber;
    const used=vouchers.filter(v=>v.paymentMode==='Cheque'&&v.chequeBook===bookKey).length;
    const canc=cancelled.filter(c=>c.chequeBook===bookKey).length;
    html+='<tr><td>'+bk.bankName+'</td><td>'+bk.startNumber+'</td><td>'+bk.endNumber+'</td><td>'+bk.totalLeaves+'</td><td>'+(used+canc)+'</td><td>'+(bk.totalLeaves-used-canc)+'</td></tr>';
  });
  html+='</tbody></table>';el.innerHTML=html;
}
function populateVendorMaster(){
  const el=document.getElementById('vendorMasterContent');if(!el)return;
  const vendorRows=[];const seen=new Set();
  Object.values(MASTER_DATA.vendors).filter(v=>!BANK_VENDOR_KEYS.includes(v.name)).sort((a,b)=>a.name.localeCompare(b.name)).forEach(vendor=>{
    vendor.allowedPaths.forEach(p=>{
      const key=vendor.name+'|'+p.level1+'|'+p.level2+'|'+p.gstRate;
      if(!seen.has(key)){seen.add(key);vendorRows.push({vendorName:vendor.name,l1:p.level1,l2:p.level2,gst:p.gstRate});}
    });
  });
  let html='<table><thead><tr><th>Vendor Name</th><th>Major Expense Category (L1)</th><th>Minor Expense Category (L2)</th><th>GST Rate (%)</th></tr></thead><tbody>';
  let lastVendor='';
  vendorRows.forEach(r=>{
    const fmt=v=>v==='None'?'-':v==='User Entry'?'<em>(free text)</em>':escHtml(v);
    html+='<tr><td>'+(r.vendorName!==lastVendor?escHtml(r.vendorName):'')+'</td><td>'+r.l1+'</td><td>'+fmt(r.l2)+'</td><td>'+r.gst+'%</td></tr>';
    lastVendor=r.vendorName;
  });
  html+='</tbody></table>';el.innerHTML=html;
}

// ── CATEGORY MASTER VIEWS ──
function showCategoryView(viewType){
  const el=document.getElementById('categoryMasterContent');if(!el)return;
  if(viewType==='table')renderCategoryTable(el);
  else if(viewType==='tree')renderCategoryTree(el);
  else if(viewType==='grouped')renderCategoryGrouped(el);
}
function renderCategoryTable(el){
  const paths=[];Object.values(MASTER_DATA.vendors).filter(v=>!BANK_VENDOR_KEYS.includes(v.name)).forEach(v=>paths.push(...v.allowedPaths));
  const unique=[],seen=new Set();
  paths.forEach(p=>{const k=p.level1+'|'+p.level2+'|'+p.level3+'|'+p.level4+'|'+p.gstRate;if(!seen.has(k)){seen.add(k);unique.push(p);}});
  unique.sort((a,b)=>(a.level1+a.level2).localeCompare(b.level1+b.level2));
  let html='<table><thead><tr><th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>GST%</th></tr></thead><tbody>';
  unique.forEach(p=>{html+='<tr><td>'+p.level1+'</td><td>'+(p.level2==='None'?'-':p.level2==='User Entry'?'<em>User Entry</em>':p.level2)+'</td><td>'+(p.level3==='None'?'-':p.level3==='User Entry'?'<em>User Entry</em>':p.level3)+'</td><td>'+(p.level4==='None'?'-':p.level4==='User Entry'?'<em>User Entry</em>':p.level4)+'</td><td>'+p.gstRate+'%</td></tr>';});
  html+='</tbody></table>';el.innerHTML=html;
}
function renderCategoryTree(el){
  const paths=[];Object.values(MASTER_DATA.vendors).filter(v=>!BANK_VENDOR_KEYS.includes(v.name)).forEach(v=>paths.push(...v.allowedPaths));
  const tree={};paths.forEach(p=>{
    if(!tree[p.level1])tree[p.level1]={};
    const l2=p.level2==='None'?null:p.level2;if(!l2)return;
    if(!tree[p.level1][l2])tree[p.level1][l2]={};
    const l3=p.level3==='None'?null:p.level3;if(!l3)return;
    if(!tree[p.level1][l2][l3])tree[p.level1][l2][l3]=[];
    const l4=p.level4==='None'?null:p.level4;if(l4&&!tree[p.level1][l2][l3].includes(l4))tree[p.level1][l2][l3].push(l4);
  });
  let html='';let nodeId=0;
  Object.keys(tree).sort().forEach(l1=>{
    const id='tl1_'+(nodeId++);
    html+='<div class="tree-node-l1" onclick="toggleTreeNode(\''+id+'\')"><span id="'+id+'_arr">&#9654;</span> '+escHtml(l1)+'</div>';
    html+='<div class="tree-children" id="'+id+'">';
    const l2s=tree[l1];
    if(!Object.keys(l2s).length){html+='<div class="tree-node-l3"><em class="user-entry-note">(free text field)</em></div>';}
    else{Object.keys(l2s).sort().forEach(l2=>{
      const l2id='tl2_'+(nodeId++);const isUE=l2==='User Entry';
      html+='<div class="tree-node-l2" onclick="toggleTreeNode(\''+l2id+'\')">';
      if(!isUE)html+='<span id="'+l2id+'_arr">&#9654;</span> ';
      html+=isUE?'<em class="user-entry-note">User Entry (free text field)</em>':escHtml(l2);
      html+='</div>';
      if(!isUE){html+='<div class="tree-children" id="'+l2id+'">';
        const l3s=l2s[l2];
        if(!Object.keys(l3s).length){html+='<div class="tree-node-l3"><em class="user-entry-note">(free text field)</em></div>';}
        else{Object.keys(l3s).sort().forEach(l3=>{const isUE3=l3==='User Entry';
          html+='<div class="tree-node-l3">'+(isUE3?'<em class="user-entry-note">User Entry (free text field)</em>':escHtml(l3))+'</div>';
          if(!isUE3&&l3s[l3].length){l3s[l3].forEach(l4=>{html+='<div class="tree-node-l4">'+(l4==='User Entry'?'<em class="user-entry-note">User Entry (free text field)</em>':escHtml(l4))+'</div>';});}
        });}
        html+='</div>';}
    });}
    html+='</div>';
  });
  el.innerHTML=html;
}
function toggleTreeNode(id){
  const el=document.getElementById(id);if(!el)return;
  el.classList.toggle('open');const arr=document.getElementById(id+'_arr');
  if(arr)arr.innerHTML=el.classList.contains('open')?'&#9660;':'&#9654;';
}
function renderCategoryGrouped(el){
  const paths=[];Object.values(MASTER_DATA.vendors).filter(v=>!BANK_VENDOR_KEYS.includes(v.name)).forEach(v=>paths.push(...v.allowedPaths));
  const grouped={};paths.forEach(p=>{if(!grouped[p.level1])grouped[p.level1]=[];const k=p.level2+'|'+p.level3+'|'+p.level4+'|'+p.gstRate;if(!grouped[p.level1].find(x=>x.k===k))grouped[p.level1].push({k,l2:p.level2,l3:p.level3,l4:p.level4,gst:p.gstRate});});
  let html='';let gid=0;
  Object.keys(grouped).sort().forEach(l1=>{
    const paths=grouped[l1];const id='grp_'+(gid++);
    html+='<div class="collapsible-section"><div class="collapsible-header" onclick="toggleGrouped(\''+id+'\')" id="'+id+'_hdr"><span>'+escHtml(l1)+' <small style="opacity:.7">('+paths.length+' paths)</small></span><span id="'+id+'_arr">&#9660;</span></div>';
    html+='<div class="collapsible-content" id="'+id+'"><table><thead><tr><th>L2</th><th>L3</th><th>L4</th><th>GST%</th></tr></thead><tbody>';
    paths.forEach(p=>{
      const fmt=v=>v==='None'?'-':v==='User Entry'?'<em>User Entry</em>':escHtml(v);
      html+='<tr><td>'+fmt(p.l2)+'</td><td>'+fmt(p.l3)+'</td><td>'+fmt(p.l4)+'</td><td>'+p.gst+'%</td></tr>';
    });
    html+='</tbody></table></div></div>';
  });
  el.innerHTML=html;
}
function toggleGrouped(id){
  const el=document.getElementById(id);if(!el)return;el.classList.toggle('active');
  const arr=document.getElementById(id+'_arr');if(arr)arr.innerHTML=el.classList.contains('active')?'&#9650;':'&#9660;';
}
function toggleSection(header){
  const content=header.nextElementSibling;const arrow=header.querySelector('span:last-child');
  content.classList.toggle('active');arrow.innerHTML=content.classList.contains('active')?'&#9650;':'&#9660;';
  if(content.classList.contains('active')){
    const id=content.id;
    if(id==='bankMasterContent')populateBankMaster();
    else if(id==='chequeBookMasterContent')populateChequeBookMaster();
    else if(id==='vendorMasterContent')populateVendorMaster();
  }
}

// ── CONFIRM / TOAST ──
function showWarningModal(title,msg,cb){
  document.getElementById('confirmModalTitle').textContent=title;document.getElementById('confirmModalMessage').textContent=msg;
  confirmCallback=cb;document.getElementById('confirmModal').classList.add('active');
}
function closeConfirmModal(ok){
  document.getElementById('confirmModal').classList.remove('active');if(ok&&confirmCallback)confirmCallback();confirmCallback=null;
}
function closeChequeDetailModal(){document.getElementById('chequeDetailModal').classList.remove('active');}
function showError(msg){const t=document.createElement('div');t.className='toast';t.style.background='var(--danger)';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),4000);}
function showSuccess(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000);}

// Legacy categories for one-time (build from vendor master)
MASTER_DATA.categoryTree={level1:[...new Set(Object.values(MASTER_DATA.vendors).filter(v=>!BANK_VENDOR_KEYS.includes(v.name)).flatMap(v=>v.allowedPaths.map(p=>p.level1)))]};

</script>
</body>
</html>
